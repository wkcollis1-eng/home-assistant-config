# ========================================================
# ROBUSTNESS AUTOMATIONS
# Add to automations.yaml
# ========================================================

# --------------------------------------------------------
# WATCHDOG: HDD Capture Health Monitor
# Alerts if daily capture hasn't succeeded in 26+ hours
# --------------------------------------------------------
- id: notify_hdd_capture_stale
  alias: "Notify HDD Capture Stale"
  description: "Alert if HDD capture hasn't succeeded recently"
  trigger:
    - platform: state
      entity_id: binary_sensor.hdd_capture_stale
      to: "on"
      for:
        hours: 2
  action:
    - service: persistent_notification.create
      data:
        title: "⚠️ HDD Capture Health Alert"
        message: >
          HDD capture has not succeeded in over 26 hours.
          Last successful: {{ states('input_datetime.hdd_capture_last_ok') }}
          
          Check:
          - sensor.hvac_hdd65_today state: {{ states('sensor.hvac_hdd65_today') }}
          - sensor.hvac_cdd65_today state: {{ states('sensor.hvac_cdd65_today') }}
          - sensor.hvac_outdoor_temp_hartford_proxy state: {{ states('sensor.hvac_outdoor_temp_hartford_proxy') }}

# --------------------------------------------------------
# WATCHDOG: Runtime per HDD Capture Health Monitor
# --------------------------------------------------------
- id: notify_runtime_per_hdd_capture_stale
  alias: "Notify Runtime/HDD Capture Stale"
  description: "Alert if runtime/HDD capture hasn't succeeded recently"
  trigger:
    - platform: state
      entity_id: binary_sensor.runtime_per_hdd_capture_stale
      to: "on"
      for:
        hours: 2
  action:
    - service: persistent_notification.create
      data:
        title: "⚠️ Runtime/HDD Capture Alert"
        message: >
          Runtime per HDD capture has not succeeded in over 26 hours.
          Last successful: {{ states('input_datetime.runtime_per_hdd_capture_last_ok') }}
          
          Check:
          - sensor.hvac_total_runtime_per_hdd_today: {{ states('sensor.hvac_total_runtime_per_hdd_today') }}

# --------------------------------------------------------
# STARTUP VALIDATION: Check for corrupt cumulative values
# --------------------------------------------------------
- id: validate_input_numbers_startup
  alias: "Validate Input Numbers on Startup"
  description: "Check for implausible values in cumulative trackers"
  trigger:
    - platform: homeassistant
      event: start
  action:
    - delay:
        seconds: 60
    - choose:
        # Check for corrupt HDD cumulative values
        - conditions:
            - condition: template
              value_template: >
                {{ states('input_number.hdd_cumulative_year_auto') | float(0) > 8000 or
                   states('input_number.hdd_cumulative_month_auto') | float(0) > 2500 or
                   states('input_number.hdd_cumulative_year_auto') | float(0) < 0 or
                   states('input_number.hdd_cumulative_month_auto') | float(0) < 0 }}
          sequence:
            - service: system_log.write
              data:
                message: >
                  WARNING: HDD cumulative values appear corrupt.
                  Year: {{ states('input_number.hdd_cumulative_year_auto') }},
                  Month: {{ states('input_number.hdd_cumulative_month_auto') }}
                level: warning
            - service: persistent_notification.create
              data:
                title: "⚠️ HDD Data Validation Warning"
                message: >
                  HDD cumulative values may be corrupt:
                  - Year-to-date: {{ states('input_number.hdd_cumulative_year_auto') }} HDD
                  - Month-to-date: {{ states('input_number.hdd_cumulative_month_auto') }} HDD
                  
                  Please verify and manually correct if needed.
                  Reasonable values: Year < 8000, Month < 2500
    - choose:
        # Check for corrupt filter runtime
        - conditions:
            - condition: template
              value_template: >
                {{ states('input_number.hvac_filter_runtime_hours') | float(0) > 2000 or
                   states('input_number.hvac_filter_runtime_hours') | float(0) < 0 }}
          sequence:
            - service: system_log.write
              data:
                message: >
                  WARNING: Filter runtime appears corrupt: {{ states('input_number.hvac_filter_runtime_hours') }} hours
                level: warning
            - service: persistent_notification.create
              data:
                title: "⚠️ Filter Runtime Warning"
                message: >
                  Filter runtime value appears corrupt: {{ states('input_number.hvac_filter_runtime_hours') }} hours
                  Expected range: 0-1500 hours
    - choose:
        # Check outdoor temp trackers initialization
        - conditions:
            - condition: template
              value_template: >
                {{ states('input_number.outdoor_temp_daily_high') | float(0) <= -49 and
                   states('input_number.outdoor_temp_daily_low') | float(150) >= 149 }}
          sequence:
            - service: system_log.write
              data:
                message: "INFO: Outdoor temp daily high/low at initial values - will auto-correct when sensor available"
                level: info

# --------------------------------------------------------
# CLIMATE NORMS SCRIPT FAILURE HANDLER
# --------------------------------------------------------
- id: notify_climate_norms_failure
  alias: "Notify Climate Norms Script Failure"
  description: "Alert if climate norms script returns error"
  trigger:
    - platform: state
      entity_id: sensor.climate_norms_today
      to: "error"
      for:
        hours: 2
  action:
    - service: persistent_notification.create
      data:
        title: "⚠️ Climate Norms Script Error"
        message: >
          The climate_norms_today.py script has been returning errors for 2+ hours.
          
          Check:
          - /config/scripts/climate_norms_today.py exists
          - /config/climate_daily_norms.csv exists
          - Python dependencies are installed
          
          You can test manually with:
          python3 /config/scripts/climate_norms_today.py

# --------------------------------------------------------
# WEATHER SOURCE FAILOVER MONITOR
# Alert if all weather sources are down
# --------------------------------------------------------
- id: notify_weather_sources_down
  alias: "Notify All Weather Sources Down"
  description: "Alert if all weather data sources are unavailable"
  trigger:
    - platform: state
      entity_id: sensor.hvac_outdoor_weather_source
      to: "Open-Meteo"
      for:
        hours: 6
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: >
                {{ states('sensor.hvac_outdoor_temp_hartford_proxy') | float(-999) == 35 }}
          sequence:
            - service: persistent_notification.create
              data:
                title: "⚠️ Weather Data Warning"
                message: >
                  All primary weather sources may be down.
                  Current source: {{ states('sensor.hvac_outdoor_weather_source') }}
                  
                  Using fallback value of 35°F which may affect HDD calculations.
                  
                  Check integrations:
                  - weather.pirateweather
                  - weather.local_weather_2
                  - sensor.outdoor_temp_live (Open-Meteo REST)

# --------------------------------------------------------
# SETBACK ACTIVE TIMEOUT
# Clear stale setback latch after 18 hours (prevents stuck state)
# --------------------------------------------------------
- id: clear_stale_setback_latch_1f
  alias: "Clear Stale 1F Setback Latch"
  description: "Reset setback active if stuck for >18 hours"
  trigger:
    - platform: state
      entity_id: input_boolean.hvac_1f_setback_active
      to: "on"
      for:
        hours: 18
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.hvac_1f_setback_active
    - service: system_log.write
      data:
        message: "Cleared stale 1F setback latch after 18-hour timeout"
        level: warning

- id: clear_stale_setback_latch_2f
  alias: "Clear Stale 2F Setback Latch"
  description: "Reset setback active if stuck for >18 hours"
  trigger:
    - platform: state
      entity_id: input_boolean.hvac_2f_setback_active
      to: "on"
      for:
        hours: 18
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.hvac_2f_setback_active
    - service: system_log.write
      data:
        message: "Cleared stale 2F setback latch after 18-hour timeout"
        level: warning

# --------------------------------------------------------
# DATABASE SIZE MONITOR
# Warn if database grows too large (indicates recording issue)
# --------------------------------------------------------
- id: database_size_monitor
  alias: "Database Size Monitor"
  description: "Alert if database exceeds 500MB"
  trigger:
    - platform: time
      at: "05:00:00"
  condition:
    - condition: time
      weekday:
        - mon
  action:
    - service: system_log.write
      data:
        message: >
          Weekly database check: home-assistant_v2.db size monitoring.
          If HA is sluggish, consider running manual VACUUM via SSH.
        level: info
