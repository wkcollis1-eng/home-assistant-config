# ===============================================================
# COMPLETE CONFIGURATION.YAML - ENERGY PERFORMANCE TRACKING
# ===============================================================
# Version: Final with Auto HDD + Live Weather (10 min updates)
#
# INSTRUCTIONS:
# 1. Backup your current configuration.yaml
# 2. Replace ENTIRE contents with this file
# 3. Full restart required (Settings > System > Restart)
# ===============================================================

default_config:

# Shell commands for CSV reports
shell_command:
  testcmd: "echo hello"
  appenddailycsv: 'bash -c "echo \"{{ now().strftime(''%Y-%m-%d'') }},{{ states(''sensor.pirate_weather_today_high'') | float(0) | round(1) }},{{ states(''sensor.pirate_weather_today_low'') | float(0) | round(1) }},{{ ((states(''sensor.pirate_weather_today_high'') | float(0) + states(''sensor.pirate_weather_today_low'') | float(0)) / 2) | round(1) }},{{ states(''sensor.hvac_hdd65_today'') | float(0) | round(1) }},{{ (states(''sensor.hvac_furnace_runtime_today'') | float(0) * 60) | round(1) }},{{ states(''sensor.hvac_furnace_cycles_today'') | int(0) }},{{ states(''sensor.hvac_furnace_min_per_cycle'') | float(0) | round(1) }},{{ states(''sensor.hvac_total_cycles_today'') | int(0) }},{{ states(''sensor.hvac_chaining_index'') | float(1) | round(2) }},{{ (states(''sensor.hvac_1f_heat_runtime_today'') | float(0) * 60) | round(1) }},{{ (states(''sensor.hvac_2f_heat_runtime_today'') | float(0) * 60) | round(1) }},{{ states(''sensor.basement_dew_point'') | float(0) | round(1) }}\" >> /config/reports/hvac_daily_{{ now().year }}.csv"'
  appendmonthlycsv: 'bash -c "echo \"{{ now().strftime(''%Y-%m'') }},{{ states(''input_number.outdoor_temp_days_month'') | int(0) }},{{ states(''sensor.outdoor_temp_mean_month'') | float(0) | round(1) }},{{ states(''input_number.hdd_cumulative_month_auto'') | float(0) | round(1) }},{{ states(''sensor.hvac_total_heat_runtime_month'') | float(0) | round(1) }},{{ states(''sensor.runtime_per_hdd_month_calc'') | float(0) | round(1) }},{{ states(''sensor.hvac_heating_efficiency_mtd'') | float(0) | round(1) }},{{ states(''sensor.hvac_total_heat_runtime_month'') | float(0) | round(1) }},{{ states(''sensor.expected_runtime_month'') | float(0) | round(1) }},{{ states(''sensor.efficiency_deviation_month'') | float(0) | round(1) }},{{ states(''input_number.gas_bill_ccf'') | float(0) | round(0) }},{{ states(''input_number.gas_bill_amount'') | float(0) | round(2) }},{{ states(''input_number.electricity_bill_kwh'') | float(0) | round(0) }}\" >> /config/reports/hvac_monthly.csv"'
  rotatedailycsv: 'bash -c "head -1 /config/reports/hvac_daily_{{ now().year - 1 }}.csv > /config/reports/hvac_daily_{{ now().year }}.csv"'

frontend:
  themes: !include_dir_merge_named themes

# ===============================================================
# RECORDER - Database optimization
# ===============================================================
recorder:
  purge_keep_days: 14
  commit_interval: 2
  exclude:
    entities:
      - sensor.time
      - sensor.date
    entity_globs:
      - sensor.*_signal_level

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

# ===============================================================
# LIVE WEATHER (Updates every 10 minutes)
# ===============================================================
rest:
  - resource: "https://api.open-meteo.com/v1/forecast?latitude=41.28&longitude=-72.81&current=temperature_2m&temperature_unit=fahrenheit"
    scan_interval: 600
    sensor:
      - name: "Outdoor Temp Live"
        unique_id: outdoor_temp_live
        value_template: "{{ value_json.current.temperature_2m }}"
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement

# ===============================================================
# PIRATE WEATHER INTEGRATION SENSORS
# ===============================================================
# Note: Requires HACS Pirate Weather integration installed
# The integration creates weather.pirateweather entity automatically

# ===============================================================
# INPUT BUTTONS
# ===============================================================
input_button:
  save_electric_bill:
    name: "Save Electric Bill"
    icon: mdi:content-save-check

  save_gas_bill:
    name: "Save Gas Bill"
    icon: mdi:content-save-check

  reset_filter_runtime:
    name: "Reset Filter Runtime"
    icon: mdi:air-filter

# ===============================================================
# INPUT NUMBER HELPERS
# ===============================================================
input_number:
  # === SYSTEM CONSTANTS ===
  furnace_heating_rate_btu_hr:
    name: Furnace Heating Rate (BTU/hr)
    min: 50000
    max: 100000
    step: 1
    unit_of_measurement: "BTU/hr"
    mode: box
    icon: mdi:fire
    initial: 60556

  building_ua_baseline:
    name: Building UA Baseline
    min: 300
    max: 600
    step: 1
    unit_of_measurement: "BTU/hr-°F"
    mode: box
    icon: mdi:home-thermometer
    initial: 449

  balance_point_baseline:
    name: Balance Point Baseline
    min: 50
    max: 70
    step: 0.5
    unit_of_measurement: "°F"
    mode: box
    icon: mdi:thermometer-lines
    initial: 59

  heating_efficiency_baseline:
    name: Heating Efficiency Baseline (CCF/1k HDD)
    min: 50
    max: 150
    step: 0.1
    unit_of_measurement: "CCF/1k HDD"
    mode: box
    icon: mdi:chart-bell-curve
    initial: 82.6

  annual_hdd_baseline:
    name: Annual HDD Baseline
    min: 4000
    max: 8000
    step: 1
    unit_of_measurement: "HDD"
    mode: box
    icon: mdi:snowflake
    initial: 6270

  annual_electricity_baseline:
    name: Annual Electricity Baseline (kWh)
    min: 4000
    max: 12000
    step: 1
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:flash
    initial: 6730

  annual_gas_baseline:
    name: Annual Gas Baseline (CCF)
    min: 400
    max: 1200
    step: 1
    unit_of_measurement: "CCF"
    mode: box
    icon: mdi:fire
    initial: 787

  site_eui_baseline:
    name: Site EUI Baseline
    min: 30
    max: 70
    step: 0.1
    unit_of_measurement: "kBTU/ft²-yr"
    mode: box
    icon: mdi:home-analytics
    initial: 41.7

  # === CURRENT MONTH BILLS ===
  electricity_bill_amount:
    name: "Electricity Bill Amount"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "$"
    mode: box
    icon: mdi:currency-usd

  electricity_bill_kwh:
    name: "Electricity Bill kWh"
    min: 0
    max: 10000
    step: 1
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:lightning-bolt

  electricity_bill_days:
    name: "Electricity Bill Days"
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    mode: box
    icon: mdi:calendar-range

  gas_bill_amount:
    name: "Gas Bill Amount"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "$"
    mode: box
    icon: mdi:currency-usd

  gas_bill_ccf:
    name: "Gas Bill CCF"
    min: 0
    max: 5000
    step: 1
    unit_of_measurement: "CCF"
    mode: box
    icon: mdi:fire

  gas_bill_days:
    name: "Gas Bill Days"
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    mode: box
    icon: mdi:calendar-range

  # === PREVIOUS MONTH ===
  electricity_bill_amount_previous:
    name: "Previous Month Electricity Amount"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "$"
    mode: box

  electricity_bill_kwh_previous:
    name: "Previous Month Electricity kWh"
    min: 0
    max: 10000
    step: 1
    unit_of_measurement: "kWh"
    mode: box

  electricity_bill_days_previous:
    name: "Previous Month Electricity Days"
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    mode: box
    initial: 30

  gas_bill_amount_previous:
    name: "Previous Month Gas Amount"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "$"
    mode: box

  gas_bill_ccf_previous:
    name: "Previous Month Gas CCF"
    min: 0
    max: 5000
    step: 1
    unit_of_measurement: "CCF"
    mode: box

  gas_bill_days_previous:
    name: "Previous Month Gas Days"
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    mode: box
    initial: 30

  # === LAST YEAR SAME MONTH ===
  electricity_bill_amount_last_year:
    name: "Last Year Electricity Amount"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "$"
    mode: box

  electricity_bill_kwh_last_year:
    name: "Last Year Electricity kWh"
    min: 0
    max: 10000
    step: 1
    unit_of_measurement: "kWh"
    mode: box

  electricity_bill_days_last_year:
    name: "Last Year Electricity Days"
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    mode: box
    initial: 30

  gas_bill_amount_last_year:
    name: "Last Year Gas Amount"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "$"
    mode: box

  gas_bill_ccf_last_year:
    name: "Last Year Gas CCF"
    min: 0
    max: 5000
    step: 1
    unit_of_measurement: "CCF"
    mode: box

  gas_bill_days_last_year:
    name: "Last Year Gas Days"
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    mode: box
    initial: 30

  # === 7-DAY ROLLING (Manual backup) ===
  runtime_1f_rolling_7day:
    name: "1F Runtime Rolling 7-Day"
    min: 0
    max: 100
    step: 0.1
    unit_of_measurement: "hours"
    mode: box
    icon: mdi:clock-outline

  runtime_2f_rolling_7day:
    name: "2F Runtime Rolling 7-Day"
    min: 0
    max: 100
    step: 0.1
    unit_of_measurement: "hours"
    mode: box
    icon: mdi:clock-outline

  # ===============================================================
  # AUTO HDD TRACKING - 7-Day Rolling Window
  # ===============================================================
  hdd_day_1:
    name: "HDD Day 1 (Today)"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_2:
    name: "HDD Day 2"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_3:
    name: "HDD Day 3"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_4:
    name: "HDD Day 4"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_5:
    name: "HDD Day 5"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_6:
    name: "HDD Day 6"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_7:
    name: "HDD Day 7 (Oldest)"
    min: 0
    max: 70
    step: 0.1
    mode: box

  # === RUNTIME PER HDD DAILY STORAGE (for std dev calculation) ===
  runtime_per_hdd_day_1:
    name: "Runtime/HDD Day 1 (Yesterday)"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_2:
    name: "Runtime/HDD Day 2"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_3:
    name: "Runtime/HDD Day 3"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_4:
    name: "Runtime/HDD Day 4"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_5:
    name: "Runtime/HDD Day 5"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_6:
    name: "Runtime/HDD Day 6"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_7:
    name: "Runtime/HDD Day 7 (Oldest)"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"

  hdd_cumulative_month_auto:
    name: "HDD Cumulative Month (Auto)"
    min: 0
    max: 2000
    step: 0.1
    mode: box
    icon: mdi:snowflake-thermometer

  hdd_cumulative_year_auto:
    name: "HDD Cumulative Year (Auto)"
    min: 0
    max: 10000
    step: 0.1
    mode: box
    icon: mdi:snowflake-thermometer

  cdd_cumulative_month_auto:
    name: "CDD Cumulative Month (Auto)"
    min: 0
    max: 1000
    step: 0.1
    mode: box
    icon: mdi:sun-thermometer

  cdd_cumulative_year_auto:
    name: "CDD Cumulative Year (Auto)"
    min: 0
    max: 3000
    step: 0.1
    mode: box
    icon: mdi:sun-thermometer

  # ===============================================================
  # MONTHLY REPORT TRACKING
  # ===============================================================
  outdoor_temp_sum_month:
    name: "Outdoor Temp Sum Month"
    min: -5000
    max: 5000
    step: 0.1
    mode: box
    icon: mdi:thermometer

  outdoor_temp_days_month:
    name: "Outdoor Temp Days Month"
    min: 0
    max: 31
    step: 1
    mode: box
    icon: mdi:calendar-range

  expected_runtime_sum_month:
    name: "Expected Runtime Sum Month"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "h"
    mode: box
    icon: mdi:timer-outline

  # ===============================================================
  # 12-MONTH ARCHIVE - ELECTRIC
  # ===============================================================
  electric_archive_jan_amount:
    name: "Archive: Jan Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_feb_amount:
    name: "Archive: Feb Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_mar_amount:
    name: "Archive: Mar Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_apr_amount:
    name: "Archive: Apr Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_may_amount:
    name: "Archive: May Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_jun_amount:
    name: "Archive: Jun Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_jul_amount:
    name: "Archive: Jul Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_aug_amount:
    name: "Archive: Aug Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_sep_amount:
    name: "Archive: Sep Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_oct_amount:
    name: "Archive: Oct Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_nov_amount:
    name: "Archive: Nov Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_dec_amount:
    name: "Archive: Dec Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box

  electric_archive_jan_kwh:
    name: "Archive: Jan Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_feb_kwh:
    name: "Archive: Feb Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_mar_kwh:
    name: "Archive: Mar Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_apr_kwh:
    name: "Archive: Apr Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_may_kwh:
    name: "Archive: May Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_jun_kwh:
    name: "Archive: Jun Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_jul_kwh:
    name: "Archive: Jul Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_aug_kwh:
    name: "Archive: Aug Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_sep_kwh:
    name: "Archive: Sep Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_oct_kwh:
    name: "Archive: Oct Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_nov_kwh:
    name: "Archive: Nov Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_dec_kwh:
    name: "Archive: Dec Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box

  # ===============================================================
  # 12-MONTH ARCHIVE - GAS
  # ===============================================================
  gas_archive_jan_amount:
    name: "Archive: Jan Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_feb_amount:
    name: "Archive: Feb Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_mar_amount:
    name: "Archive: Mar Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_apr_amount:
    name: "Archive: Apr Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_may_amount:
    name: "Archive: May Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_jun_amount:
    name: "Archive: Jun Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_jul_amount:
    name: "Archive: Jul Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_aug_amount:
    name: "Archive: Aug Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_sep_amount:
    name: "Archive: Sep Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_oct_amount:
    name: "Archive: Oct Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_nov_amount:
    name: "Archive: Nov Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_dec_amount:
    name: "Archive: Dec Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box

  gas_archive_jan_ccf:
    name: "Archive: Jan Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_feb_ccf:
    name: "Archive: Feb Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_mar_ccf:
    name: "Archive: Mar Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_apr_ccf:
    name: "Archive: Apr Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_may_ccf:
    name: "Archive: May Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_jun_ccf:
    name: "Archive: Jun Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_jul_ccf:
    name: "Archive: Jul Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_aug_ccf:
    name: "Archive: Aug Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_sep_ccf:
    name: "Archive: Sep Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_oct_ccf:
    name: "Archive: Oct Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_nov_ccf:
    name: "Archive: Nov Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_dec_ccf:
    name: "Archive: Dec Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box

  # ===============================================================
  # FILTER TRACKING
  # ===============================================================
  hvac_filter_runtime_hours:
    name: "Filter Runtime Hours"
    min: 0
    max: 2000
    step: 0.01
    unit_of_measurement: "hours"
    mode: box
    icon: mdi:air-filter

  hvac_1f_last_recovery_minutes:
    name: "1F Last Recovery Time"
    min: 0
    max: 180
    step: 1
    unit_of_measurement: "min"
    mode: box
    icon: mdi:clock-end

  hvac_2f_last_recovery_minutes:
    name: "2F Last Recovery Time"
    min: 0
    max: 180
    step: 1
    unit_of_measurement: "min"
    mode: box
    icon: mdi:clock-end

  # ===============================================================
  # RECOVERY RATE TRACKING - 1F (Rolling 7 recoveries)
  # ===============================================================
  hvac_1f_recovery_rate_1:
    name: "1F Recovery Rate Slot 1"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_1f_recovery_rate_2:
    name: "1F Recovery Rate Slot 2"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_1f_recovery_rate_3:
    name: "1F Recovery Rate Slot 3"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_1f_recovery_rate_4:
    name: "1F Recovery Rate Slot 4"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_1f_recovery_rate_5:
    name: "1F Recovery Rate Slot 5"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_1f_recovery_rate_6:
    name: "1F Recovery Rate Slot 6"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_1f_recovery_rate_7:
    name: "1F Recovery Rate Slot 7"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_1f_recovery_setback_degrees:
    name: "1F Recovery Setback Degrees"
    min: 0
    max: 15
    step: 0.1
    unit_of_measurement: "°F"
    mode: box
  hvac_1f_recovery_outdoor_temp:
    name: "1F Recovery Outdoor Temp"
    min: -20
    max: 100
    step: 0.1
    unit_of_measurement: "°F"
    mode: box

  # ===============================================================
  # RECOVERY RATE TRACKING - 2F (Rolling 7 recoveries)
  # ===============================================================
  hvac_2f_recovery_rate_1:
    name: "2F Recovery Rate Slot 1"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_2f_recovery_rate_2:
    name: "2F Recovery Rate Slot 2"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_2f_recovery_rate_3:
    name: "2F Recovery Rate Slot 3"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_2f_recovery_rate_4:
    name: "2F Recovery Rate Slot 4"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_2f_recovery_rate_5:
    name: "2F Recovery Rate Slot 5"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_2f_recovery_rate_6:
    name: "2F Recovery Rate Slot 6"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_2f_recovery_rate_7:
    name: "2F Recovery Rate Slot 7"
    min: 0
    max: 60
    step: 0.1
    unit_of_measurement: "min/°F"
    mode: box
  hvac_2f_recovery_setback_degrees:
    name: "2F Recovery Setback Degrees"
    min: 0
    max: 15
    step: 0.1
    unit_of_measurement: "°F"
    mode: box
  hvac_2f_recovery_outdoor_temp:
    name: "2F Recovery Outdoor Temp"
    min: -20
    max: 100
    step: 0.1
    unit_of_measurement: "°F"
    mode: box

  # ===============================================================
  # SETBACK EFFICIENCY TRACKING - 1F
  # ===============================================================
  hvac_1f_setback_start_runtime:
    name: "1F Setback Start Runtime"
    min: 0
    max: 1440
    step: 0.1
    unit_of_measurement: "min"
    mode: box
  hvac_1f_setback_start_outdoor_temp:
    name: "1F Setback Start Outdoor Temp"
    min: -20
    max: 100
    step: 0.1
    unit_of_measurement: "°F"
    mode: box
  hvac_1f_recovery_start_runtime:
    name: "1F Recovery Start Runtime"
    min: 0
    max: 1440
    step: 0.1
    unit_of_measurement: "min"
    mode: box
  hvac_1f_overnight_runtime:
    name: "1F Overnight Runtime"
    min: 0
    max: 1440
    step: 0.1
    unit_of_measurement: "min"
    mode: box
  hvac_1f_overnight_efficiency:
    name: "1F Overnight Efficiency"
    min: 0
    max: 200
    step: 0.1
    unit_of_measurement: "min/HDD"
    mode: box
  hvac_1f_recovery_efficiency:
    name: "1F Recovery Efficiency"
    min: 0
    max: 200
    step: 0.1
    unit_of_measurement: "min/HDD"
    mode: box
  hvac_1f_setback_degree_hours:
    name: "1F Setback Degree-Hours"
    min: 0
    max: 100
    step: 0.01
    unit_of_measurement: "°F·h"
    mode: box
  hvac_1f_hold_setpoint:
    name: "1F Hold Setpoint"
    min: 50
    max: 80
    step: 0.5
    unit_of_measurement: "°F"
    mode: box

  # ===============================================================
  # SETBACK EFFICIENCY TRACKING - 2F
  # ===============================================================
  hvac_2f_setback_start_runtime:
    name: "2F Setback Start Runtime"
    min: 0
    max: 1440
    step: 0.1
    unit_of_measurement: "min"
    mode: box
  hvac_2f_setback_start_outdoor_temp:
    name: "2F Setback Start Outdoor Temp"
    min: -20
    max: 100
    step: 0.1
    unit_of_measurement: "°F"
    mode: box
  hvac_2f_recovery_start_runtime:
    name: "2F Recovery Start Runtime"
    min: 0
    max: 1440
    step: 0.1
    unit_of_measurement: "min"
    mode: box
  hvac_2f_overnight_runtime:
    name: "2F Overnight Runtime"
    min: 0
    max: 1440
    step: 0.1
    unit_of_measurement: "min"
    mode: box
  hvac_2f_overnight_efficiency:
    name: "2F Overnight Efficiency"
    min: 0
    max: 200
    step: 0.1
    unit_of_measurement: "min/HDD"
    mode: box
  hvac_2f_recovery_efficiency:
    name: "2F Recovery Efficiency"
    min: 0
    max: 200
    step: 0.1
    unit_of_measurement: "min/HDD"
    mode: box
  hvac_2f_setback_degree_hours:
    name: "2F Setback Degree-Hours"
    min: 0
    max: 100
    step: 0.01
    unit_of_measurement: "°F·h"
    mode: box
  hvac_2f_hold_setpoint:
    name: "2F Hold Setpoint"
    min: 50
    max: 80
    step: 0.5
    unit_of_measurement: "°F"
    mode: box

  # ===============================================================
  # DEHUMIDIFIER CONTROL
  # ===============================================================
  dehumidifier_dewpoint_threshold:
    name: "Dehumidifier Dew Point Threshold"
    min: 40
    max: 70
    step: 1
    unit_of_measurement: "°F"
    mode: box
    icon: mdi:water-thermometer
    initial: 52

# ===============================================================
# INPUT DATETIME
# ===============================================================
input_datetime:
  electricity_bill_date:
    name: "Electricity Bill Date"
    has_date: true
    has_time: false
    icon: mdi:calendar-clock

  gas_bill_date:
    name: "Gas Bill Date"
    has_date: true
    has_time: false
    icon: mdi:calendar-clock

  hvac_1f_recovery_start:
    name: "1F Recovery Start Time"
    has_date: true
    has_time: true
    icon: mdi:clock-start

  hvac_2f_recovery_start:
    name: "2F Recovery Start Time"
    has_date: true
    has_time: true

  hvac_1f_setback_start:
    name: "1F Setback Start Time"
    has_date: true
    has_time: true
    icon: mdi:clock-start

  hvac_2f_setback_start:
    name: "2F Setback Start Time"
    has_date: true
    has_time: true
    icon: mdi:clock-start

  hvac_filter_last_changed:
    name: "Filter Last Changed"
    has_date: true
    has_time: false
    icon: mdi:calendar-clock

  # ===============================================================
  # CAPTURE HEALTH TRACKING
  # ===============================================================
  hdd_capture_last_ok:
    name: "HDD Capture Last OK"
    has_date: true
    has_time: true
    icon: mdi:check-circle

  runtime_per_hdd_capture_last_ok:
    name: "Runtime/HDD Capture Last OK"
    has_date: true
    has_time: true
    icon: mdi:check-circle

# ===============================================================
# TEMPLATE SENSORS
# ===============================================================
template:
  - binary_sensor:
      - name: "HVAC 2F Call For Heat"
        unique_id: hvac_2f_call_for_heat
        state: >
          {% if states('climate.tstat_2d8878_lyric_t6_pro_thermostat') not in ['unavailable', 'unknown'] %}
            {{ state_attr('climate.tstat_2d8878_lyric_t6_pro_thermostat', 'hvac_action') == 'heating' }}
          {% else %}
            false
          {% endif %}

      - name: "HVAC 1F Call For Heat"
        unique_id: hvac_1f_call_for_heat
        state: >
          {% if states('climate.tstat_2d884c_lyric_t6_pro_thermostat') not in ['unavailable', 'unknown'] %}
            {{ state_attr('climate.tstat_2d884c_lyric_t6_pro_thermostat', 'hvac_action') == 'heating' }}
          {% else %}
            false
          {% endif %}

      # Furnace Running - ON when EITHER zone is calling for heat (actual furnace cycles)
      - name: "HVAC Furnace Running"
        unique_id: hvac_furnace_running
        device_class: running
        state: >
          {{ is_state('binary_sensor.hvac_1f_call_for_heat', 'on') or
             is_state('binary_sensor.hvac_2f_call_for_heat', 'on') }}

      - name: "HVAC Efficiency Alert"
        unique_id: hvac_efficiency_alert
        device_class: problem
        state: >
          {% set efficiency = states('sensor.hvac_heating_efficiency_mtd') | float(0) %}
          {% set baseline = states('input_number.heating_efficiency_baseline') | float(82.6) %}
          {{ efficiency > (baseline * 1.10) and efficiency > 0 }}

      - name: "HVAC UA Degradation Alert"
        unique_id: hvac_ua_degradation_alert
        device_class: problem
        state: >
          {% set ua = states('sensor.hvac_building_load_ua_estimate') | float(449) %}
          {% set baseline = states('input_number.building_ua_baseline') | float(449) %}
          {{ ua > (baseline * 1.10) }}

      - name: "HVAC Short Cycling Alert 1F"
        unique_id: hvac_short_cycling_alert_1f
        device_class: problem
        state: >
          {% set runtime = states('sensor.hvac_1f_heat_runtime_today') | float(0) %}
          {% set cycles = states('sensor.hvac_1f_heat_cycles_today') | int(0) %}
          {% if cycles > 3 and runtime > 0 %}
            {{ ((runtime * 60) / cycles) < 5 }}
          {% else %}
            false
          {% endif %}

      - name: "HVAC Short Cycling Alert 2F"
        unique_id: hvac_short_cycling_alert_2f
        device_class: problem
        state: >
          {% set runtime = states('sensor.hvac_2f_heat_runtime_today') | float(0) %}
          {% set cycles = states('sensor.hvac_2f_heat_cycles_today') | int(0) %}
          {% if cycles > 3 and runtime > 0 %}
            {{ ((runtime * 60) / cycles) < 5 }}
          {% else %}
            false
          {% endif %}

      - name: "Baseline Deviation Alert"
        unique_id: baseline_deviation_alert
        device_class: problem
        state: >
          {% set eui_current = states('sensor.site_eui_estimate') | float(0) %}
          {% set eui_baseline = states('input_number.site_eui_baseline') | float(41.7) %}
          {{ eui_current > (eui_baseline * 1.05) and eui_current > 0 }}

      - name: "Dehumidifier Should Run"
        unique_id: dehumidifier_should_run
        state: >
          {% set temp = states('sensor.shelly_temperature_humidity_temperature') | float(0) %}
          {% set dp = states('sensor.basement_dew_point') | float(0) %}
          {% set threshold = states('input_number.dehumidifier_dewpoint_threshold') | float(52) %}
          {{ temp > 60 and dp > threshold }}

      - name: "HVAC Filter Change Alert"
        unique_id: hvac_filter_change_alert
        device_class: problem
        state: >
          {{ states('input_number.hvac_filter_runtime_hours') | float(0) >= 1000 }}

      - name: "HVAC Runtime per HDD High Alert"
        unique_id: hvac_runtime_per_hdd_high_alert
        device_class: problem
        state: >
          {% set current = states('sensor.hvac_runtime_per_hdd_7day') | float(0) %}
          {% set upper = states('sensor.hvac_runtime_per_hdd_upper_bound') | float(0) %}
          {% set count = states('sensor.hvac_runtime_per_hdd_data_count') | int(0) %}
          {{ current > upper and upper > 0 and count >= 4 }}

      - name: "HVAC Runtime per HDD Low Alert"
        unique_id: hvac_runtime_per_hdd_low_alert
        device_class: problem
        state: >
          {% set current = states('sensor.hvac_runtime_per_hdd_7day') | float(0) %}
          {% set lower = states('sensor.hvac_runtime_per_hdd_lower_bound') | float(0) %}
          {% set count = states('sensor.hvac_runtime_per_hdd_data_count') | int(0) %}
          {{ current < lower and current > 0 and count >= 4 }}

      # Recovery sensors use hysteresis to avoid flickering during furnace cycles
      # Starts: gap > 2°F (significant setback), Ends: gap <= 0.5°F (near setpoint)
      - name: "HVAC 1F Recovering"
        unique_id: hvac_1f_recovering
        state: >
          {% set current = state_attr('climate.tstat_2d884c_lyric_t6_pro_thermostat', 'current_temperature') | float(0) %}
          {% set target = state_attr('climate.tstat_2d884c_lyric_t6_pro_thermostat', 'temperature') | float(0) %}
          {% set gap = target - current %}
          {% set was_recovering = this.state == 'on' %}
          {% if was_recovering %}
            {{ gap > 0.5 }}
          {% else %}
            {{ gap > 2 }}
          {% endif %}

      - name: "HVAC 2F Recovering"
        unique_id: hvac_2f_recovering
        state: >
          {% set current = state_attr('climate.tstat_2d8878_lyric_t6_pro_thermostat', 'current_temperature') | float(0) %}
          {% set target = state_attr('climate.tstat_2d8878_lyric_t6_pro_thermostat', 'temperature') | float(0) %}
          {% set gap = target - current %}
          {% set was_recovering = this.state == 'on' %}
          {% if was_recovering %}
            {{ gap > 0.5 }}
          {% else %}
            {{ gap > 2 }}
          {% endif %}

      - name: "HVAC 1F Recovery Rate Alert"
        unique_id: hvac_1f_recovery_rate_alert
        device_class: problem
        state: >
          {% set current = states('sensor.hvac_1f_recovery_rate_avg') | float(0) %}
          {% set upper = states('sensor.hvac_1f_recovery_rate_upper_bound') | float(0) %}
          {% set count = states('sensor.hvac_1f_recovery_rate_data_count') | int(0) %}
          {{ current > upper and upper > 0 and count >= 4 }}

      - name: "HVAC 2F Recovery Rate Alert"
        unique_id: hvac_2f_recovery_rate_alert
        device_class: problem
        state: >
          {% set current = states('sensor.hvac_2f_recovery_rate_avg') | float(0) %}
          {% set upper = states('sensor.hvac_2f_recovery_rate_upper_bound') | float(0) %}
          {% set count = states('sensor.hvac_2f_recovery_rate_data_count') | int(0) %}
          {{ current > upper and upper > 0 and count >= 4 }}

      # ===============================================================
      # CAPTURE HEALTH MONITORING
      # ===============================================================
      - name: "HDD Capture Stale"
        unique_id: hdd_capture_stale
        device_class: problem
        state: >
          {% set last_ok = states('input_datetime.hdd_capture_last_ok') %}
          {% if last_ok in ['unknown', 'unavailable'] or last_ok == '1970-01-01 00:00:00' %}
            true
          {% else %}
            {% set dt = last_ok | as_datetime | as_local %}
            {{ (now() - dt).total_seconds() > 93600 }}
          {% endif %}

      - name: "Runtime per HDD Capture Stale"
        unique_id: runtime_per_hdd_capture_stale
        device_class: problem
        state: >
          {% set last_ok = states('input_datetime.runtime_per_hdd_capture_last_ok') %}
          {% if last_ok in ['unknown', 'unavailable'] or last_ok == '1970-01-01 00:00:00' %}
            true
          {% else %}
            {% set dt = last_ok | as_datetime | as_local %}
            {{ (now() - dt).total_seconds() > 93600 }}
          {% endif %}

  - sensor:
      # Uses live feed first (10 min updates), then Pirate Weather, then NWS/Open-Meteo
      - name: "HVAC Outdoor Temp Hartford Proxy"
        unique_id: hvac_outdoor_temp_hartford_proxy
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        state: >
          {% set live_state = states('sensor.outdoor_temp_live') %}
          {% set live = live_state | float(-999) %}
          {% set pw = state_attr('weather.pirateweather', 'temperature') %}
          {% set nws = state_attr('weather.local_weather_2','temperature') %}
          {% set om = state_attr('weather.home','temperature') %}
          {% if live_state not in ['unknown', 'unavailable'] and live > -50 %}
            {{ live | round(1) }}
          {% elif pw is number and pw > -50 %}
            {{ pw | round(1) }}
          {% elif nws is number and nws > -50 %}
            {{ nws | round(1) }}
          {% elif om is number and om > -50 %}
            {{ om | round(1) }}
          {% else %}
            {{ 35 }}
          {% endif %}

      - name: "HVAC Outdoor Weather Source"
        unique_id: hvac_outdoor_weather_source
        state: >
          {% set live_state = states('sensor.outdoor_temp_live') %}
          {% set live = live_state | float(-999) %}
          {% set pw = state_attr('weather.pirateweather', 'temperature') %}
          {% set nws = state_attr('weather.local_weather_2','temperature') %}
          {% if live_state not in ['unknown', 'unavailable'] and live > -50 %}Live API (10min)
          {% elif pw is number and pw > -50 %}Pirate Weather
          {% elif nws is number and nws > -50 %}NWS/NOAA
          {% else %}Open-Meteo{% endif %}

      - name: "HVAC HDD65 Today"
        unique_id: hvac_hdd65_today
        unit_of_measurement: "HDD"
        state_class: measurement
        icon: mdi:snowflake
        state: >
          {% set mean_raw = states('sensor.hvac_outdoor_temp_mean_24h') %}
          {% set mean_t = mean_raw | float(none) if mean_raw not in ['unknown', 'unavailable'] else none %}
          {% set cur_t = states('sensor.hvac_outdoor_temp_hartford_proxy') | float(35) %}
          {% set t = mean_t if mean_t is not none else cur_t %}
          {{ [65 - t, 0] | max | round(1) }}

      - name: "HVAC CDD65 Today"
        unique_id: hvac_cdd65_today
        unit_of_measurement: "CDD"
        state_class: measurement
        icon: mdi:sun-thermometer
        state: >
          {% set mean_raw = states('sensor.hvac_outdoor_temp_mean_24h') %}
          {% set mean_t = mean_raw | float(none) if mean_raw not in ['unknown', 'unavailable'] else none %}
          {% set cur_t = states('sensor.hvac_outdoor_temp_hartford_proxy') | float(35) %}
          {% set t = mean_t if mean_t is not none else cur_t %}
          {{ [t - 65, 0] | max | round(1) }}

      - name: "HDD Rolling 7-Day Auto"
        unique_id: hdd_rolling_7_day_auto
        unit_of_measurement: "HDD"
        state_class: measurement
        icon: mdi:snowflake-thermometer
        state: >
          {{ (states('input_number.hdd_day_1') | float(0) +
              states('input_number.hdd_day_2') | float(0) +
              states('input_number.hdd_day_3') | float(0) +
              states('input_number.hdd_day_4') | float(0) +
              states('input_number.hdd_day_5') | float(0) +
              states('input_number.hdd_day_6') | float(0) +
              states('input_number.hdd_day_7') | float(0)) | round(1) }}

      - name: "HVAC HDD65 Cumulative Month"
        unique_id: hvac_hdd65_cumulative_month
        unit_of_measurement: "HDD"
        state_class: total
        icon: mdi:snowflake-thermometer
        state: >
          {% set auto = states('input_number.hdd_cumulative_month_auto') | float(0) %}
          {% set today = states('sensor.hvac_hdd65_today') | float(0) %}
          {{ (auto + today) | round(1) }}

      - name: "HVAC HDD65 Cumulative Year"
        unique_id: hvac_hdd65_cumulative_year
        unit_of_measurement: "HDD"
        state_class: total
        icon: mdi:snowflake-thermometer
        state: >
          {% set auto = states('input_number.hdd_cumulative_year_auto') | float(0) %}
          {% set today = states('sensor.hvac_hdd65_today') | float(0) %}
          {{ (auto + today) | round(1) }}

      - name: "HVAC Total Heat Runtime Today"
        unique_id: hvac_total_heat_runtime_today
        unit_of_measurement: "h"
        state_class: measurement
        state: >
          {% set r1 = states('sensor.hvac_1f_heat_runtime_today') | float(0) %}
          {% set r2 = states('sensor.hvac_2f_heat_runtime_today') | float(0) %}
          {{ (r1 + r2) | round(2) }}

      - name: "HVAC Total Runtime per HDD Today"
        unique_id: hvac_total_runtime_per_hdd_today
        unit_of_measurement: "min/HDD"
        state_class: measurement
        state: >
          {% set runtime = states('sensor.hvac_total_heat_runtime_today') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {{ ((runtime * 60) / hdd) | round(1) if hdd > 0 else 0 }}

      - name: "HVAC 1F Runtime per HDD Today"
        unique_id: hvac_1f_runtime_per_hdd_today
        unit_of_measurement: "min/HDD"
        state_class: measurement
        state: >
          {% set runtime = states('sensor.hvac_1f_heat_runtime_today') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {{ ((runtime * 60) / hdd) | round(1) if hdd > 0 else 0 }}

      - name: "HVAC 2F Runtime per HDD Today"
        unique_id: hvac_2f_runtime_per_hdd_today
        unit_of_measurement: "min/HDD"
        state_class: measurement
        state: >
          {% set runtime = states('sensor.hvac_2f_heat_runtime_today') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {{ ((runtime * 60) / hdd) | round(1) if hdd > 0 else 0 }}

      - name: "HVAC Total Cycles Today"
        unique_id: hvac_total_cycles_today
        unit_of_measurement: "cycles"
        state_class: measurement
        state: >
          {{ states('sensor.hvac_1f_heat_cycles_today') | int(0) + states('sensor.hvac_2f_heat_cycles_today') | int(0) }}

      # Actual furnace min/cycle - captures overlapping thermostat calls as single cycle
      - name: "HVAC Furnace Min per Cycle"
        unique_id: hvac_furnace_min_per_cycle
        unit_of_measurement: "min/cycle"
        state_class: measurement
        icon: mdi:timer-cog
        state: >
          {% set runtime = states('sensor.hvac_furnace_runtime_today') | float(0) %}
          {% set cycles = states('sensor.hvac_furnace_cycles_today') | int(0) %}
          {% if cycles > 0 and runtime > 0 %}
            {{ ((runtime * 60) / cycles) | round(1) }}
          {% else %}
            0
          {% endif %}

      - name: "HVAC Chaining Index"
        unique_id: hvac_chaining_index
        state_class: measurement
        icon: mdi:link-variant
        state: >
          {% set zone_calls = states('sensor.hvac_1f_heat_cycles_today') | int(0) + states('sensor.hvac_2f_heat_cycles_today') | int(0) %}
          {% set furnace_cycles = states('sensor.hvac_furnace_cycles_today') | int(0) %}
          {% if furnace_cycles > 0 %}
            {{ (zone_calls / furnace_cycles) | round(2) }}
          {% else %}
            1.0
          {% endif %}

      - name: "HVAC Zone Overlap Today"
        unique_id: hvac_zone_overlap_today
        unit_of_measurement: "min"
        state_class: measurement
        icon: mdi:set-center
        availability: >
          {{ states('sensor.hvac_total_heat_runtime_today') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_furnace_runtime_today') not in ['unknown', 'unavailable'] }}
        state: >
          {% set total_min = states('sensor.hvac_total_heat_runtime_today') | float(0) * 60 %}
          {% set furnace_min = states('sensor.hvac_furnace_runtime_today') | float(0) * 60 %}
          {{ [total_min - furnace_min, 0] | max | round(1) }}

      - name: "HVAC Zone Overlap Percent"
        unique_id: hvac_zone_overlap_percent
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:percent
        availability: >
          {{ states('sensor.hvac_total_heat_runtime_today') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_furnace_runtime_today') not in ['unknown', 'unavailable'] }}
        state: >
          {% set total_min = states('sensor.hvac_total_heat_runtime_today') | float(0) * 60 %}
          {% set furnace_min = states('sensor.hvac_furnace_runtime_today') | float(0) * 60 %}
          {% set overlap_min = [total_min - furnace_min, 0] | max %}
          {% if furnace_min > 0 %}
            {{ (overlap_min / furnace_min * 100) | round(1) }}
          {% else %}
            0
          {% endif %}

      - name: "HVAC Zone Balance Ratio Today"
        unique_id: hvac_zone_balance_ratio_today
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set r1 = states('sensor.hvac_1f_heat_runtime_today') | float(0) %}
          {% set r2 = states('sensor.hvac_2f_heat_runtime_today') | float(0) %}
          {% set total = r1 + r2 %}
          {{ ((r2 / total) * 100) | round(1) if total > 0 else 50 }}

      - name: "HVAC Zone Balance Status"
        unique_id: hvac_zone_balance_status
        state: >
          {% set ratio = states('sensor.hvac_zone_balance_ratio_today') | float(50) %}
          {% if ratio >= 45 and ratio <= 65 %}Balanced
          {% elif ratio > 65 %}2F Heavy
          {% else %}1F Heavy{% endif %}

      - name: "HVAC Total Heat Runtime Week"
        unique_id: hvac_total_heat_runtime_week
        unit_of_measurement: "h"
        state_class: measurement
        state: >
          {{ (states('sensor.hvac_1f_heat_runtime_week') | float(0) + states('sensor.hvac_2f_heat_runtime_week') | float(0)) | round(2) }}

      - name: "HVAC Zone Balance Week"
        unique_id: hvac_zone_balance_week
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set r1 = states('sensor.hvac_1f_heat_runtime_week') | float(0) %}
          {% set r2 = states('sensor.hvac_2f_heat_runtime_week') | float(0) %}
          {% set total = r1 + r2 %}
          {{ ((r2 / total) * 100) | round(1) if total > 0 else 50 }}

      - name: "HVAC Runtime per HDD 7-Day"
        unique_id: hvac_runtime_per_hdd_7day
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:chart-line
        state: >
          {% set runtime = states('sensor.hvac_total_heat_runtime_week') | float(0) %}
          {% set hdd = states('sensor.hdd_rolling_7_day_auto_2') | float(0) %}
          {{ ((runtime * 60) / hdd) | round(1) if hdd > 0 else 0 }}

      # === RUNTIME PER HDD STATISTICS (for control chart boundaries) ===
      - name: "HVAC Runtime per HDD 7-Day Mean"
        unique_id: hvac_runtime_per_hdd_7day_mean
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:chart-bell-curve
        state: >
          {% set d1 = states('input_number.runtime_per_hdd_day_1') | float(0) %}
          {% set d2 = states('input_number.runtime_per_hdd_day_2') | float(0) %}
          {% set d3 = states('input_number.runtime_per_hdd_day_3') | float(0) %}
          {% set d4 = states('input_number.runtime_per_hdd_day_4') | float(0) %}
          {% set d5 = states('input_number.runtime_per_hdd_day_5') | float(0) %}
          {% set d6 = states('input_number.runtime_per_hdd_day_6') | float(0) %}
          {% set d7 = states('input_number.runtime_per_hdd_day_7') | float(0) %}
          {% set values = [d1, d2, d3, d4, d5, d6, d7] | select('gt', 0) | list %}
          {% if values | length > 0 %}
            {{ (values | sum / values | length) | round(1) }}
          {% else %}
            10.6
          {% endif %}

      - name: "HVAC Runtime per HDD 7-Day Std Dev"
        unique_id: hvac_runtime_per_hdd_7day_stddev
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:sigma
        state: >
          {% set d1 = states('input_number.runtime_per_hdd_day_1') | float(0) %}
          {% set d2 = states('input_number.runtime_per_hdd_day_2') | float(0) %}
          {% set d3 = states('input_number.runtime_per_hdd_day_3') | float(0) %}
          {% set d4 = states('input_number.runtime_per_hdd_day_4') | float(0) %}
          {% set d5 = states('input_number.runtime_per_hdd_day_5') | float(0) %}
          {% set d6 = states('input_number.runtime_per_hdd_day_6') | float(0) %}
          {% set d7 = states('input_number.runtime_per_hdd_day_7') | float(0) %}
          {% set values = [d1, d2, d3, d4, d5, d6, d7] | select('gt', 0) | list %}
          {% if values | length > 1 %}
            {% set mean = values | sum / values | length %}
            {% set variance = namespace(sum=0) %}
            {% for v in values %}
              {% set variance.sum = variance.sum + ((v - mean) ** 2) %}
            {% endfor %}
            {{ ((variance.sum / (values | length - 1)) ** 0.5) | round(1) }}
          {% else %}
            1.1
          {% endif %}

      - name: "HVAC Runtime per HDD Upper Bound"
        unique_id: hvac_runtime_per_hdd_upper_bound
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:arrow-up-bold
        state: >
          {% set mean = states('sensor.hvac_runtime_per_hdd_7day_mean') | float(10) %}
          {% set stddev = states('sensor.hvac_runtime_per_hdd_7day_stddev') | float(2) %}
          {{ (mean + (stddev * 2)) | round(1) }}

      - name: "HVAC Runtime per HDD Lower Bound"
        unique_id: hvac_runtime_per_hdd_lower_bound
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:arrow-down-bold
        state: >
          {% set mean = states('sensor.hvac_runtime_per_hdd_7day_mean') | float(10) %}
          {% set stddev = states('sensor.hvac_runtime_per_hdd_7day_stddev') | float(2) %}
          {% set lower = mean - (stddev * 2) %}
          {{ lower | round(1) if lower > 0 else 0 }}

      - name: "HVAC Runtime per HDD Data Count"
        unique_id: hvac_runtime_per_hdd_data_count
        unit_of_measurement: "samples"
        state_class: measurement
        icon: mdi:counter
        state: >
          {% set days = [
            states('input_number.runtime_per_hdd_day_1') | float(0),
            states('input_number.runtime_per_hdd_day_2') | float(0),
            states('input_number.runtime_per_hdd_day_3') | float(0),
            states('input_number.runtime_per_hdd_day_4') | float(0),
            states('input_number.runtime_per_hdd_day_5') | float(0),
            states('input_number.runtime_per_hdd_day_6') | float(0),
            states('input_number.runtime_per_hdd_day_7') | float(0)
          ] %}
          {{ days | select('gt', 0) | list | count }}

      - name: "HVAC Daily Gas Cost Estimate"
        unique_id: hvac_daily_gas_cost_estimate
        unit_of_measurement: "$"
        state_class: measurement
        icon: mdi:currency-usd
        state: >
          {% set runtime = states('sensor.hvac_total_heat_runtime_today') | float(0) %}
          {% set rate = states('input_number.furnace_heating_rate_btu_hr') | float(60556) %}
          {% set gas_rate = states('sensor.gas_effective_rate') | float(1.68) %}
          {% set ccf_used = (runtime * rate) / (103700 * 0.95) %}
          {{ (ccf_used * gas_rate) | round(2) }}

      - name: "HVAC Daily Electric Cost Estimate"
        unique_id: hvac_daily_electric_cost_estimate
        unit_of_measurement: "$"
        state_class: measurement
        icon: mdi:currency-usd
        state: >
          {% set runtime = states('sensor.hvac_total_heat_runtime_today') | float(0) %}
          {% set blower_kw = 0.5 %}
          {% set elec_rate = states('sensor.electricity_effective_rate') | float(0.27) %}
          {{ (runtime * blower_kw * elec_rate) | round(2) }}

      - name: "HVAC Daily Total Cost Estimate"
        unique_id: hvac_daily_total_cost_estimate
        unit_of_measurement: "$"
        state_class: measurement
        icon: mdi:currency-usd
        state: >
          {% set gas = states('sensor.hvac_daily_gas_cost_estimate') | float(0) %}
          {% set elec = states('sensor.hvac_daily_electric_cost_estimate') | float(0) %}
          {{ (gas + elec) | round(2) }}

      - name: "HVAC Filter Hours Remaining"
        unique_id: hvac_filter_hours_remaining
        unit_of_measurement: "hours"
        state_class: measurement
        icon: mdi:air-filter
        state: >
          {% set current = states('input_number.hvac_filter_runtime_hours') | float(0) %}
          {{ (1000 - current) | round(1) if current < 1000 else 0 }}

      - name: "HVAC Total Heat Runtime Month"
        unique_id: hvac_total_heat_runtime_month
        unit_of_measurement: "h"
        state_class: measurement
        state: >
          {{ (states('sensor.hvac_1f_heat_runtime_month') | float(0) + states('sensor.hvac_2f_heat_runtime_month') | float(0)) | round(2) }}

      - name: "HVAC Runtime per HDD Month"
        unique_id: hvac_runtime_per_hdd_month
        unit_of_measurement: "min/HDD"
        state_class: measurement
        state: >
          {% set runtime = states('sensor.hvac_total_heat_runtime_month') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_cumulative_month') | float(0) %}
          {{ ((runtime * 60) / hdd) | round(1) if hdd > 0 else 0 }}

      - name: "HVAC Zone Balance Month"
        unique_id: hvac_zone_balance_month
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set r1 = states('sensor.hvac_1f_heat_runtime_month') | float(0) %}
          {% set r2 = states('sensor.hvac_2f_heat_runtime_month') | float(0) %}
          {% set total = r1 + r2 %}
          {{ ((r2 / total) * 100) | round(1) if total > 0 else 50 }}

      - name: "HVAC Heating Efficiency MTD"
        unique_id: hvac_heating_efficiency_mtd
        unit_of_measurement: "CCF/1k HDD"
        state_class: measurement
        icon: mdi:chart-bell-curve-cumulative
        state: >
          {% set hdd = states('sensor.hvac_hdd65_cumulative_month') | float(0) %}
          {% set runtime = states('sensor.hvac_total_heat_runtime_month') | float(0) %}
          {% set rate = states('input_number.furnace_heating_rate_btu_hr') | float(60556) %}
          {% if hdd > 0 and runtime > 0 %}
            {% set gas = (runtime * rate) / (103700 * 0.95) %}
            {{ ((gas / hdd) * 1000) | round(1) }}
          {% else %}{{ 0 }}{% endif %}

      - name: "HVAC Building Load UA Estimate"
        unique_id: hvac_building_load_ua_estimate
        unit_of_measurement: "BTU/hr-°F"
        state_class: measurement
        state: >
          {% set runtime = states('sensor.hvac_total_heat_runtime_month') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_cumulative_month') | float(0) %}
          {% set rate = states('input_number.furnace_heating_rate_btu_hr') | float(60556) %}
          {% set days = now().day %}
          {% if hdd > 0 and runtime > 0 and days > 0 %}
            {% set avg_dt = hdd / days %}
            {% set hours = days * 24 %}
            {{ ((runtime * rate) / (avg_dt * hours)) | round(0) }}
          {% else %}{{ 449 }}{% endif %}

      - name: "Balance Point Temperature"
        unique_id: balance_point_temperature
        unit_of_measurement: "°F"
        device_class: temperature
        state: "{{ states('input_number.balance_point_baseline') | float(59) }}"

      - name: "Site EUI Estimate"
        unique_id: site_eui_estimate
        unit_of_measurement: "kBTU/ft²-yr"
        state_class: measurement
        state: >
          {% set kwh = states('input_number.electricity_bill_kwh') | float(454) %}
          {% set e_days = states('input_number.electricity_bill_days') | float(30) %}
          {% set ccf = states('input_number.gas_bill_ccf') | float(110) %}
          {% set g_days = states('input_number.gas_bill_days') | float(30) %}
          {% if e_days > 0 and g_days > 0 %}
            {% set ann_kwh = (kwh / e_days) * 365 %}
            {% set ann_ccf = (ccf / g_days) * 365 %}
            {{ ((ann_kwh * 3.412 + ann_ccf * 103.7) / 2440) | round(1) }}
          {% else %}{{ 41.7 }}{% endif %}

      - name: "HVAC Performance vs Baseline"
        unique_id: hvac_performance_vs_baseline
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set current = states('sensor.hvac_heating_efficiency_mtd') | float(0) %}
          {% set baseline = 82.6 %}
          {{ ((current / baseline - 1) * 100) | round(1) if current > 0 else 0 }}

      - name: "UA Performance vs Baseline"
        unique_id: ua_performance_vs_baseline
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set current = states('sensor.hvac_building_load_ua_estimate') | float(449) %}
          {{ ((current / 449 - 1) * 100) | round(1) }}

      - name: "EUI vs Baseline"
        unique_id: eui_vs_baseline
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set current = states('sensor.site_eui_estimate') | float(0) %}
          {{ ((current / 41.7 - 1) * 100) | round(1) if current > 0 else 0 }}

      - name: "Weather Severity vs Normal MTD"
        unique_id: weather_severity_vs_normal_mtd
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:thermometer-alert
        state: >
          {# Monthly normal HDD for CT (6,270 annual baseline) #}
          {% set monthly_normals = {
            1: 1085, 2: 925, 3: 750, 4: 420, 5: 155, 6: 20,
            7: 0, 8: 5, 9: 55, 10: 280, 11: 540, 12: 1035
          } %}
          {% set hdd = states('sensor.hvac_hdd65_cumulative_month') | float(0) %}
          {% set month_normal = monthly_normals[now().month] | float(1) %}
          {% set daily_rate = month_normal / (now().replace(month=now().month % 12 + 1, day=1) - timedelta(days=1)).day %}
          {% set expected = daily_rate * now().day %}
          {{ ((hdd / expected - 1) * 100) | round(1) if expected > 0 else 0 }}

      - name: "Weather Severity Progress MTD"
        unique_id: weather_severity_progress_mtd
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:progress-clock
        state: >
          {# Monthly normal HDD for CT (6,270 annual baseline) #}
          {% set monthly_normals = {
            1: 1085, 2: 925, 3: 750, 4: 420, 5: 155, 6: 20,
            7: 0, 8: 5, 9: 55, 10: 280, 11: 540, 12: 1035
          } %}
          {% set hdd = states('sensor.hvac_hdd65_cumulative_month') | float(0) %}
          {% set month_normal = monthly_normals[now().month] | float(1) %}
          {{ ((hdd / month_normal) * 100) | round(1) if month_normal > 0 else 0 }}

      - name: "Projected Annual Gas CCF"
        unique_id: projected_annual_gas_ccf
        unit_of_measurement: "CCF"
        state: >
          {% set ccf = states('input_number.gas_bill_ccf') | float(110) %}
          {% set days = states('input_number.gas_bill_days') | float(28) %}
          {{ ((ccf / days) * 365) | round(0) if days > 0 else 787 }}

      - name: "Projected Annual Electricity kWh"
        unique_id: projected_annual_electricity_kwh
        unit_of_measurement: "kWh"
        state: >
          {% set kwh = states('input_number.electricity_bill_kwh') | float(454) %}
          {% set days = states('input_number.electricity_bill_days') | float(33) %}
          {{ ((kwh / days) * 365) | round(0) if days > 0 else 6730 }}

      - name: "Electricity Effective Rate"
        unique_id: electricity_effective_rate
        unit_of_measurement: "$/kWh"
        state: >
          {% set amt = states('input_number.electricity_bill_amount') | float(0) %}
          {% set kwh = states('input_number.electricity_bill_kwh') | float(1) %}
          {{ (amt / kwh) | round(4) if amt > 0 and kwh > 0 else 0.2733 }}

      - name: "Gas Effective Rate"
        unique_id: gas_effective_rate
        unit_of_measurement: "$/CCF"
        state: >
          {% set amt = states('input_number.gas_bill_amount') | float(0) %}
          {% set ccf = states('input_number.gas_bill_ccf') | float(1) %}
          {{ (amt / ccf) | round(4) if amt > 0 and ccf > 0 else 1.6818 }}

      - name: "Electricity Effective Rate Previous"
        unique_id: electricity_effective_rate_previous
        unit_of_measurement: "$/kWh"
        state: >
          {% set amt = states('input_number.electricity_bill_amount_previous') | float(0) %}
          {% set kwh = states('input_number.electricity_bill_kwh_previous') | float(1) %}
          {{ (amt / kwh) | round(4) if amt > 0 and kwh > 0 else 0.2722 }}

      - name: "Gas Effective Rate Previous"
        unique_id: gas_effective_rate_previous
        unit_of_measurement: "$/CCF"
        state: >
          {% set amt = states('input_number.gas_bill_amount_previous') | float(0) %}
          {% set ccf = states('input_number.gas_bill_ccf_previous') | float(1) %}
          {{ (amt / ccf) | round(4) if amt > 0 and ccf > 0 else 1.9660 }}

      - name: "Electricity Effective Rate Last Year"
        unique_id: electricity_effective_rate_last_year
        unit_of_measurement: "$/kWh"
        state: >
          {% set amt = states('input_number.electricity_bill_amount_last_year') | float(0) %}
          {% set kwh = states('input_number.electricity_bill_kwh_last_year') | float(1) %}
          {{ (amt / kwh) | round(4) if amt > 0 and kwh > 0 else 0.3152 }}

      - name: "Gas Effective Rate Last Year"
        unique_id: gas_effective_rate_last_year
        unit_of_measurement: "$/CCF"
        state: >
          {% set amt = states('input_number.gas_bill_amount_last_year') | float(0) %}
          {% set ccf = states('input_number.gas_bill_ccf_last_year') | float(1) %}
          {{ (amt / ccf) | round(4) if amt > 0 and ccf > 0 else 1.6613 }}

      - name: "Electricity Rate Change MoM"
        unique_id: electricity_rate_change_mom
        unit_of_measurement: "%"
        state: >
          {% set cur = states('sensor.electricity_effective_rate') | float(0) %}
          {% set prev = states('sensor.electricity_effective_rate_previous') | float(0) %}
          {{ ((cur / prev - 1) * 100) | round(1) if prev > 0 and cur > 0 else 0 }}

      - name: "Gas Rate Change MoM"
        unique_id: gas_rate_change_mom
        unit_of_measurement: "%"
        state: >
          {% set cur = states('sensor.gas_effective_rate') | float(0) %}
          {% set prev = states('sensor.gas_effective_rate_previous') | float(0) %}
          {{ ((cur / prev - 1) * 100) | round(1) if prev > 0 and cur > 0 else 0 }}

      - name: "Electricity Usage Change MoM"
        unique_id: electricity_usage_change_mom
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.electricity_bill_kwh') | float(0) %}
          {% set prev = states('input_number.electricity_bill_kwh_previous') | float(0) %}
          {{ ((cur / prev - 1) * 100) | round(1) if prev > 0 and cur > 0 else 0 }}

      - name: "Gas Usage Change MoM"
        unique_id: gas_usage_change_mom
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.gas_bill_ccf') | float(0) %}
          {% set prev = states('input_number.gas_bill_ccf_previous') | float(0) %}
          {{ ((cur / prev - 1) * 100) | round(1) if prev > 0 and cur > 0 else 0 }}

      - name: "Electricity Bill Change MoM"
        unique_id: electricity_bill_change_mom
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.electricity_bill_amount') | float(0) %}
          {% set prev = states('input_number.electricity_bill_amount_previous') | float(0) %}
          {{ ((cur / prev - 1) * 100) | round(1) if prev > 0 and cur > 0 else 0 }}

      - name: "Gas Bill Change MoM"
        unique_id: gas_bill_change_mom
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.gas_bill_amount') | float(0) %}
          {% set prev = states('input_number.gas_bill_amount_previous') | float(0) %}
          {{ ((cur / prev - 1) * 100) | round(1) if prev > 0 and cur > 0 else 0 }}

      - name: "Electricity Rate Change YoY"
        unique_id: electricity_rate_change_yoy
        unit_of_measurement: "%"
        state: >
          {% set cur = states('sensor.electricity_effective_rate') | float(0) %}
          {% set ly = states('sensor.electricity_effective_rate_last_year') | float(0) %}
          {{ ((cur / ly - 1) * 100) | round(1) if ly > 0 and cur > 0 else 0 }}

      - name: "Gas Rate Change YoY"
        unique_id: gas_rate_change_yoy
        unit_of_measurement: "%"
        state: >
          {% set cur = states('sensor.gas_effective_rate') | float(0) %}
          {% set ly = states('sensor.gas_effective_rate_last_year') | float(0) %}
          {{ ((cur / ly - 1) * 100) | round(1) if ly > 0 and cur > 0 else 0 }}

      - name: "Electricity Usage Change YoY"
        unique_id: electricity_usage_change_yoy
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.electricity_bill_kwh') | float(0) %}
          {% set ly = states('input_number.electricity_bill_kwh_last_year') | float(0) %}
          {{ ((cur / ly - 1) * 100) | round(1) if ly > 0 and cur > 0 else 0 }}

      - name: "Gas Usage Change YoY"
        unique_id: gas_usage_change_yoy
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.gas_bill_ccf') | float(0) %}
          {% set ly = states('input_number.gas_bill_ccf_last_year') | float(0) %}
          {{ ((cur / ly - 1) * 100) | round(1) if ly > 0 and cur > 0 else 0 }}

      - name: "Electricity Bill Change YoY"
        unique_id: electricity_bill_change_yoy
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.electricity_bill_amount') | float(0) %}
          {% set ly = states('input_number.electricity_bill_amount_last_year') | float(0) %}
          {{ ((cur / ly - 1) * 100) | round(1) if ly > 0 and cur > 0 else 0 }}

      - name: "Gas Bill Change YoY"
        unique_id: gas_bill_change_yoy
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.gas_bill_amount') | float(0) %}
          {% set ly = states('input_number.gas_bill_amount_last_year') | float(0) %}
          {{ ((cur / ly - 1) * 100) | round(1) if ly > 0 and cur > 0 else 0 }}

      - name: "Gas Usage This Month"
        unique_id: gas_usage_this_month
        unit_of_measurement: "CCF"
        state: "{{ states('input_number.gas_bill_ccf') | float(0) }}"

      - name: "Gas Heating Usage Month"
        unique_id: gas_heating_usage_month
        unit_of_measurement: "CCF"
        state: "{{ (states('input_number.gas_bill_ccf') | float(0) * 0.719) | round(1) }}"

      - name: "Gas DHW Usage Month"
        unique_id: gas_dhw_usage_month
        unit_of_measurement: "CCF"
        state: "{{ (states('input_number.gas_bill_ccf') | float(0) * 0.281) | round(1) }}"

      - name: "Gas Cost This Month"
        unique_id: gas_cost_this_month
        unit_of_measurement: "$"
        state: "{{ states('input_number.gas_bill_amount') | float(0) }}"

      - name: "Gas Heating Cost Month"
        unique_id: gas_heating_cost_month
        unit_of_measurement: "$"
        state: "{{ (states('input_number.gas_bill_amount') | float(0) * 0.719) | round(2) }}"

      - name: "Total Cost Month"
        unique_id: total_cost_month
        unit_of_measurement: "$"
        state: >
          {% set amt = states('input_number.electricity_bill_amount') | float(124) %}
          {% set days = states('input_number.electricity_bill_days') | float(30) %}
          {{ ((amt / days) * now().day) | round(2) }}

      - name: "Total Utility Cost Month"
        unique_id: total_utility_cost_month
        unit_of_measurement: "$"
        state: >
          {{ (states('sensor.total_cost_month') | float(0) + states('sensor.gas_cost_this_month') | float(0)) | round(2) }}

      - name: "HVAC Cathedral Ceiling Impact MTD"
        unique_id: hvac_cathedral_ceiling_impact_mtd
        unit_of_measurement: "$"
        state: >
          {% set r2 = states('sensor.hvac_2f_heat_runtime_month') | float(0) %}
          {% set rate = states('input_number.furnace_heating_rate_btu_hr') | float(60556) %}
          {% set gas_rate = states('sensor.gas_effective_rate') | float(1.68) %}
          {{ ((r2 * rate * 0.15 / 103700) * gas_rate) | round(2) }}

      - name: "Basement Dew Point"
        unique_id: basement_dew_point
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        state: >
          {% set t = states('sensor.shelly_temperature_humidity_temperature') | float(0) %}
          {% set rh = states('sensor.shelly_temperature_humidity_humidity') | float(0) %}
          {% if t > 0 and rh > 0 %}
            {% set t_c = (t - 32) * 5 / 9 %}
            {% set a = 17.27 %}
            {% set b = 237.7 %}
            {% set gamma = log(rh / 100) + (a * t_c) / (b + t_c) %}
            {% set dp_c = (b * gamma) / (a - gamma) %}
            {{ (dp_c * 9 / 5 + 32) | round(1) }}
          {% else %}
            50
          {% endif %}

      # ===============================================================
      # PIRATE WEATHER SENSORS
      # ===============================================================
      - name: "Pirate Weather Temperature"
        unique_id: pirate_weather_temperature
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        state: "{{ state_attr('weather.pirateweather', 'temperature') | float(0) }}"

      - name: "Pirate Weather Feels Like"
        unique_id: pirate_weather_feels_like
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        state: >
          {% set temp = state_attr('weather.pirateweather', 'temperature') | float(0) %}
          {% set humidity = state_attr('weather.pirateweather', 'humidity') | float(50) %}
          {% set wind = state_attr('weather.pirateweather', 'wind_speed') | float(0) %}
          {% if temp >= 80 and humidity >= 40 %}
            {# Heat index calculation #}
            {% set hi = -42.379 + 2.04901523*temp + 10.14333127*humidity - 0.22475541*temp*humidity - 0.00683783*temp**2 - 0.05481717*humidity**2 + 0.00122874*temp**2*humidity + 0.00085282*temp*humidity**2 - 0.00000199*temp**2*humidity**2 %}
            {{ hi | round(1) }}
          {% elif temp <= 50 and wind >= 3 %}
            {# Wind chill calculation #}
            {% set wc = 35.74 + 0.6215*temp - 35.75*(wind**0.16) + 0.4275*temp*(wind**0.16) %}
            {{ wc | round(1) }}
          {% else %}
            {{ temp | round(1) }}
          {% endif %}

      - name: "Pirate Weather Humidity"
        unique_id: pirate_weather_humidity
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        state: "{{ state_attr('weather.pirateweather', 'humidity') | float(0) }}"

      - name: "Pirate Weather Pressure"
        unique_id: pirate_weather_pressure
        unit_of_measurement: "inHg"
        device_class: atmospheric_pressure
        state_class: measurement
        state: >
          {% set pressure_hpa = state_attr('weather.pirateweather', 'pressure') | float(1013.25) %}
          {{ (pressure_hpa * 0.02953) | round(2) }}

      - name: "Pirate Weather Wind Speed"
        unique_id: pirate_weather_wind_speed
        unit_of_measurement: "mph"
        device_class: wind_speed
        state_class: measurement
        state: "{{ state_attr('weather.pirateweather', 'wind_speed') | float(0) }}"

      - name: "Pirate Weather Wind Bearing"
        unique_id: pirate_weather_wind_bearing
        unit_of_measurement: "°"
        state_class: measurement
        icon: mdi:compass
        state: "{{ state_attr('weather.pirateweather', 'wind_bearing') | float(0) }}"

      - name: "Pirate Weather Wind Direction"
        unique_id: pirate_weather_wind_direction
        icon: mdi:compass-outline
        state: >
          {% set bearing = state_attr('weather.pirateweather', 'wind_bearing') | float(0) %}
          {% set directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'] %}
          {{ directions[((bearing + 11.25) / 22.5) | int % 16] }}

      - name: "Pirate Weather Visibility"
        unique_id: pirate_weather_visibility
        unit_of_measurement: "mi"
        state_class: measurement
        icon: mdi:eye
        state: "{{ state_attr('weather.pirateweather', 'visibility') | float(10) }}"

      - name: "Pirate Weather Cloud Cover"
        unique_id: pirate_weather_cloud_cover
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:cloud-percent
        state: "{{ state_attr('weather.pirateweather', 'cloud_coverage') | float(0) }}"

      - name: "Pirate Weather Dew Point"
        unique_id: pirate_weather_dew_point
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        state: "{{ state_attr('weather.pirateweather', 'dew_point') | float(0) }}"

      - name: "Pirate Weather UV Index"
        unique_id: pirate_weather_uv_index
        state_class: measurement
        icon: mdi:sun-wireless
        state: "{{ state_attr('weather.pirateweather', 'uv_index') | float(0) }}"

      - name: "Pirate Weather Ozone"
        unique_id: pirate_weather_ozone
        unit_of_measurement: "DU"
        state_class: measurement
        icon: mdi:molecule
        state: "{{ state_attr('weather.pirateweather', 'ozone') | float(0) }}"

      - name: "Pirate Weather Condition"
        unique_id: pirate_weather_condition
        icon: mdi:weather-partly-cloudy
        state: "{{ states('weather.pirateweather') }}"

      # Daily Forecast - Today
      - name: "Pirate Weather Today High"
        unique_id: pirate_weather_today_high
        unit_of_measurement: "°F"
        device_class: temperature
        icon: mdi:thermometer-chevron-up
        state: >
          {% set forecast = state_attr('weather.pirateweather', 'forecast') %}
          {% if forecast and forecast | length > 0 %}
            {{ forecast[0].temperature | float(0) }}
          {% else %}0{% endif %}

      - name: "Pirate Weather Today Low"
        unique_id: pirate_weather_today_low
        unit_of_measurement: "°F"
        device_class: temperature
        icon: mdi:thermometer-chevron-down
        state: >
          {% set forecast = state_attr('weather.pirateweather', 'forecast') %}
          {% if forecast and forecast | length > 0 %}
            {{ forecast[0].templow | float(0) }}
          {% else %}0{% endif %}

      - name: "Pirate Weather Today Precip Probability"
        unique_id: pirate_weather_today_precip_prob
        unit_of_measurement: "%"
        icon: mdi:weather-rainy
        state: >
          {% set forecast = state_attr('weather.pirateweather', 'forecast') %}
          {% if forecast and forecast | length > 0 %}
            {{ forecast[0].precipitation_probability | float(0) }}
          {% else %}0{% endif %}

      - name: "Pirate Weather Today Condition"
        unique_id: pirate_weather_today_condition
        icon: mdi:calendar-today
        state: >
          {% set forecast = state_attr('weather.pirateweather', 'forecast') %}
          {% if forecast and forecast | length > 0 %}
            {{ forecast[0].condition }}
          {% else %}unknown{% endif %}

      # Tomorrow Forecast
      - name: "Pirate Weather Tomorrow High"
        unique_id: pirate_weather_tomorrow_high
        unit_of_measurement: "°F"
        device_class: temperature
        icon: mdi:thermometer-chevron-up
        state: >
          {% set forecast = state_attr('weather.pirateweather', 'forecast') %}
          {% if forecast and forecast | length > 1 %}
            {{ forecast[1].temperature | float(0) }}
          {% else %}0{% endif %}

      - name: "Pirate Weather Tomorrow Low"
        unique_id: pirate_weather_tomorrow_low
        unit_of_measurement: "°F"
        device_class: temperature
        icon: mdi:thermometer-chevron-down
        state: >
          {% set forecast = state_attr('weather.pirateweather', 'forecast') %}
          {% if forecast and forecast | length > 1 %}
            {{ forecast[1].templow | float(0) }}
          {% else %}0{% endif %}

      - name: "Pirate Weather Tomorrow Precip Probability"
        unique_id: pirate_weather_tomorrow_precip_prob
        unit_of_measurement: "%"
        icon: mdi:weather-rainy
        state: >
          {% set forecast = state_attr('weather.pirateweather', 'forecast') %}
          {% if forecast and forecast | length > 1 %}
            {{ forecast[1].precipitation_probability | float(0) }}
          {% else %}0{% endif %}

      - name: "Pirate Weather Tomorrow Condition"
        unique_id: pirate_weather_tomorrow_condition
        icon: mdi:calendar-arrow-right
        state: >
          {% set forecast = state_attr('weather.pirateweather', 'forecast') %}
          {% if forecast and forecast | length > 1 %}
            {{ forecast[1].condition }}
          {% else %}unknown{% endif %}

      # HDD/CDD Forecast Estimates (using daily high/low average)
      - name: "Pirate Weather HDD Forecast Today"
        unique_id: pirate_weather_hdd_forecast_today
        unit_of_measurement: "HDD"
        icon: mdi:snowflake
        state: >
          {% set forecast = state_attr('weather.pirateweather', 'forecast') %}
          {% if forecast and forecast | length > 0 %}
            {% set high = forecast[0].temperature | float(65) %}
            {% set low = forecast[0].templow | float(35) %}
            {% set avg = (high + low) / 2 %}
            {{ [65 - avg, 0] | max | round(1) }}
          {% else %}0{% endif %}

      - name: "Pirate Weather CDD Forecast Today"
        unique_id: pirate_weather_cdd_forecast_today
        unit_of_measurement: "CDD"
        icon: mdi:sun-thermometer
        state: >
          {% set forecast = state_attr('weather.pirateweather', 'forecast') %}
          {% if forecast and forecast | length > 0 %}
            {% set high = forecast[0].temperature | float(65) %}
            {% set low = forecast[0].templow | float(35) %}
            {% set avg = (high + low) / 2 %}
            {{ [avg - 65, 0] | max | round(1) }}
          {% else %}0{% endif %}

      - name: "Pirate Weather HDD Forecast Tomorrow"
        unique_id: pirate_weather_hdd_forecast_tomorrow
        unit_of_measurement: "HDD"
        icon: mdi:snowflake
        state: >
          {% set forecast = state_attr('weather.pirateweather', 'forecast') %}
          {% if forecast and forecast | length > 1 %}
            {% set high = forecast[1].temperature | float(65) %}
            {% set low = forecast[1].templow | float(35) %}
            {% set avg = (high + low) / 2 %}
            {{ [65 - avg, 0] | max | round(1) }}
          {% else %}0{% endif %}

      # 7-Day HDD Forecast Total
      - name: "Pirate Weather HDD Forecast 7 Day"
        unique_id: pirate_weather_hdd_forecast_7day
        unit_of_measurement: "HDD"
        icon: mdi:snowflake-thermometer
        state: >
          {% set forecast = state_attr('weather.pirateweather', 'forecast') %}
          {% if forecast %}
            {% set ns = namespace(total=0) %}
            {% for day in forecast[:7] %}
              {% set high = day.temperature | float(65) %}
              {% set low = day.templow | float(35) %}
              {% set avg = (high + low) / 2 %}
              {% set ns.total = ns.total + [65 - avg, 0] | max %}
            {% endfor %}
            {{ ns.total | round(1) }}
          {% else %}0{% endif %}

      # Weather Source Indicator
      - name: "Pirate Weather Data Age"
        unique_id: pirate_weather_data_age
        unit_of_measurement: "min"
        icon: mdi:clock-outline
        state: >
          {% set last_changed = states.weather.pirateweather.last_changed %}
          {% if last_changed %}
            {{ ((now() - last_changed).total_seconds() / 60) | round(0) }}
          {% else %}unknown{% endif %}

      # ===============================================================
      # RECOVERY RATE SENSORS - 1F
      # ===============================================================
      - name: "HVAC 1F Recovery Rate Avg"
        unique_id: hvac_1f_recovery_rate_avg
        unit_of_measurement: "min/°F"
        state_class: measurement
        icon: mdi:chart-line-variant
        state: >
          {% set rates = [
            states('input_number.hvac_1f_recovery_rate_1') | float(0),
            states('input_number.hvac_1f_recovery_rate_2') | float(0),
            states('input_number.hvac_1f_recovery_rate_3') | float(0),
            states('input_number.hvac_1f_recovery_rate_4') | float(0),
            states('input_number.hvac_1f_recovery_rate_5') | float(0),
            states('input_number.hvac_1f_recovery_rate_6') | float(0),
            states('input_number.hvac_1f_recovery_rate_7') | float(0)
          ] %}
          {% set valid = rates | select('gt', 0) | list %}
          {{ (valid | sum / valid | count) | round(1) if valid | count > 0 else 0 }}

      - name: "HVAC 1F Recovery Rate Last"
        unique_id: hvac_1f_recovery_rate_last
        unit_of_measurement: "min/°F"
        state_class: measurement
        icon: mdi:clock-fast
        state: "{{ states('input_number.hvac_1f_recovery_rate_1') | float(0) }}"

      - name: "HVAC 1F Recovery Rate Weather Adjusted"
        unique_id: hvac_1f_recovery_rate_weather_adjusted
        unit_of_measurement: "min/°F/ΔT"
        state_class: measurement
        icon: mdi:thermometer-lines
        state: >
          {% set rate = states('input_number.hvac_1f_recovery_rate_1') | float(0) %}
          {% set setback = states('input_number.hvac_1f_recovery_setback_degrees') | float(0) %}
          {% set outdoor = states('input_number.hvac_1f_recovery_outdoor_temp') | float(0) %}
          {% set target = state_attr('climate.tstat_2d884c_lyric_t6_pro_thermostat', 'temperature') | float(68) %}
          {% set delta_t = target - outdoor %}
          {{ (rate / delta_t * 10) | round(2) if delta_t > 0 and rate > 0 else 0 }}

      - name: "HVAC 1F Recovery Rate Std Dev"
        unique_id: hvac_1f_recovery_rate_std_dev
        unit_of_measurement: "min/°F"
        state_class: measurement
        icon: mdi:sigma
        state: >
          {% set rates = [
            states('input_number.hvac_1f_recovery_rate_1') | float(0),
            states('input_number.hvac_1f_recovery_rate_2') | float(0),
            states('input_number.hvac_1f_recovery_rate_3') | float(0),
            states('input_number.hvac_1f_recovery_rate_4') | float(0),
            states('input_number.hvac_1f_recovery_rate_5') | float(0),
            states('input_number.hvac_1f_recovery_rate_6') | float(0),
            states('input_number.hvac_1f_recovery_rate_7') | float(0)
          ] %}
          {% set valid = rates | select('gt', 0) | list %}
          {% if valid | count > 1 %}
            {% set mean = valid | sum / valid | count %}
            {% set variance = namespace(sum=0) %}
            {% for v in valid %}
              {% set variance.sum = variance.sum + ((v - mean) ** 2) %}
            {% endfor %}
            {{ ((variance.sum / (valid | count - 1)) ** 0.5) | round(1) }}
          {% else %}
            0
          {% endif %}

      - name: "HVAC 1F Recovery Rate Upper Bound"
        unique_id: hvac_1f_recovery_rate_upper_bound
        unit_of_measurement: "min/°F"
        state_class: measurement
        icon: mdi:arrow-up-bold
        state: >
          {% set mean = states('sensor.hvac_1f_recovery_rate_avg') | float(0) %}
          {% set stddev = states('sensor.hvac_1f_recovery_rate_std_dev') | float(0) %}
          {{ (mean + (stddev * 2)) | round(1) if mean > 0 else 0 }}

      - name: "HVAC 1F Recovery Rate Data Count"
        unique_id: hvac_1f_recovery_rate_data_count
        unit_of_measurement: "samples"
        state_class: measurement
        icon: mdi:counter
        state: >
          {% set rates = [
            states('input_number.hvac_1f_recovery_rate_1') | float(0),
            states('input_number.hvac_1f_recovery_rate_2') | float(0),
            states('input_number.hvac_1f_recovery_rate_3') | float(0),
            states('input_number.hvac_1f_recovery_rate_4') | float(0),
            states('input_number.hvac_1f_recovery_rate_5') | float(0),
            states('input_number.hvac_1f_recovery_rate_6') | float(0),
            states('input_number.hvac_1f_recovery_rate_7') | float(0)
          ] %}
          {{ rates | select('gt', 0) | list | count }}

      # ===============================================================
      # RECOVERY RATE SENSORS - 2F
      # ===============================================================
      - name: "HVAC 2F Recovery Rate Avg"
        unique_id: hvac_2f_recovery_rate_avg
        unit_of_measurement: "min/°F"
        state_class: measurement
        icon: mdi:chart-line-variant
        state: >
          {% set rates = [
            states('input_number.hvac_2f_recovery_rate_1') | float(0),
            states('input_number.hvac_2f_recovery_rate_2') | float(0),
            states('input_number.hvac_2f_recovery_rate_3') | float(0),
            states('input_number.hvac_2f_recovery_rate_4') | float(0),
            states('input_number.hvac_2f_recovery_rate_5') | float(0),
            states('input_number.hvac_2f_recovery_rate_6') | float(0),
            states('input_number.hvac_2f_recovery_rate_7') | float(0)
          ] %}
          {% set valid = rates | select('gt', 0) | list %}
          {{ (valid | sum / valid | count) | round(1) if valid | count > 0 else 0 }}

      - name: "HVAC 2F Recovery Rate Last"
        unique_id: hvac_2f_recovery_rate_last
        unit_of_measurement: "min/°F"
        state_class: measurement
        icon: mdi:clock-fast
        state: "{{ states('input_number.hvac_2f_recovery_rate_1') | float(0) }}"

      - name: "HVAC 2F Recovery Rate Weather Adjusted"
        unique_id: hvac_2f_recovery_rate_weather_adjusted
        unit_of_measurement: "min/°F/ΔT"
        state_class: measurement
        icon: mdi:thermometer-lines
        state: >
          {% set rate = states('input_number.hvac_2f_recovery_rate_1') | float(0) %}
          {% set setback = states('input_number.hvac_2f_recovery_setback_degrees') | float(0) %}
          {% set outdoor = states('input_number.hvac_2f_recovery_outdoor_temp') | float(0) %}
          {% set target = state_attr('climate.tstat_2d8878_lyric_t6_pro_thermostat', 'temperature') | float(68) %}
          {% set delta_t = target - outdoor %}
          {{ (rate / delta_t * 10) | round(2) if delta_t > 0 and rate > 0 else 0 }}

      - name: "HVAC 2F Recovery Rate Std Dev"
        unique_id: hvac_2f_recovery_rate_std_dev
        unit_of_measurement: "min/°F"
        state_class: measurement
        icon: mdi:sigma
        state: >
          {% set rates = [
            states('input_number.hvac_2f_recovery_rate_1') | float(0),
            states('input_number.hvac_2f_recovery_rate_2') | float(0),
            states('input_number.hvac_2f_recovery_rate_3') | float(0),
            states('input_number.hvac_2f_recovery_rate_4') | float(0),
            states('input_number.hvac_2f_recovery_rate_5') | float(0),
            states('input_number.hvac_2f_recovery_rate_6') | float(0),
            states('input_number.hvac_2f_recovery_rate_7') | float(0)
          ] %}
          {% set valid = rates | select('gt', 0) | list %}
          {% if valid | count > 1 %}
            {% set mean = valid | sum / valid | count %}
            {% set variance = namespace(sum=0) %}
            {% for v in valid %}
              {% set variance.sum = variance.sum + ((v - mean) ** 2) %}
            {% endfor %}
            {{ ((variance.sum / (valid | count - 1)) ** 0.5) | round(1) }}
          {% else %}
            0
          {% endif %}

      - name: "HVAC 2F Recovery Rate Upper Bound"
        unique_id: hvac_2f_recovery_rate_upper_bound
        unit_of_measurement: "min/°F"
        state_class: measurement
        icon: mdi:arrow-up-bold
        state: >
          {% set mean = states('sensor.hvac_2f_recovery_rate_avg') | float(0) %}
          {% set stddev = states('sensor.hvac_2f_recovery_rate_std_dev') | float(0) %}
          {{ (mean + (stddev * 2)) | round(1) if mean > 0 else 0 }}

      - name: "HVAC 2F Recovery Rate Data Count"
        unique_id: hvac_2f_recovery_rate_data_count
        unit_of_measurement: "samples"
        state_class: measurement
        icon: mdi:counter
        state: >
          {% set rates = [
            states('input_number.hvac_2f_recovery_rate_1') | float(0),
            states('input_number.hvac_2f_recovery_rate_2') | float(0),
            states('input_number.hvac_2f_recovery_rate_3') | float(0),
            states('input_number.hvac_2f_recovery_rate_4') | float(0),
            states('input_number.hvac_2f_recovery_rate_5') | float(0),
            states('input_number.hvac_2f_recovery_rate_6') | float(0),
            states('input_number.hvac_2f_recovery_rate_7') | float(0)
          ] %}
          {{ rates | select('gt', 0) | list | count }}

      # === SETBACK EFFICIENCY SENSORS ===
      - name: "HVAC 1F Setback Net Benefit"
        unique_id: hvac_1f_setback_net_benefit
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:scale-balance
        state: >
          {% set overnight = states('input_number.hvac_1f_overnight_efficiency') | float(0) %}
          {% set recovery = states('input_number.hvac_1f_recovery_efficiency') | float(0) %}
          {% set baseline = states('sensor.hvac_runtime_per_hdd_7day') | float(0) %}
          {% if baseline > 0 and overnight > 0 %}
            {{ (baseline - (overnight + recovery)) | round(1) }}
          {% else %}
            0
          {% endif %}
        attributes:
          overnight_efficiency: "{{ states('input_number.hvac_1f_overnight_efficiency') }}"
          recovery_efficiency: "{{ states('input_number.hvac_1f_recovery_efficiency') }}"
          baseline: "{{ states('sensor.hvac_runtime_per_hdd_7day') }}"
          interpretation: >
            {% set benefit = this.state | float(0) %}
            {% set baseline = states('sensor.hvac_runtime_per_hdd_7day') | float(10) %}
            {% set pct = (benefit / baseline * 100) | round(0) if baseline > 0 else 0 %}
            {% if pct > 10 %}Setback saving energy
            {% elif pct < -10 %}Setback costing energy
            {% else %}Marginal benefit{% endif %}

      - name: "HVAC 2F Setback Net Benefit"
        unique_id: hvac_2f_setback_net_benefit
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:scale-balance
        state: >
          {% set overnight = states('input_number.hvac_2f_overnight_efficiency') | float(0) %}
          {% set recovery = states('input_number.hvac_2f_recovery_efficiency') | float(0) %}
          {% set baseline = states('sensor.hvac_runtime_per_hdd_7day') | float(0) %}
          {% if baseline > 0 and overnight > 0 %}
            {{ (baseline - (overnight + recovery)) | round(1) }}
          {% else %}
            0
          {% endif %}
        attributes:
          overnight_efficiency: "{{ states('input_number.hvac_2f_overnight_efficiency') }}"
          recovery_efficiency: "{{ states('input_number.hvac_2f_recovery_efficiency') }}"
          baseline: "{{ states('sensor.hvac_runtime_per_hdd_7day') }}"
          interpretation: >
            {% set benefit = this.state | float(0) %}
            {% set baseline = states('sensor.hvac_runtime_per_hdd_7day') | float(10) %}
            {% set pct = (benefit / baseline * 100) | round(0) if baseline > 0 else 0 %}
            {% if pct > 10 %}Setback saving energy
            {% elif pct < -10 %}Setback costing energy
            {% else %}Marginal benefit{% endif %}

      - name: "HVAC 1F Setback Daily Savings"
        unique_id: hvac_1f_setback_daily_savings
        unit_of_measurement: "$"
        state_class: measurement
        icon: mdi:currency-usd
        state: >
          {% set benefit = states('sensor.hvac_1f_setback_net_benefit') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {% set gas_rate = states('sensor.gas_effective_rate') | float(1.68) %}
          {% set furnace_btu = 60556 %}
          {% set runtime_min_saved = benefit * hdd %}
          {% set runtime_hr_saved = runtime_min_saved / 60 %}
          {% set ccf_saved = (runtime_hr_saved * furnace_btu) / (103700 * 0.95) %}
          {{ (ccf_saved * gas_rate) | round(2) }}
        attributes:
          runtime_saved_min: "{{ (states('sensor.hvac_1f_setback_net_benefit') | float(0) * states('sensor.hvac_hdd65_today') | float(0)) | round(1) }}"
          ccf_saved: >
            {% set benefit = states('sensor.hvac_1f_setback_net_benefit') | float(0) %}
            {% set hdd = states('sensor.hvac_hdd65_today') | float(0) %}
            {{ ((benefit * hdd / 60) * 60556 / (103700 * 0.95)) | round(3) }}

      - name: "HVAC 2F Setback Daily Savings"
        unique_id: hvac_2f_setback_daily_savings
        unit_of_measurement: "$"
        state_class: measurement
        icon: mdi:currency-usd
        state: >
          {% set benefit = states('sensor.hvac_2f_setback_net_benefit') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {% set gas_rate = states('sensor.gas_effective_rate') | float(1.68) %}
          {% set furnace_btu = 60556 %}
          {% set runtime_min_saved = benefit * hdd %}
          {% set runtime_hr_saved = runtime_min_saved / 60 %}
          {% set ccf_saved = (runtime_hr_saved * furnace_btu) / (103700 * 0.95) %}
          {{ (ccf_saved * gas_rate) | round(2) }}
        attributes:
          runtime_saved_min: "{{ (states('sensor.hvac_2f_setback_net_benefit') | float(0) * states('sensor.hvac_hdd65_today') | float(0)) | round(1) }}"
          ccf_saved: >
            {% set benefit = states('sensor.hvac_2f_setback_net_benefit') | float(0) %}
            {% set hdd = states('sensor.hvac_hdd65_today') | float(0) %}
            {{ ((benefit * hdd / 60) * 60556 / (103700 * 0.95)) | round(3) }}

      - name: "HVAC Total Setback Daily Savings"
        unique_id: hvac_total_setback_daily_savings
        unit_of_measurement: "$"
        state_class: measurement
        icon: mdi:piggy-bank
        state: >
          {% set s1 = states('sensor.hvac_1f_setback_daily_savings') | float(0) %}
          {% set s2 = states('sensor.hvac_2f_setback_daily_savings') | float(0) %}
          {{ (s1 + s2) | round(2) }}

      # === CLIMATE NORMS DERIVED SENSORS ===
      - name: "Expected HDD Today"
        unique_id: expected_hdd_today
        unit_of_measurement: "HDD"
        state_class: measurement
        icon: mdi:snowflake-thermometer
        state: >
          {{ state_attr('sensor.climate_norms_today', 'hdd_mean') | float(0) | round(1) }}
        attributes:
          p10: "{{ state_attr('sensor.climate_norms_today', 'hdd_p10') }}"
          p90: "{{ state_attr('sensor.climate_norms_today', 'hdd_p90') }}"
          smoothed: "{{ state_attr('sensor.climate_norms_today', 'hdd_mean_smoothed') }}"

      - name: "Expected CDD Today"
        unique_id: expected_cdd_today
        unit_of_measurement: "CDD"
        state_class: measurement
        icon: mdi:sun-thermometer
        state: >
          {{ state_attr('sensor.climate_norms_today', 'cdd_mean') | float(0) | round(1) }}
        attributes:
          p10: "{{ state_attr('sensor.climate_norms_today', 'cdd_p10') }}"
          p90: "{{ state_attr('sensor.climate_norms_today', 'cdd_p90') }}"

      - name: "Expected Temperature Today"
        unique_id: expected_temperature_today
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {{ state_attr('sensor.climate_norms_today', 'tmean') | float(0) | round(1) }}
        attributes:
          tmin: "{{ state_attr('sensor.climate_norms_today', 'tmin') }}"
          tmax: "{{ state_attr('sensor.climate_norms_today', 'tmax') }}"

      - name: "HDD Deviation Today"
        unique_id: hdd_deviation_today
        unit_of_measurement: "HDD"
        state_class: measurement
        icon: mdi:delta
        state: >
          {% set actual = states('sensor.hvac_hdd65_today') | float(0) %}
          {% set expected = states('sensor.expected_hdd_today') | float(0) %}
          {{ (actual - expected) | round(1) }}
        attributes:
          interpretation: >
            {% set dev = this.state | float(0) %}
            {% if dev > 5 %}Colder than normal
            {% elif dev < -5 %}Milder than normal
            {% else %}Normal{% endif %}

      - name: "Expected Runtime Today"
        unique_id: expected_runtime_today
        unit_of_measurement: "h"
        state_class: measurement
        icon: mdi:timer-outline
        state: >
          {% set expected_hdd = states('sensor.expected_hdd_today') | float(0) %}
          {% set runtime_per_hdd = states('sensor.hvac_runtime_per_hdd_7day') | float(10.6) %}
          {% if expected_hdd > 0 %}
            {{ (expected_hdd * runtime_per_hdd / 60) | round(2) }}
          {% else %}
            0
          {% endif %}

      - name: "Efficiency Deviation Index"
        unique_id: efficiency_deviation_index
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:gauge
        state: >
          {% set actual = states('sensor.hvac_total_heat_runtime_today') | float(0) %}
          {% set expected = states('sensor.expected_runtime_today') | float(0) %}
          {% if expected > 0.1 %}
            {{ ((actual / expected) - 1) * 100 | round(1) }}
          {% else %}
            0
          {% endif %}
        attributes:
          interpretation: >
            {% set dev = this.state | float(0) %}
            {% if dev > 15 %}Working harder than expected
            {% elif dev < -15 %}Outperforming baseline
            {% else %}Normal performance{% endif %}

      - name: "Climate Norms Status"
        unique_id: climate_norms_status
        icon: mdi:cloud-check
        state: >
          {% if states('sensor.climate_norms_today') == 'ok' %}
            OK - Day {{ state_attr('sensor.climate_norms_today', 'day_of_year') }}
          {% else %}
            Error
          {% endif %}

      # === MONTHLY REPORT SENSORS ===
      - name: "Outdoor Temp Mean Month"
        unique_id: outdoor_temp_mean_month
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set temp_sum = states('input_number.outdoor_temp_sum_month') | float(0) %}
          {% set days = states('input_number.outdoor_temp_days_month') | int(0) %}
          {% if days > 0 %}
            {{ (temp_sum / days) | round(1) }}
          {% else %}
            0
          {% endif %}

      - name: "Expected Runtime Month"
        unique_id: expected_runtime_month
        unit_of_measurement: "h"
        state_class: measurement
        icon: mdi:timer-outline
        state: >
          {{ states('input_number.expected_runtime_sum_month') | float(0) | round(2) }}

      - name: "Efficiency Deviation Month"
        unique_id: efficiency_deviation_month
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:gauge
        state: >
          {% set actual = states('sensor.hvac_total_heat_runtime_month') | float(0) %}
          {% set expected = states('input_number.expected_runtime_sum_month') | float(0) %}
          {% if expected > 0.1 %}
            {{ ((actual / expected) - 1) * 100 | round(1) }}
          {% else %}
            0
          {% endif %}

      - name: "Runtime per HDD Month"
        unique_id: runtime_per_hdd_month_calc
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:chart-timeline-variant
        state: >
          {% set runtime = states('sensor.hvac_total_heat_runtime_month') | float(0) %}
          {% set hdd = states('input_number.hdd_cumulative_month_auto') | float(0) %}
          {% if hdd > 0 %}
            {{ ((runtime * 60) / hdd) | round(1) }}
          {% else %}
            0
          {% endif %}

  - binary_sensor:
      # === CLIMATE NORMS ALERTS ===
      - name: "Climate Cold Snap Today"
        unique_id: climate_cold_snap_today
        device_class: cold
        icon: mdi:snowflake-alert
        state: >
          {% set actual_hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {% set p90 = state_attr('sensor.climate_norms_today', 'hdd_p90') | float(0) %}
          {{ actual_hdd > p90 and p90 > 0 }}

      - name: "Climate Adjusted Efficiency Alert"
        unique_id: climate_adjusted_efficiency_alert
        device_class: problem
        icon: mdi:alert-circle
        state: >
          {% set deviation = states('sensor.efficiency_deviation_index') | float(0) %}
          {% set expected_hdd = states('sensor.expected_hdd_today') | float(0) %}
          {% set actual_hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {# Only alert if: deviation > 15%, expected HDD > 20, and actual > expected #}
          {{ deviation > 15 and expected_hdd > 20 and actual_hdd > expected_hdd }}

# ===============================================================
# PLATFORM SENSORS
# ===============================================================
sensor:
  - platform: time_date
    display_options:
      - "time"
      - "date"

  - platform: statistics
    name: "HVAC Outdoor Temp Mean 24h"
    unique_id: hvac_outdoor_temp_mean_24h
    entity_id: sensor.hvac_outdoor_temp_hartford_proxy
    state_characteristic: mean
    max_age:
      hours: 24

  - platform: history_stats
    name: "HVAC 2F Heat Cycles Today"
    unique_id: hvac_2f_heat_cycles_today
    entity_id: binary_sensor.hvac_2f_call_for_heat
    state: "on"
    type: count
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 2F Heat Runtime Today"
    unique_id: hvac_2f_heat_runtime_today
    entity_id: binary_sensor.hvac_2f_call_for_heat
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 1F Heat Cycles Today"
    unique_id: hvac_1f_heat_cycles_today
    entity_id: binary_sensor.hvac_1f_call_for_heat
    state: "on"
    type: count
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 1F Heat Runtime Today"
    unique_id: hvac_1f_heat_runtime_today
    entity_id: binary_sensor.hvac_1f_call_for_heat
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 2F Heat Runtime Week"
    unique_id: hvac_2f_heat_runtime_week
    entity_id: binary_sensor.hvac_2f_call_for_heat
    state: "on"
    type: time
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 1F Heat Runtime Week"
    unique_id: hvac_1f_heat_runtime_week
    entity_id: binary_sensor.hvac_1f_call_for_heat
    state: "on"
    type: time
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 2F Heat Runtime Month"
    unique_id: hvac_2f_heat_runtime_month
    entity_id: binary_sensor.hvac_2f_call_for_heat
    state: "on"
    type: time
    start: "{{ now().replace(day=1, hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 1F Heat Runtime Month"
    unique_id: hvac_1f_heat_runtime_month
    entity_id: binary_sensor.hvac_1f_call_for_heat
    state: "on"
    type: time
    start: "{{ now().replace(day=1, hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  # === ACTUAL FURNACE CYCLES (captures overlapping thermostat calls) ===
  - platform: history_stats
    name: "HVAC Furnace Cycles Today"
    unique_id: hvac_furnace_cycles_today
    entity_id: binary_sensor.hvac_furnace_running
    state: "on"
    type: count
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC Furnace Runtime Today"
    unique_id: hvac_furnace_runtime_today
    entity_id: binary_sensor.hvac_furnace_running
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

# ===============================================================
# CLIMATE NORMS - Daily lookup from historical climate data
# ===============================================================
# Reads climate_daily_norms.csv (18 years of data) to provide
# expected HDD/CDD values for today based on historical averages.
# Updates once daily at startup and midnight.
# ===============================================================

command_line:
  - sensor:
      name: "Climate Norms Today"
      unique_id: climate_norms_today
      command: "python3 /config/scripts/climate_norms_today.py"
      scan_interval: 3600  # Hourly update to ensure day rollover is captured
      value_template: "{{ value_json.status }}"
      json_attributes:
        - day_of_year
        - month
        - day
        - hdd_mean
        - hdd_min
        - hdd_max
        - hdd_p10
        - hdd_p90
        - hdd_mean_smoothed
        - cdd_mean
        - cdd_p10
        - cdd_p90
        - tmean
        - tmin
        - tmax
        - samples
