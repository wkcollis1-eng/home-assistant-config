# ===============================================================
# COMPLETE CONFIGURATION.YAML - ENERGY PERFORMANCE TRACKING
# ===============================================================
# Version: Final with Auto HDD + Live Weather (10 min updates)
#
# INSTRUCTIONS:
# 1. Backup your current configuration.yaml
# 2. Replace ENTIRE contents with this file
# 3. Full restart required (Settings > System > Restart)
# ===============================================================

default_config:

# Shell commands for CSV reports
shell_command:
  testcmd: "echo hello"

  # ===============================================================
  # CSV MANAGEMENT - Python-based (maintainable, validated)
  # ===============================================================
  # Daily HVAC report - appends one row per day
  appenddailycsv: >-
    python3 /config/scripts/csv_manager.py append_daily --data '{
      "date": "{{ now().strftime('%Y-%m-%d') }}",
      "outdoor_high": {{ states('input_number.outdoor_temp_daily_high') | float(0) }},
      "outdoor_low": {{ states('input_number.outdoor_temp_daily_low') | float(0) }},
      "outdoor_mean": {{ ((states('input_number.outdoor_temp_daily_high') | float(0) + states('input_number.outdoor_temp_daily_low') | float(0)) / 2) | round(1) }},
      "hdd65": {{ states('sensor.hvac_hdd65_today') | float(0) }},
      "furnace_runtime_min": {{ (states('sensor.hvac_furnace_runtime_today') | float(0) * 60) }},
      "furnace_cycles": {{ states('sensor.hvac_furnace_cycles_today') | int(0) }},
      "avg_min_per_cycle": {{ states('sensor.hvac_furnace_min_per_cycle') | float(0) }},
      "zone_calls_total": {{ states('sensor.hvac_total_cycles_today') | int(0) }},
      "chaining_index": {{ states('sensor.hvac_chaining_index') | float(1) }},
      "runtime_1f_min": {{ (states('sensor.hvac_1f_heat_runtime_today') | float(0) * 60) }},
      "runtime_2f_min": {{ (states('sensor.hvac_2f_heat_runtime_today') | float(0) * 60) }},
      "basement_dew_point": {{ states('sensor.basement_dew_point') | float(0) }}
    }'

  # Monthly HVAC report - appends one row per month
  appendmonthlycsv: >-
    python3 /config/scripts/csv_manager.py append_monthly --data '{
      "month": "{{ now().strftime('%Y-%m') }}",
      "days": {{ states('input_number.outdoor_temp_days_month') | int(0) }},
      "mean_outdoor_temp": {{ states('sensor.outdoor_temp_mean_month') | float(0) }},
      "total_hdd65": {{ states('input_number.hdd_cumulative_month_auto') | float(0) }},
      "furnace_runtime_hours": {{ states('sensor.hvac_furnace_runtime_month_2') | float(0) }},
      "avg_runtime_per_hdd": {{ states('sensor.hvac_runtime_per_hdd_month') | float(0) }},
      "heating_efficiency_ccf_per_1k_hdd": {{ states('sensor.hvac_heating_efficiency_mtd') | float(0) }},
      "actual_runtime": {{ states('sensor.hvac_furnace_runtime_month_2') | float(0) }},
      "expected_runtime": {{ states('sensor.expected_runtime_month') | float(0) }},
      "efficiency_deviation_pct": {{ states('sensor.efficiency_deviation_month') | float(0) }},
      "gas_usage_ccf": {{ states('input_number.gas_bill_ccf') | float(0) }},
      "gas_cost": {{ states('input_number.gas_bill_amount') | float(0) }},
      "electric_kwh": {{ states('input_number.electricity_bill_kwh') | float(0) }}
    }'

  # Rotate daily CSV at year boundary
  rotatedailycsv: "python3 /config/scripts/csv_manager.py rotate_daily"

  # Zone-specific setback log — positional args, no JSON quoting issues
  appendsetbacklog_1f: >-
    python3 /config/scripts/setback_csv.py 1F
    {{ states('input_number.hvac_1f_hold_setpoint') | float(0) }}
    {{ states('input_number.hvac_1f_setback_setpoint') | float(0) }}
    {{ states('input_number.hvac_1f_recovery_start_temp') | float(0) }}
    {{ states('input_number.hvac_1f_last_recovery_minutes') | float(0) }}
    {{ states('sensor.hvac_outdoor_temp_hartford_proxy') | float(0) }}

  appendsetbacklog_2f: >-
    python3 /config/scripts/setback_csv.py 2F
    {{ states('input_number.hvac_2f_hold_setpoint') | float(0) }}
    {{ states('input_number.hvac_2f_setback_setpoint') | float(0) }}
    {{ states('input_number.hvac_2f_recovery_start_temp') | float(0) }}
    {{ states('input_number.hvac_2f_last_recovery_minutes') | float(0) }}
    {{ states('sensor.hvac_outdoor_temp_hartford_proxy') | float(0) }}

  # Weekly backup of critical input_number values
  backup_input_numbers: >-
    python3 /config/scripts/csv_manager.py backup --data '{
      "hdd_year": {{ states('input_number.hdd_cumulative_year_auto') | float(0) }},
      "hdd_month": {{ states('input_number.hdd_cumulative_month_auto') | float(0) }},
      "cdd_year": {{ states('input_number.cdd_cumulative_year_auto') | float(0) }},
      "cdd_month": {{ states('input_number.cdd_cumulative_month_auto') | float(0) }},
      "filter_hrs": {{ states('input_number.hvac_filter_runtime_hours') | float(0) }},
      "temp_sum": {{ states('input_number.outdoor_temp_sum_month') | float(0) }},
      "temp_days": {{ states('input_number.outdoor_temp_days_month') | int(0) }},
      "expected_runtime": {{ states('input_number.expected_runtime_sum_month') | float(0) }},
      "hdd_d1": {{ states('input_number.hdd_day_1') | float(0) }},
      "hdd_d2": {{ states('input_number.hdd_day_2') | float(0) }},
      "hdd_d3": {{ states('input_number.hdd_day_3') | float(0) }},
      "hdd_d4": {{ states('input_number.hdd_day_4') | float(0) }},
      "hdd_d5": {{ states('input_number.hdd_day_5') | float(0) }},
      "hdd_d6": {{ states('input_number.hdd_day_6') | float(0) }},
      "hdd_d7": {{ states('input_number.hdd_day_7') | float(0) }}
    }'

  # Monthly rotation for setback log (archives previous year)
  rotate_setback_log: "cd /config/reports && for f in hvac_setback_1f.csv hvac_setback_2f.csv; do [ -f $f ] && mv $f ${f%.csv}_$(date -d 'yesterday' +%Y).csv; done"

frontend:
  themes: !include_dir_merge_named themes

# ===============================================================
# RECORDER - Database optimization
# ===============================================================
recorder:
  purge_keep_days: 14
  commit_interval: 2
  exclude:
    entities:
      - sensor.time
      - sensor.date
    entity_globs:
      - sensor.*_signal_level

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

# ===============================================================
# LIVE WEATHER (Updates every 10 minutes)
# ===============================================================
rest:
  - resource: "https://api.open-meteo.com/v1/forecast?latitude=41.28&longitude=-72.81&current=temperature_2m&temperature_unit=fahrenheit"
    scan_interval: 600
    timeout: 30
    sensor:
      - name: "Outdoor Temp Live"
        unique_id: outdoor_temp_live
        value_template: "{{ value_json.current.temperature_2m }}"
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement

# ===============================================================
# PIRATE WEATHER INTEGRATION SENSORS
# ===============================================================
# Note: Requires HACS Pirate Weather integration installed
# The integration creates weather.pirateweather entity automatically

# ===============================================================
# INPUT BUTTONS
# ===============================================================
input_button:
  save_electric_bill:
    name: "Save Electric Bill"
    icon: mdi:content-save-check

  save_gas_bill:
    name: "Save Gas Bill"
    icon: mdi:content-save-check

  reset_filter_runtime:
    name: "Reset Filter Runtime"
    icon: mdi:air-filter

# ===============================================================
# AUTOMATION FAILURE TRACKING
# ===============================================================
counter:
  automation_failures_24h:
    name: "Automation Failures (24h)"
    initial: 0
    step: 1
    icon: mdi:alert-circle

  dehumidifier_cycles_today:
    name: "Dehumidifier Cycles Today"
    initial: 0
    step: 1
    icon: mdi:counter

input_text:
  last_automation_failure:
    name: "Last Automation Failure"
    max: 255
    icon: mdi:alert-circle-outline

# ===============================================================
# INPUT BOOLEAN HELPERS
# ===============================================================
input_boolean:
  hvac_1f_setback_active:
    name: "HVAC 1F Setback Active"
    icon: mdi:thermometer-minus

  hvac_2f_setback_active:
    name: "HVAC 2F Setback Active"
    icon: mdi:thermometer-minus

  hvac_1f_recovering:
    name: "HVAC 1F Recovering"
    icon: mdi:thermometer-plus

  hvac_2f_recovering:
    name: "HVAC 2F Recovering"
    icon: mdi:thermometer-plus

# ===============================================================
# INPUT NUMBER HELPERS
# ===============================================================
input_number:
  # === SYSTEM CONSTANTS ===
  furnace_heating_rate_btu_hr:
    name: Furnace Heating Rate (BTU/hr)
    min: 50000
    max: 100000
    step: 1
    unit_of_measurement: "BTU/hr"
    mode: box
    icon: mdi:fire
    initial: 60556

  building_ua_baseline:
    name: Building UA Baseline
    min: 300
    max: 600
    step: 1
    unit_of_measurement: "BTU/hr-°F"
    mode: box
    icon: mdi:home-thermometer
    initial: 449

  balance_point_baseline:
    name: Balance Point Baseline
    min: 50
    max: 70
    step: 0.5
    unit_of_measurement: "°F"
    mode: box
    icon: mdi:thermometer-lines
    initial: 59

  heating_efficiency_baseline:
    name: Heating Efficiency Baseline (CCF/1k HDD)
    min: 50
    max: 150
    step: 0.1
    unit_of_measurement: "CCF/1k HDD"
    mode: box
    icon: mdi:chart-bell-curve
    initial: 82.6

  annual_hdd_baseline:
    name: Annual HDD Baseline
    min: 4000
    max: 8000
    step: 1
    unit_of_measurement: "HDD"
    mode: box
    icon: mdi:snowflake
    initial: 6270

  annual_electricity_baseline:
    name: Annual Electricity Baseline (kWh)
    min: 4000
    max: 12000
    step: 1
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:flash
    initial: 6730

  annual_gas_baseline:
    name: Annual Gas Baseline (CCF)
    min: 400
    max: 1200
    step: 1
    unit_of_measurement: "CCF"
    mode: box
    icon: mdi:fire
    initial: 787

  site_eui_baseline:
    name: Site EUI Baseline
    min: 30
    max: 70
    step: 0.1
    unit_of_measurement: "kBTU/ft²-yr"
    mode: box
    icon: mdi:home-analytics
    initial: 41.7

  # === DAILY OUTDOOR TEMP TRACKING ===
  outdoor_temp_daily_high:
    name: "Outdoor Temp Daily High"
    min: -50
    max: 150
    step: 0.1
    initial: -50
    unit_of_measurement: "°F"
    mode: box
    icon: mdi:thermometer-chevron-up

  outdoor_temp_daily_low:
    name: "Outdoor Temp Daily Low"
    min: -50
    max: 150
    step: 0.1
    initial: 150
    unit_of_measurement: "°F"
    mode: box
    icon: mdi:thermometer-chevron-down

  # === CURRENT MONTH BILLS ===
  electricity_bill_amount:
    name: "Electricity Bill Amount"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "$"
    mode: box
    icon: mdi:currency-usd

  electricity_bill_kwh:
    name: "Electricity Bill kWh"
    min: 0
    max: 10000
    step: 1
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:lightning-bolt

  electricity_bill_days:
    name: "Electricity Bill Days"
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    mode: box
    icon: mdi:calendar-range

  gas_bill_amount:
    name: "Gas Bill Amount"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "$"
    mode: box
    icon: mdi:currency-usd

  gas_bill_ccf:
    name: "Gas Bill CCF"
    min: 0
    max: 5000
    step: 1
    unit_of_measurement: "CCF"
    mode: box
    icon: mdi:fire

  gas_bill_days:
    name: "Gas Bill Days"
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    mode: box
    icon: mdi:calendar-range

  # === PREVIOUS MONTH ===
  electricity_bill_amount_previous:
    name: "Previous Month Electricity Amount"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "$"
    mode: box

  electricity_bill_kwh_previous:
    name: "Previous Month Electricity kWh"
    min: 0
    max: 10000
    step: 1
    unit_of_measurement: "kWh"
    mode: box

  electricity_bill_days_previous:
    name: "Previous Month Electricity Days"
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    mode: box
    initial: 30

  gas_bill_amount_previous:
    name: "Previous Month Gas Amount"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "$"
    mode: box

  gas_bill_ccf_previous:
    name: "Previous Month Gas CCF"
    min: 0
    max: 5000
    step: 1
    unit_of_measurement: "CCF"
    mode: box

  gas_bill_days_previous:
    name: "Previous Month Gas Days"
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    mode: box
    initial: 30

  # === LAST YEAR SAME MONTH ===
  electricity_bill_amount_last_year:
    name: "Last Year Electricity Amount"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "$"
    mode: box

  electricity_bill_kwh_last_year:
    name: "Last Year Electricity kWh"
    min: 0
    max: 10000
    step: 1
    unit_of_measurement: "kWh"
    mode: box

  electricity_bill_days_last_year:
    name: "Last Year Electricity Days"
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    mode: box
    initial: 30

  gas_bill_amount_last_year:
    name: "Last Year Gas Amount"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "$"
    mode: box

  gas_bill_ccf_last_year:
    name: "Last Year Gas CCF"
    min: 0
    max: 5000
    step: 1
    unit_of_measurement: "CCF"
    mode: box

  gas_bill_days_last_year:
    name: "Last Year Gas Days"
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    mode: box
    initial: 30

  # === 7-DAY ROLLING (Manual backup) ===
  runtime_1f_rolling_7day:
    name: "1F Runtime Rolling 7-Day"
    min: 0
    max: 100
    step: 0.1
    unit_of_measurement: "hours"
    mode: box
    icon: mdi:clock-outline

  runtime_2f_rolling_7day:
    name: "2F Runtime Rolling 7-Day"
    min: 0
    max: 100
    step: 0.1
    unit_of_measurement: "hours"
    mode: box
    icon: mdi:clock-outline

  # ===============================================================
  # AUTO HDD TRACKING - 7-Day Rolling Window
  # ===============================================================
  hdd_day_1:
    name: "HDD Day 1 (Today)"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_2:
    name: "HDD Day 2"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_3:
    name: "HDD Day 3"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_4:
    name: "HDD Day 4"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_5:
    name: "HDD Day 5"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_6:
    name: "HDD Day 6"
    min: 0
    max: 70
    step: 0.1
    mode: box
  hdd_day_7:
    name: "HDD Day 7 (Oldest)"
    min: 0
    max: 70
    step: 0.1
    mode: box

  # === RUNTIME PER HDD DAILY STORAGE (for std dev calculation) ===
  runtime_per_hdd_day_1:
    name: "Runtime/HDD Day 1 (Yesterday)"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_2:
    name: "Runtime/HDD Day 2"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_3:
    name: "Runtime/HDD Day 3"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_4:
    name: "Runtime/HDD Day 4"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_5:
    name: "Runtime/HDD Day 5"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_6:
    name: "Runtime/HDD Day 6"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"
  runtime_per_hdd_day_7:
    name: "Runtime/HDD Day 7 (Oldest)"
    min: 0
    max: 500
    step: 0.1
    mode: box
    unit_of_measurement: "min/HDD"

  hdd_cumulative_month_auto:
    name: "HDD Cumulative Month (Auto)"
    min: 0
    max: 2000
    step: 0.1
    mode: box
    icon: mdi:snowflake-thermometer

  hdd_cumulative_year_auto:
    name: "HDD Cumulative Year (Auto)"
    min: 0
    max: 10000
    step: 0.1
    mode: box
    icon: mdi:snowflake-thermometer

  cdd_cumulative_month_auto:
    name: "CDD Cumulative Month (Auto)"
    min: 0
    max: 1000
    step: 0.1
    mode: box
    icon: mdi:sun-thermometer

  cdd_cumulative_year_auto:
    name: "CDD Cumulative Year (Auto)"
    min: 0
    max: 3000
    step: 0.1
    mode: box
    icon: mdi:sun-thermometer

  # ===============================================================
  # MONTHLY REPORT TRACKING
  # ===============================================================
  outdoor_temp_sum_month:
    name: "Outdoor Temp Sum Month"
    min: -5000
    max: 5000
    step: 0.1
    mode: box
    icon: mdi:thermometer

  outdoor_temp_days_month:
    name: "Outdoor Temp Days Month"
    min: 0
    max: 31
    step: 1
    mode: box
    icon: mdi:calendar-range

  expected_runtime_sum_month:
    name: "Expected Runtime Sum Month"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "h"
    mode: box
    icon: mdi:timer-outline

  # ===============================================================
  # MONTHLY ACCUMULATORS (immune to recorder purge_keep_days)
  # Daily values added at 23:57, reset on 1st of month
  # ===============================================================
  furnace_runtime_month_acc:
    name: "Furnace Runtime Month Accumulated"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "h"
    mode: box
    icon: mdi:fire

  furnace_cycles_month_acc:
    name: "Furnace Cycles Month Accumulated"
    min: 0
    max: 5000
    step: 1
    unit_of_measurement: "cycles"
    mode: box
    icon: mdi:counter

  zone_1f_runtime_month_acc:
    name: "1F Runtime Month Accumulated"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "h"
    mode: box
    icon: mdi:home-floor-1

  zone_2f_runtime_month_acc:
    name: "2F Runtime Month Accumulated"
    min: 0
    max: 1000
    step: 0.01
    unit_of_measurement: "h"
    mode: box
    icon: mdi:home-floor-2

  zone_1f_cycles_month_acc:
    name: "1F Cycles Month Accumulated"
    min: 0
    max: 5000
    step: 1
    unit_of_measurement: "cycles"
    mode: box
    icon: mdi:home-floor-1

  zone_2f_cycles_month_acc:
    name: "2F Cycles Month Accumulated"
    min: 0
    max: 5000
    step: 1
    unit_of_measurement: "cycles"
    mode: box
    icon: mdi:home-floor-2

  # ===============================================================
  # 12-MONTH ARCHIVE - ELECTRIC
  # ===============================================================
  electric_archive_jan_amount:
    name: "Archive: Jan Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_feb_amount:
    name: "Archive: Feb Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_mar_amount:
    name: "Archive: Mar Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_apr_amount:
    name: "Archive: Apr Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_may_amount:
    name: "Archive: May Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_jun_amount:
    name: "Archive: Jun Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_jul_amount:
    name: "Archive: Jul Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_aug_amount:
    name: "Archive: Aug Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_sep_amount:
    name: "Archive: Sep Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_oct_amount:
    name: "Archive: Oct Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_nov_amount:
    name: "Archive: Nov Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  electric_archive_dec_amount:
    name: "Archive: Dec Electric $"
    min: 0
    max: 1000
    step: 0.01
    mode: box

  electric_archive_jan_kwh:
    name: "Archive: Jan Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_feb_kwh:
    name: "Archive: Feb Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_mar_kwh:
    name: "Archive: Mar Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_apr_kwh:
    name: "Archive: Apr Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_may_kwh:
    name: "Archive: May Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_jun_kwh:
    name: "Archive: Jun Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_jul_kwh:
    name: "Archive: Jul Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_aug_kwh:
    name: "Archive: Aug Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_sep_kwh:
    name: "Archive: Sep Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_oct_kwh:
    name: "Archive: Oct Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_nov_kwh:
    name: "Archive: Nov Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box
  electric_archive_dec_kwh:
    name: "Archive: Dec Electric kWh"
    min: 0
    max: 10000
    step: 1
    mode: box

  # ===============================================================
  # 12-MONTH ARCHIVE - GAS
  # ===============================================================
  gas_archive_jan_amount:
    name: "Archive: Jan Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_feb_amount:
    name: "Archive: Feb Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_mar_amount:
    name: "Archive: Mar Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_apr_amount:
    name: "Archive: Apr Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_may_amount:
    name: "Archive: May Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_jun_amount:
    name: "Archive: Jun Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_jul_amount:
    name: "Archive: Jul Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_aug_amount:
    name: "Archive: Aug Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_sep_amount:
    name: "Archive: Sep Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_oct_amount:
    name: "Archive: Oct Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_nov_amount:
    name: "Archive: Nov Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box
  gas_archive_dec_amount:
    name: "Archive: Dec Gas $"
    min: 0
    max: 1000
    step: 0.01
    mode: box

  gas_archive_jan_ccf:
    name: "Archive: Jan Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_feb_ccf:
    name: "Archive: Feb Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_mar_ccf:
    name: "Archive: Mar Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_apr_ccf:
    name: "Archive: Apr Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_may_ccf:
    name: "Archive: May Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_jun_ccf:
    name: "Archive: Jun Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_jul_ccf:
    name: "Archive: Jul Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_aug_ccf:
    name: "Archive: Aug Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_sep_ccf:
    name: "Archive: Sep Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_oct_ccf:
    name: "Archive: Oct Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_nov_ccf:
    name: "Archive: Nov Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box
  gas_archive_dec_ccf:
    name: "Archive: Dec Gas CCF"
    min: 0
    max: 500
    step: 1
    mode: box

  # ===============================================================
  # FILTER TRACKING
  # ===============================================================
  hvac_filter_runtime_hours:
    name: "Filter Runtime Hours"
    min: 0
    max: 2000
    step: 0.01
    unit_of_measurement: "hours"
    mode: box
    icon: mdi:air-filter

  hvac_1f_last_recovery_minutes:
    name: "1F Last Recovery Time"
    min: 0
    max: 300
    step: 1
    unit_of_measurement: "min"
    mode: box
    icon: mdi:clock-end

  hvac_2f_last_recovery_minutes:
    name: "2F Last Recovery Time"
    min: 0
    max: 300
    step: 1
    unit_of_measurement: "min"
    mode: box
    icon: mdi:clock-end

  hvac_1f_recovery_start_temp:
    name: "1F Recovery Start Temp"
    min: 40
    max: 90
    step: 0.1
    unit_of_measurement: "°F"
    mode: box
  hvac_2f_recovery_start_temp:
    name: "2F Recovery Start Temp"
    min: 40
    max: 90
    step: 0.1
    unit_of_measurement: "°F"
    mode: box

  # ===============================================================
  # SETBACK TRACKING - Simplified for empirical data collection
  # ===============================================================
  hvac_1f_hold_setpoint:
    name: "1F Hold Setpoint"
    min: 50
    max: 80
    step: 0.5
    unit_of_measurement: "°F"
    mode: box
  hvac_1f_setback_setpoint:
    name: "1F Setback Setpoint"
    min: 50
    max: 80
    step: 0.5
    unit_of_measurement: "°F"
    mode: box
  hvac_2f_hold_setpoint:
    name: "2F Hold Setpoint"
    min: 50
    max: 80
    step: 0.5
    unit_of_measurement: "°F"
    mode: box
  hvac_2f_setback_setpoint:
    name: "2F Setback Setpoint"
    min: 50
    max: 80
    step: 0.5
    unit_of_measurement: "°F"
    mode: box

  # ===============================================================
  # DEHUMIDIFIER CONTROL
  # ===============================================================
  dehumidifier_dewpoint_threshold:
    name: "Dehumidifier Dew Point Threshold"
    min: 40
    max: 70
    step: 1
    unit_of_measurement: "°F"
    mode: box
    icon: mdi:water-thermometer
    initial: 52

  # --- Dehumidifier Performance Tracking ---
  dehumidifier_cycle_start_dp:
    name: "Dehumidifier Cycle Start Dew Point"
    min: 20
    max: 90
    step: 0.1
    unit_of_measurement: "°F"
    mode: box
    icon: mdi:water-thermometer

  dehumidifier_last_pull_down_rate:
    name: "Dehumidifier Last Pull-Down Rate"
    min: -10
    max: 20
    step: 0.1
    unit_of_measurement: "°F/h"
    mode: box
    icon: mdi:arrow-down-bold

  dehumidifier_last_cycle_minutes:
    name: "Dehumidifier Last Cycle Minutes"
    min: 0
    max: 300
    step: 1
    unit_of_measurement: "min"
    mode: box
    icon: mdi:timer

  dehumidifier_last_hold_hours:
    name: "Dehumidifier Last Hold Hours"
    min: 0
    max: 72
    step: 0.1
    unit_of_measurement: "h"
    mode: box
    icon: mdi:timer-sand

# ===============================================================
# INPUT SELECT
# ===============================================================
input_select:
  dehumidifier_last_stop_reason:
    name: "Dehumidifier Last Stop Reason"
    options:
      - conditions_cleared
      - max_runtime
      - unknown
    initial: unknown
    icon: mdi:information-outline

# ===============================================================
# INPUT DATETIME
# ===============================================================
input_datetime:
  electricity_bill_date:
    name: "Electricity Bill Date"
    has_date: true
    has_time: false
    icon: mdi:calendar-clock

  gas_bill_date:
    name: "Gas Bill Date"
    has_date: true
    has_time: false
    icon: mdi:calendar-clock

  hvac_1f_recovery_start:
    name: "1F Recovery Start Time"
    has_date: true
    has_time: true
    icon: mdi:clock-start

  hvac_2f_recovery_start:
    name: "2F Recovery Start Time"
    has_date: true
    has_time: true

  hvac_1f_setback_start:
    name: "1F Setback Start Time"
    has_date: true
    has_time: true
    icon: mdi:clock-start

  hvac_2f_setback_start:
    name: "2F Setback Start Time"
    has_date: true
    has_time: true
    icon: mdi:clock-start

  # --- Dehumidifier Performance Tracking ---
  dehumidifier_cycle_start_time:
    name: "Dehumidifier Cycle Start Time"
    has_date: true
    has_time: true
    icon: mdi:clock-start

  dehumidifier_last_cycle_end_time:
    name: "Dehumidifier Last Cycle End Time"
    has_date: true
    has_time: true
    icon: mdi:clock-end

  hvac_filter_last_changed:
    name: "Filter Last Changed"
    has_date: true
    has_time: false
    icon: mdi:calendar-clock

  # ===============================================================
  # CAPTURE HEALTH TRACKING
  # ===============================================================
  hdd_capture_last_ok:
    name: "HDD Capture Last OK"
    has_date: true
    has_time: true
    icon: mdi:check-circle

  runtime_per_hdd_capture_last_ok:
    name: "Runtime/HDD Capture Last OK"
    has_date: true
    has_time: true
    icon: mdi:check-circle

  monthly_tracking_capture_last_ok:
    name: "Monthly Tracking Capture Last OK"
    has_date: true
    has_time: true
    icon: mdi:check-circle

# ===============================================================
# TEMPLATE SENSORS
# ===============================================================
template:
  - binary_sensor:
      - name: "HVAC 2F Call For Heat"
        unique_id: hvac_2f_call_for_heat
        state: >
          {% if states('climate.tstat_2d8878_lyric_t6_pro_thermostat') not in ['unavailable', 'unknown'] %}
            {{ state_attr('climate.tstat_2d8878_lyric_t6_pro_thermostat', 'hvac_action') == 'heating' }}
          {% else %}
            false
          {% endif %}

      - name: "HVAC 1F Call For Heat"
        unique_id: hvac_1f_call_for_heat
        state: >
          {% if states('climate.tstat_2d884c_lyric_t6_pro_thermostat') not in ['unavailable', 'unknown'] %}
            {{ state_attr('climate.tstat_2d884c_lyric_t6_pro_thermostat', 'hvac_action') == 'heating' }}
          {% else %}
            false
          {% endif %}

      # Furnace Running - ON when EITHER zone is calling for heat (actual furnace cycles)
      - name: "HVAC Furnace Running"
        unique_id: hvac_furnace_running
        device_class: running
        state: >
          {{ is_state('binary_sensor.hvac_1f_call_for_heat', 'on') or
             is_state('binary_sensor.hvac_2f_call_for_heat', 'on') }}

      - name: "HVAC Efficiency Alert"
        unique_id: hvac_efficiency_alert
        device_class: problem
        state: >
          {% set efficiency = states('sensor.hvac_heating_efficiency_mtd') | float(0) %}
          {% set baseline = states('input_number.heating_efficiency_baseline') | float(82.6) %}
          {{ efficiency > (baseline * 1.10) and efficiency > 0 }}

      - name: "HVAC UA Degradation Alert"
        unique_id: hvac_ua_degradation_alert
        device_class: problem
        state: >
          {% set ua = states('sensor.hvac_building_load_ua_estimate') | float(449) %}
          {% set baseline = states('input_number.building_ua_baseline') | float(449) %}
          {{ ua > (baseline * 1.10) }}

      - name: "HVAC Short Cycling Alert 1F"
        unique_id: hvac_short_cycling_alert_1f
        device_class: problem
        state: >
          {% set runtime = states('sensor.hvac_1f_heat_runtime_today') | float(0) %}
          {% set cycles = states('sensor.hvac_1f_heat_cycles_today') | int(0) %}
          {% if cycles > 3 and runtime > 0 %}
            {{ ((runtime * 60) / cycles) < 5 }}
          {% else %}
            false
          {% endif %}

      - name: "HVAC Short Cycling Alert 2F"
        unique_id: hvac_short_cycling_alert_2f
        device_class: problem
        state: >
          {% set runtime = states('sensor.hvac_2f_heat_runtime_today') | float(0) %}
          {% set cycles = states('sensor.hvac_2f_heat_cycles_today') | int(0) %}
          {% if cycles > 3 and runtime > 0 %}
            {{ ((runtime * 60) / cycles) < 5 }}
          {% else %}
            false
          {% endif %}

      - name: "Baseline Deviation Alert"
        unique_id: baseline_deviation_alert
        device_class: problem
        state: >
          {% set eui_current = states('sensor.site_eui_estimate') | float(0) %}
          {% set eui_baseline = states('input_number.site_eui_baseline') | float(42.9) %}
          {{ eui_current > (eui_baseline * 1.05) and eui_current > 0 }}

      - name: "Dehumidifier Should Run"
        unique_id: dehumidifier_should_run
        availability: >
          {% set temp = states('sensor.shelly_temperature_humidity_temperature') %}
          {% set dp = states('sensor.basement_dew_point') %}
          {% set threshold = states('input_number.dehumidifier_dewpoint_threshold') %}
          {{ is_number(temp) and is_number(dp) and is_number(threshold) }}
        state: >
          {% set temp = states('sensor.shelly_temperature_humidity_temperature') | float %}
          {% set dp = states('sensor.basement_dew_point') | float %}
          {% set threshold = states('input_number.dehumidifier_dewpoint_threshold') | float %}
          {{ temp > 60 and dp > threshold }}

      - name: "HVAC Filter Change Alert"
        unique_id: hvac_filter_change_alert
        device_class: problem
        state: >
          {{ states('input_number.hvac_filter_runtime_hours') | float(0) >= 1000 }}

      - name: "HVAC Runtime per HDD High Alert"
        unique_id: hvac_runtime_per_hdd_high_alert
        device_class: problem
        state: >
          {% set current = states('sensor.hvac_runtime_per_hdd_7_day_2') | float(0) %}
          {% set upper = states('sensor.hvac_runtime_per_hdd_upper_bound_1s') | float(0) %}
          {% set count = states('sensor.hvac_runtime_per_hdd_data_count') | int(0) %}
          {{ current > upper and upper > 0 and count >= 4 }}

      - name: "HVAC Runtime per HDD Low Alert"
        unique_id: hvac_runtime_per_hdd_low_alert
        device_class: problem
        state: >
          {% set current = states('sensor.hvac_runtime_per_hdd_7_day_2') | float(0) %}
          {% set lower = states('sensor.hvac_runtime_per_hdd_lower_bound_1s') | float(0) %}
          {% set count = states('sensor.hvac_runtime_per_hdd_data_count') | int(0) %}
          {{ current < lower and current > 0 and count >= 4 }}

      # ===============================================================
      # CAPTURE HEALTH MONITORING
      # ===============================================================
      - name: "HDD Capture Stale"
        unique_id: hdd_capture_stale
        device_class: problem
        state: >
          {% set last_ok = states('input_datetime.hdd_capture_last_ok') %}
          {% if last_ok in ['unknown', 'unavailable'] or last_ok == '1970-01-01 00:00:00' %}
            true
          {% else %}
            {% set dt = last_ok | as_datetime | as_local %}
            {{ (now() - dt).total_seconds() > 90000 }}
          {% endif %}

      - name: "Runtime per HDD Capture Stale"
        unique_id: runtime_per_hdd_capture_stale
        device_class: problem
        state: >
          {% set last_ok = states('input_datetime.runtime_per_hdd_capture_last_ok') %}
          {% if last_ok in ['unknown', 'unavailable'] or last_ok == '1970-01-01 00:00:00' %}
            true
          {% else %}
            {% set dt = last_ok | as_datetime | as_local %}
            {{ (now() - dt).total_seconds() > 90000 }}
          {% endif %}

      - name: "Monthly Report Stale"
        unique_id: monthly_report_stale
        device_class: problem
        state: >
          {# Alert if we're past day 1 of a new month and last capture was in a previous month #}
          {% set last = states('input_datetime.monthly_tracking_capture_last_ok') %}
          {% if last in ['unknown', 'unavailable', '1970-01-01 00:00:00'] %}
            false
          {% else %}
            {% set last_dt = last | as_datetime | as_local %}
            {% set last_month = last_dt.month %}
            {% set current_month = now().month %}
            {# Stale if: past day 1 AND last capture was in a different month #}
            {{ now().day > 1 and last_month != current_month }}
          {% endif %}

  - sensor:
      # Uses live feed first (10 min updates), then Pirate Weather, then NWS/Open-Meteo
      # FAIL-FAST: Returns unavailable if ALL sources fail (no silent 35°F default)
      - name: "HVAC Outdoor Temp Hartford Proxy"
        unique_id: hvac_outdoor_temp_hartford_proxy
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        availability: >
          {% set live_state = states('sensor.outdoor_temp_live') %}
          {% set live = live_state | float(-999) %}
          {% set pw = state_attr('weather.pirateweather', 'temperature') %}
          {% set nws = state_attr('weather.local_weather_2','temperature') %}
          {% set om = state_attr('weather.home','temperature') %}
          {{ (live_state not in ['unknown', 'unavailable'] and live > -50) or
             (pw is number and pw > -50) or
             (nws is number and nws > -50) or
             (om is number and om > -50) }}
        state: >
          {% set live_state = states('sensor.outdoor_temp_live') %}
          {% set live = live_state | float(-999) %}
          {% set pw = state_attr('weather.pirateweather', 'temperature') %}
          {% set nws = state_attr('weather.local_weather_2','temperature') %}
          {% set om = state_attr('weather.home','temperature') %}
          {% if live_state not in ['unknown', 'unavailable'] and live > -50 %}
            {{ live | round(1) }}
          {% elif pw is number and pw > -50 %}
            {{ pw | round(1) }}
          {% elif nws is number and nws > -50 %}
            {{ nws | round(1) }}
          {% elif om is number and om > -50 %}
            {{ om | round(1) }}
          {% endif %}

      - name: "HVAC Outdoor Weather Source"
        unique_id: hvac_outdoor_weather_source
        # Reports actual source being used, or "No valid source" when all fail
        state: >
          {% set live_state = states('sensor.outdoor_temp_live') %}
          {% set live = live_state | float(-999) %}
          {% set pw = state_attr('weather.pirateweather', 'temperature') %}
          {% set nws = state_attr('weather.local_weather_2','temperature') %}
          {% set om = state_attr('weather.home','temperature') %}
          {% if live_state not in ['unknown', 'unavailable'] and live > -50 %}Live API (10min)
          {% elif pw is number and pw > -50 %}Pirate Weather
          {% elif nws is number and nws > -50 %}NWS/NOAA
          {% elif om is number and om > -50 %}Open-Meteo
          {% else %}No valid source{% endif %}

      - name: "HVAC HDD65 Today"
        unique_id: hvac_hdd65_today
        unit_of_measurement: "HDD"
        state_class: measurement
        icon: mdi:snowflake
        # Unavailable if outdoor temp proxy is unavailable (fail-fast)
        availability: >
          {{ states('sensor.hvac_outdoor_temp_hartford_proxy') not in ['unknown', 'unavailable'] }}
        state: >
          {% set mean_raw = states('sensor.hvac_outdoor_temp_mean_24h') %}
          {% set mean_t = mean_raw | float(none) if mean_raw not in ['unknown', 'unavailable'] else none %}
          {% set proxy = states('sensor.hvac_outdoor_temp_hartford_proxy') %}
          {% set cur_t = proxy | float(none) if proxy not in ['unknown', 'unavailable'] else none %}
          {% set t = mean_t if mean_t is not none else cur_t %}
          {% if t is not none %}
            {{ [65 - t, 0] | max | round(1) }}
          {% endif %}

      - name: "HVAC CDD65 Today"
        unique_id: hvac_cdd65_today
        unit_of_measurement: "CDD"
        state_class: measurement
        icon: mdi:sun-thermometer
        # Unavailable if outdoor temp proxy is unavailable (fail-fast)
        availability: >
          {{ states('sensor.hvac_outdoor_temp_hartford_proxy') not in ['unknown', 'unavailable'] }}
        state: >
          {% set mean_raw = states('sensor.hvac_outdoor_temp_mean_24h') %}
          {% set mean_t = mean_raw | float(none) if mean_raw not in ['unknown', 'unavailable'] else none %}
          {% set proxy = states('sensor.hvac_outdoor_temp_hartford_proxy') %}
          {% set cur_t = proxy | float(none) if proxy not in ['unknown', 'unavailable'] else none %}
          {% set t = mean_t if mean_t is not none else cur_t %}
          {% if t is not none %}
            {{ [t - 65, 0] | max | round(1) }}
          {% endif %}

      - name: "HDD Rolling 7-Day Auto"
        unique_id: hdd_rolling_7_day_auto
        unit_of_measurement: "HDD"
        state_class: measurement
        icon: mdi:snowflake-thermometer
        # Validates each day slot is within valid range (0-65), excludes corrupt values
        state: >
          {% set days = [
            states('input_number.hdd_day_1') | float(-1),
            states('input_number.hdd_day_2') | float(-1),
            states('input_number.hdd_day_3') | float(-1),
            states('input_number.hdd_day_4') | float(-1),
            states('input_number.hdd_day_5') | float(-1),
            states('input_number.hdd_day_6') | float(-1),
            states('input_number.hdd_day_7') | float(-1)
          ] %}
          {% set valid = days | select('>=', 0) | select('<=', 65) | list %}
          {{ valid | sum | round(1) }}

      # --- Tier 1 Data Integrity: HDD Coverage ---
      - name: "HDD Valid Days 7d"
        unique_id: hdd_valid_days_7d
        unit_of_measurement: "days"
        state_class: measurement
        icon: mdi:calendar-check
        state: >
          {% set days = [
            states('input_number.hdd_day_1') | float(-1),
            states('input_number.hdd_day_2') | float(-1),
            states('input_number.hdd_day_3') | float(-1),
            states('input_number.hdd_day_4') | float(-1),
            states('input_number.hdd_day_5') | float(-1),
            states('input_number.hdd_day_6') | float(-1),
            states('input_number.hdd_day_7') | float(-1)
          ] %}
          {# Count slots with valid HDD values (0-65 range, -1 = uninitialized) #}
          {{ days | select('>=', 0) | select('<=', 65) | list | count }}

      - name: "HVAC HDD65 Cumulative Month"
        unique_id: hvac_hdd65_cumulative_month
        unit_of_measurement: "HDD"
        state_class: total
        icon: mdi:snowflake-thermometer
        state: >
          {% set auto = states('input_number.hdd_cumulative_month_auto') | float(0) %}
          {% set today = states('sensor.hvac_hdd65_today') | float(0) %}
          {{ (auto + today) | round(1) }}

      - name: "HVAC HDD65 Cumulative Year"
        unique_id: hvac_hdd65_cumulative_year
        unit_of_measurement: "HDD"
        state_class: total
        icon: mdi:snowflake-thermometer
        state: >
          {% set auto = states('input_number.hdd_cumulative_year_auto') | float(0) %}
          {% set today = states('sensor.hvac_hdd65_today') | float(0) %}
          {{ (auto + today) | round(1) }}

      - name: "HVAC Total Heat Runtime Today"
        unique_id: hvac_total_heat_runtime_today
        unit_of_measurement: "h"
        state_class: measurement
        state: >
          {% set r1 = states('sensor.hvac_1f_heat_runtime_today') | float(0) %}
          {% set r2 = states('sensor.hvac_2f_heat_runtime_today') | float(0) %}
          {{ (r1 + r2) | round(2) }}

      # Uses furnace runtime (not sum of zone calls) for accurate efficiency metric
      - name: "HVAC Total Runtime per HDD Today"
        unique_id: hvac_total_runtime_per_hdd_today
        unit_of_measurement: "min/HDD"
        state_class: measurement
        state: >
          {% set runtime = states('sensor.hvac_furnace_runtime_today') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {{ ((runtime * 60) / hdd) | round(1) if hdd > 0 else 0 }}

      - name: "HVAC 1F Runtime per HDD Today"
        unique_id: hvac_1f_runtime_per_hdd_today
        unit_of_measurement: "min/HDD"
        state_class: measurement
        state: >
          {% set runtime = states('sensor.hvac_1f_heat_runtime_today') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {{ ((runtime * 60) / hdd) | round(1) if hdd > 0 else 0 }}

      - name: "HVAC 2F Runtime per HDD Today"
        unique_id: hvac_2f_runtime_per_hdd_today
        unit_of_measurement: "min/HDD"
        state_class: measurement
        state: >
          {% set runtime = states('sensor.hvac_2f_heat_runtime_today') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {{ ((runtime * 60) / hdd) | round(1) if hdd > 0 else 0 }}

      - name: "HVAC Total Cycles Today"
        unique_id: hvac_total_cycles_today
        unit_of_measurement: "cycles"
        state_class: measurement
        state: >
          {{ states('sensor.hvac_1f_heat_cycles_today') | int(0) + states('sensor.hvac_2f_heat_cycles_today') | int(0) }}

      # Actual furnace min/cycle - captures overlapping thermostat calls as single cycle
      - name: "HVAC Furnace Min per Cycle"
        unique_id: hvac_furnace_min_per_cycle
        unit_of_measurement: "min/cycle"
        state_class: measurement
        icon: mdi:timer-cog
        state: >
          {% set runtime = states('sensor.hvac_furnace_runtime_today') | float(0) %}
          {% set cycles = states('sensor.hvac_furnace_cycles_today') | int(0) %}
          {% if cycles > 0 and runtime > 0 %}
            {{ ((runtime * 60) / cycles) | round(1) }}
          {% else %}
            0
          {% endif %}

      - name: "HVAC Chaining Index"
        unique_id: hvac_chaining_index
        state_class: measurement
        icon: mdi:link-variant
        state: >
          {% set zone_calls = states('sensor.hvac_1f_heat_cycles_today') | int(0) + states('sensor.hvac_2f_heat_cycles_today') | int(0) %}
          {% set furnace_cycles = states('sensor.hvac_furnace_cycles_today') | int(0) %}
          {% if furnace_cycles > 0 %}
            {{ (zone_calls / furnace_cycles) | round(2) }}
          {% else %}
            1.0
          {% endif %}

      - name: "HVAC Zone Overlap Today"
        unique_id: hvac_zone_overlap_today
        unit_of_measurement: "min"
        state_class: measurement
        icon: mdi:set-center
        availability: >
          {{ states('sensor.hvac_total_heat_runtime_today') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_furnace_runtime_today') not in ['unknown', 'unavailable'] }}
        state: >
          {% set total_min = states('sensor.hvac_total_heat_runtime_today') | float(0) * 60 %}
          {% set furnace_min = states('sensor.hvac_furnace_runtime_today') | float(0) * 60 %}
          {{ [total_min - furnace_min, 0] | max | round(1) }}

      - name: "HVAC Zone Overlap Percent"
        unique_id: hvac_zone_overlap_percent
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:percent
        availability: >
          {{ states('sensor.hvac_total_heat_runtime_today') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_furnace_runtime_today') not in ['unknown', 'unavailable'] }}
        state: >
          {% set total_min = states('sensor.hvac_total_heat_runtime_today') | float(0) * 60 %}
          {% set furnace_min = states('sensor.hvac_furnace_runtime_today') | float(0) * 60 %}
          {% set overlap_min = [total_min - furnace_min, 0] | max %}
          {% if furnace_min > 0 %}
            {{ (overlap_min / furnace_min * 100) | round(1) }}
          {% else %}
            0
          {% endif %}

      # === WEEK METRICS ===
      - name: "HVAC Total Cycles Week"
        unique_id: hvac_total_cycles_week
        unit_of_measurement: "cycles"
        state_class: measurement
        state: >
          {{ states('sensor.hvac_1f_heat_cycles_week') | int(0) + states('sensor.hvac_2f_heat_cycles_week') | int(0) }}

      - name: "HVAC Chaining Index Week"
        unique_id: hvac_chaining_index_week
        state_class: measurement
        icon: mdi:link-variant
        state: >
          {% set zone_calls = states('sensor.hvac_1f_heat_cycles_week') | int(0) + states('sensor.hvac_2f_heat_cycles_week') | int(0) %}
          {% set furnace_cycles = states('sensor.hvac_furnace_cycles_week') | int(0) %}
          {% if furnace_cycles > 0 %}
            {{ (zone_calls / furnace_cycles) | round(2) }}
          {% else %}
            1.0
          {% endif %}

      - name: "HVAC Zone Overlap Week"
        unique_id: hvac_zone_overlap_week
        unit_of_measurement: "min"
        state_class: measurement
        icon: mdi:set-center
        availability: >
          {{ states('sensor.hvac_total_heat_runtime_week') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_furnace_runtime_week') not in ['unknown', 'unavailable'] }}
        state: >
          {% set total_min = states('sensor.hvac_total_heat_runtime_week') | float(0) * 60 %}
          {% set furnace_min = states('sensor.hvac_furnace_runtime_week') | float(0) * 60 %}
          {{ [total_min - furnace_min, 0] | max | round(1) }}

      - name: "HVAC Furnace Cycles per Day Week"
        unique_id: hvac_furnace_cycles_per_day_week
        unit_of_measurement: "cycles/day"
        state_class: measurement
        icon: mdi:counter
        state: >
          {% set cycles = states('sensor.hvac_furnace_cycles_week') | int(0) %}
          {{ (cycles / 7) | round(1) }}

      - name: "HVAC Furnace Min per Cycle Week"
        unique_id: hvac_furnace_min_per_cycle_week
        unit_of_measurement: "min/cycle"
        state_class: measurement
        icon: mdi:timer-cog
        state: >
          {% set runtime = states('sensor.hvac_furnace_runtime_week') | float(0) %}
          {% set cycles = states('sensor.hvac_furnace_cycles_week') | int(0) %}
          {% if cycles > 0 and runtime > 0 %}
            {{ ((runtime * 60) / cycles) | round(1) }}
          {% else %}
            0
          {% endif %}

      # === MONTH METRICS ===
      - name: "HVAC Total Cycles Month"
        unique_id: hvac_total_cycles_month
        unit_of_measurement: "cycles"
        state_class: measurement
        availability: >
          {{ states('sensor.hvac_1f_heat_cycles_month_2') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_2f_heat_cycles_month_2') not in ['unknown', 'unavailable'] }}
        state: >
          {{ states('sensor.hvac_1f_heat_cycles_month_2') | int(0) + states('sensor.hvac_2f_heat_cycles_month_2') | int(0) }}

      - name: "HVAC Chaining Index Month"
        unique_id: hvac_chaining_index_month
        state_class: measurement
        icon: mdi:link-variant
        availability: >
          {{ states('sensor.hvac_1f_heat_cycles_month_2') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_2f_heat_cycles_month_2') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_furnace_cycles_month_2') not in ['unknown', 'unavailable'] }}
        state: >
          {% set zone_calls = states('sensor.hvac_1f_heat_cycles_month_2') | int(0) + states('sensor.hvac_2f_heat_cycles_month_2') | int(0) %}
          {% set furnace_cycles = states('sensor.hvac_furnace_cycles_month_2') | int(0) %}
          {% if furnace_cycles > 0 %}
            {{ (zone_calls / furnace_cycles) | round(2) }}
          {% else %}
            1.0
          {% endif %}

      - name: "HVAC Zone Overlap Month"
        unique_id: hvac_zone_overlap_month
        unit_of_measurement: "min"
        state_class: measurement
        icon: mdi:set-center
        availability: >
          {{ states('sensor.hvac_total_heat_runtime_month') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_furnace_runtime_month_2') not in ['unknown', 'unavailable'] }}
        state: >
          {% set total_min = states('sensor.hvac_total_heat_runtime_month') | float(0) * 60 %}
          {% set furnace_min = states('sensor.hvac_furnace_runtime_month_2') | float(0) * 60 %}
          {{ [total_min - furnace_min, 0] | max | round(1) }}

      - name: "HVAC Furnace Cycles per Day Month"
        unique_id: hvac_furnace_cycles_per_day_month
        unit_of_measurement: "cycles/day"
        state_class: measurement
        icon: mdi:counter
        availability: >
          {{ states('sensor.hvac_furnace_cycles_month_2') not in ['unknown', 'unavailable'] }}
        state: >
          {% set cycles = states('sensor.hvac_furnace_cycles_month_2') | int(0) %}
          {% set days = now().day %}
          {{ (cycles / days) | round(1) if days > 0 else 0 }}

      - name: "HVAC Furnace Min per Cycle Month"
        unique_id: hvac_furnace_min_per_cycle_month
        unit_of_measurement: "min/cycle"
        state_class: measurement
        icon: mdi:timer-cog
        availability: >
          {{ states('sensor.hvac_furnace_runtime_month_2') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_furnace_cycles_month_2') not in ['unknown', 'unavailable'] }}
        state: >
          {% set runtime = states('sensor.hvac_furnace_runtime_month_2') | float(0) %}
          {% set cycles = states('sensor.hvac_furnace_cycles_month_2') | int(0) %}
          {% if cycles > 0 and runtime > 0 %}
            {{ ((runtime * 60) / cycles) | round(1) }}
          {% else %}
            0
          {% endif %}

      - name: "HVAC Zone Balance Ratio Today"
        unique_id: hvac_zone_balance_ratio_today
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set r1 = states('sensor.hvac_1f_heat_runtime_today') | float(0) %}
          {% set r2 = states('sensor.hvac_2f_heat_runtime_today') | float(0) %}
          {% set total = r1 + r2 %}
          {{ ((r2 / total) * 100) | round(1) if total > 0 else 50 }}

      - name: "HVAC Zone Balance Status"
        unique_id: hvac_zone_balance_status
        state: >
          {% set ratio = states('sensor.hvac_zone_balance_ratio_today') | float(50) %}
          {% if ratio >= 45 and ratio <= 65 %}Balanced
          {% elif ratio > 65 %}2F Heavy
          {% else %}1F Heavy{% endif %}

      - name: "HVAC Total Heat Runtime Week"
        unique_id: hvac_total_heat_runtime_week
        unit_of_measurement: "h"
        state_class: measurement
        state: >
          {{ (states('sensor.hvac_1f_heat_runtime_week') | float(0) + states('sensor.hvac_2f_heat_runtime_week') | float(0)) | round(2) }}

      - name: "HVAC Zone Balance Week"
        unique_id: hvac_zone_balance_week
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set r1 = states('sensor.hvac_1f_heat_runtime_week') | float(0) %}
          {% set r2 = states('sensor.hvac_2f_heat_runtime_week') | float(0) %}
          {% set total = r1 + r2 %}
          {{ ((r2 / total) * 100) | round(1) if total > 0 else 50 }}

      # Uses furnace runtime (not sum of zone calls) for accurate efficiency metric
      - name: "HVAC Runtime per HDD 7-Day"
        unique_id: hvac_runtime_per_hdd_7day
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:chart-line
        state: >
          {% set runtime = states('sensor.hvac_furnace_runtime_week') | float(0) %}
          {% set hdd = states('sensor.hdd_rolling_7_day_auto_2') | float(0) %}
          {{ ((runtime * 60) / hdd) | round(1) if hdd > 0 else 0 }}

      # === RUNTIME PER HDD STATISTICS (for control chart boundaries) ===
      - name: "HVAC Runtime per HDD 7-Day Mean"
        unique_id: hvac_runtime_per_hdd_7day_mean
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:chart-bell-curve
        # Validates each day slot is within valid range (0-120), excludes corrupt values
        state: >
          {% set days = [
            states('input_number.runtime_per_hdd_day_1') | float(-1),
            states('input_number.runtime_per_hdd_day_2') | float(-1),
            states('input_number.runtime_per_hdd_day_3') | float(-1),
            states('input_number.runtime_per_hdd_day_4') | float(-1),
            states('input_number.runtime_per_hdd_day_5') | float(-1),
            states('input_number.runtime_per_hdd_day_6') | float(-1),
            states('input_number.runtime_per_hdd_day_7') | float(-1)
          ] %}
          {% set valid = days | select('>', 0) | select('<=', 120) | list %}
          {% if valid | length > 0 %}
            {{ (valid | sum / valid | length) | round(1) }}
          {% else %}
            10.6
          {% endif %}

      - name: "HVAC Runtime per HDD 7-Day Std Dev"
        unique_id: hvac_runtime_per_hdd_7day_stddev
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:sigma
        # Validates each day slot is within valid range (0-120), excludes corrupt values
        state: >
          {% set days = [
            states('input_number.runtime_per_hdd_day_1') | float(-1),
            states('input_number.runtime_per_hdd_day_2') | float(-1),
            states('input_number.runtime_per_hdd_day_3') | float(-1),
            states('input_number.runtime_per_hdd_day_4') | float(-1),
            states('input_number.runtime_per_hdd_day_5') | float(-1),
            states('input_number.runtime_per_hdd_day_6') | float(-1),
            states('input_number.runtime_per_hdd_day_7') | float(-1)
          ] %}
          {% set valid = days | select('>', 0) | select('<=', 120) | list %}
          {% if valid | length > 1 %}
            {% set mean = valid | sum / valid | length %}
            {% set variance = namespace(sum=0) %}
            {% for v in valid %}
              {% set variance.sum = variance.sum + ((v - mean) ** 2) %}
            {% endfor %}
            {{ ((variance.sum / (valid | length - 1)) ** 0.5) | round(1) }}
          {% else %}
            1.1
          {% endif %}

      - name: "HVAC Runtime per HDD Upper Bound"
        unique_id: hvac_runtime_per_hdd_upper_bound
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:arrow-up-bold
        state: >
          {% set mean = states('sensor.hvac_runtime_per_hdd_7_day_mean_2') | float(10) %}
          {% set stddev = states('sensor.hvac_runtime_per_hdd_7_day_std_dev_2') | float(2) %}
          {{ (mean + (stddev * 2)) | round(1) }}

      - name: "HVAC Runtime per HDD Lower Bound"
        unique_id: hvac_runtime_per_hdd_lower_bound
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:arrow-down-bold
        state: >
          {% set mean = states('sensor.hvac_runtime_per_hdd_7_day_mean_2') | float(10) %}
          {% set stddev = states('sensor.hvac_runtime_per_hdd_7_day_std_dev_2') | float(2) %}
          {% set lower = mean - (stddev * 2) %}
          {{ lower | round(1) if lower > 0 else 0 }}

      - name: "HVAC Runtime per HDD Data Count"
        unique_id: hvac_runtime_per_hdd_data_count
        unit_of_measurement: "samples"
        state_class: measurement
        icon: mdi:counter
        # Counts only valid values (0-120 range)
        state: >
          {% set days = [
            states('input_number.runtime_per_hdd_day_1') | float(-1),
            states('input_number.runtime_per_hdd_day_2') | float(-1),
            states('input_number.runtime_per_hdd_day_3') | float(-1),
            states('input_number.runtime_per_hdd_day_4') | float(-1),
            states('input_number.runtime_per_hdd_day_5') | float(-1),
            states('input_number.runtime_per_hdd_day_6') | float(-1),
            states('input_number.runtime_per_hdd_day_7') | float(-1)
          ] %}
          {{ days | select('>', 0) | select('<=', 120) | list | count }}

      # Uses furnace runtime (gas burns when furnace runs, not per zone call)
      - name: "HVAC Daily Gas Cost Estimate"
        unique_id: hvac_daily_gas_cost_estimate
        unit_of_measurement: "$"
        state_class: measurement
        icon: mdi:currency-usd
        state: >
          {% set runtime = states('sensor.hvac_furnace_runtime_today') | float(0) %}
          {% set rate = states('input_number.furnace_heating_rate_btu_hr') | float(60556) %}
          {% set gas_rate = states('sensor.gas_effective_rate') | float(1.68) %}
          {% set ccf_used = (runtime * rate) / (103700 * 0.95) %}
          {{ (ccf_used * gas_rate) | round(2) }}

      # Uses furnace runtime (blower runs when furnace runs)
      - name: "HVAC Daily Electric Cost Estimate"
        unique_id: hvac_daily_electric_cost_estimate
        unit_of_measurement: "$"
        state_class: measurement
        icon: mdi:currency-usd
        state: >
          {% set runtime = states('sensor.hvac_furnace_runtime_today') | float(0) %}
          {% set blower_kw = 0.5 %}
          {% set elec_rate = states('sensor.electricity_effective_rate') | float(0.27) %}
          {{ (runtime * blower_kw * elec_rate) | round(2) }}

      - name: "HVAC Daily Total Cost Estimate"
        unique_id: hvac_daily_total_cost_estimate
        unit_of_measurement: "$"
        state_class: measurement
        icon: mdi:currency-usd
        state: >
          {% set gas = states('sensor.hvac_daily_gas_cost_estimate') | float(0) %}
          {% set elec = states('sensor.hvac_daily_electric_cost_estimate') | float(0) %}
          {{ (gas + elec) | round(2) }}

      - name: "HVAC Filter Hours Remaining"
        unique_id: hvac_filter_hours_remaining
        unit_of_measurement: "hours"
        state_class: measurement
        icon: mdi:air-filter
        state: >
          {% set current = states('input_number.hvac_filter_runtime_hours') | float(0) %}
          {{ (1000 - current) | round(1) if current < 1000 else 0 }}

      # ================================================================
      # MONTHLY ACCUMULATED SENSORS (immune to recorder purge_keep_days)
      # Values accumulated daily at 23:56:30, reset on 1st of month
      # Replaces history_stats month sensors which fail after day 14
      # ================================================================
      - name: "HVAC Furnace Runtime Month"
        unique_id: hvac_furnace_runtime_month
        unit_of_measurement: "h"
        state_class: measurement
        icon: mdi:fire
        state: >
          {% set acc = states('input_number.furnace_runtime_month_acc') | float(0) %}
          {% set today = states('sensor.hvac_furnace_runtime_today') | float(0) %}
          {% set last_capture = states('input_datetime.monthly_tracking_capture_last_ok') %}
          {% set captured_today = last_capture[:10] == now().strftime('%Y-%m-%d') if last_capture not in ['unknown', 'unavailable', '1970-01-01 00:00:00'] else false %}
          {{ (acc if captured_today else acc + today) | round(2) }}

      - name: "HVAC Furnace Cycles Month"
        unique_id: hvac_furnace_cycles_month
        unit_of_measurement: "cycles"
        state_class: measurement
        icon: mdi:counter
        state: >
          {% set acc = states('input_number.furnace_cycles_month_acc') | int(0) %}
          {% set today = states('sensor.hvac_furnace_cycles_today') | int(0) %}
          {% set last_capture = states('input_datetime.monthly_tracking_capture_last_ok') %}
          {% set captured_today = last_capture[:10] == now().strftime('%Y-%m-%d') if last_capture not in ['unknown', 'unavailable', '1970-01-01 00:00:00'] else false %}
          {{ acc if captured_today else acc + today }}

      - name: "HVAC 1F Heat Runtime Month"
        unique_id: hvac_1f_heat_runtime_month
        unit_of_measurement: "h"
        state_class: measurement
        icon: mdi:home-floor-1
        state: >
          {% set acc = states('input_number.zone_1f_runtime_month_acc') | float(0) %}
          {% set today = states('sensor.hvac_1f_heat_runtime_today') | float(0) %}
          {% set last_capture = states('input_datetime.monthly_tracking_capture_last_ok') %}
          {% set captured_today = last_capture[:10] == now().strftime('%Y-%m-%d') if last_capture not in ['unknown', 'unavailable', '1970-01-01 00:00:00'] else false %}
          {{ (acc if captured_today else acc + today) | round(2) }}

      - name: "HVAC 2F Heat Runtime Month"
        unique_id: hvac_2f_heat_runtime_month
        unit_of_measurement: "h"
        state_class: measurement
        icon: mdi:home-floor-2
        state: >
          {% set acc = states('input_number.zone_2f_runtime_month_acc') | float(0) %}
          {% set today = states('sensor.hvac_2f_heat_runtime_today') | float(0) %}
          {% set last_capture = states('input_datetime.monthly_tracking_capture_last_ok') %}
          {% set captured_today = last_capture[:10] == now().strftime('%Y-%m-%d') if last_capture not in ['unknown', 'unavailable', '1970-01-01 00:00:00'] else false %}
          {{ (acc if captured_today else acc + today) | round(2) }}

      - name: "HVAC 1F Heat Cycles Month"
        unique_id: hvac_1f_heat_cycles_month
        unit_of_measurement: "cycles"
        state_class: measurement
        icon: mdi:home-floor-1
        state: >
          {% set acc = states('input_number.zone_1f_cycles_month_acc') | int(0) %}
          {% set today = states('sensor.hvac_1f_heat_cycles_today') | int(0) %}
          {% set last_capture = states('input_datetime.monthly_tracking_capture_last_ok') %}
          {% set captured_today = last_capture[:10] == now().strftime('%Y-%m-%d') if last_capture not in ['unknown', 'unavailable', '1970-01-01 00:00:00'] else false %}
          {{ acc if captured_today else acc + today }}

      - name: "HVAC 2F Heat Cycles Month"
        unique_id: hvac_2f_heat_cycles_month
        unit_of_measurement: "cycles"
        state_class: measurement
        icon: mdi:home-floor-2
        state: >
          {% set acc = states('input_number.zone_2f_cycles_month_acc') | int(0) %}
          {% set today = states('sensor.hvac_2f_heat_cycles_today') | int(0) %}
          {% set last_capture = states('input_datetime.monthly_tracking_capture_last_ok') %}
          {% set captured_today = last_capture[:10] == now().strftime('%Y-%m-%d') if last_capture not in ['unknown', 'unavailable', '1970-01-01 00:00:00'] else false %}
          {{ acc if captured_today else acc + today }}

      - name: "HVAC Total Heat Runtime Month"
        unique_id: hvac_total_heat_runtime_month
        unit_of_measurement: "h"
        state_class: measurement
        availability: >
          {{ states('sensor.hvac_1f_heat_runtime_month_2') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_2f_heat_runtime_month_2') not in ['unknown', 'unavailable'] }}
        state: >
          {{ (states('sensor.hvac_1f_heat_runtime_month_2') | float(0) + states('sensor.hvac_2f_heat_runtime_month_2') | float(0)) | round(2) }}

      # Uses furnace runtime (not sum of zone calls) for accurate efficiency metric
      - name: "HVAC Runtime per HDD Month"
        unique_id: hvac_runtime_per_hdd_month
        unit_of_measurement: "min/HDD"
        state_class: measurement
        availability: >
          {{ states('sensor.hvac_furnace_runtime_month_2') not in ['unknown', 'unavailable'] }}
        state: >
          {% set runtime = states('sensor.hvac_furnace_runtime_month_2') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_cumulative_month') | float(0) %}
          {{ ((runtime * 60) / hdd) | round(1) if hdd > 0 else 0 }}

      - name: "HVAC Zone Balance Month"
        unique_id: hvac_zone_balance_month
        unit_of_measurement: "%"
        state_class: measurement
        availability: >
          {{ states('sensor.hvac_1f_heat_runtime_month_2') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_2f_heat_runtime_month_2') not in ['unknown', 'unavailable'] }}
        state: >
          {% set r1 = states('sensor.hvac_1f_heat_runtime_month_2') | float(0) %}
          {% set r2 = states('sensor.hvac_2f_heat_runtime_month_2') | float(0) %}
          {% set total = r1 + r2 %}
          {{ ((r2 / total) * 100) | round(1) if total > 0 else 50 }}

      # Uses furnace runtime (gas usage matches actual furnace operation)
      - name: "HVAC Heating Efficiency MTD"
        unique_id: hvac_heating_efficiency_mtd
        unit_of_measurement: "CCF/1k HDD"
        state_class: measurement
        icon: mdi:chart-bell-curve-cumulative
        availability: >
          {{ states('sensor.hvac_furnace_runtime_month_2') not in ['unknown', 'unavailable'] }}
        state: >
          {% set hdd = states('sensor.hvac_hdd65_cumulative_month') | float(0) %}
          {% set runtime = states('sensor.hvac_furnace_runtime_month_2') | float(0) %}
          {% set rate = states('input_number.furnace_heating_rate_btu_hr') | float(60556) %}
          {% if hdd > 0 and runtime > 0 %}
            {% set gas = (runtime * rate) / (103700 * 0.95) %}
            {{ ((gas / hdd) * 1000) | round(1) }}
          {% else %}{{ 0 }}{% endif %}

      # Uses furnace runtime (heat delivery matches actual furnace operation)
      - name: "HVAC Building Load UA Estimate"
        unique_id: hvac_building_load_ua_estimate
        unit_of_measurement: "BTU/hr-°F"
        state_class: measurement
        availability: >
          {{ states('sensor.hvac_furnace_runtime_month_2') not in ['unknown', 'unavailable'] }}
        state: >
          {% set runtime = states('sensor.hvac_furnace_runtime_month_2') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_cumulative_month') | float(0) %}
          {% set rate = states('input_number.furnace_heating_rate_btu_hr') | float(60556) %}
          {% set days = now().day %}
          {% if hdd > 0 and runtime > 0 and days > 0 %}
            {% set avg_dt = hdd / days %}
            {% set hours = days * 24 %}
            {{ ((runtime * rate) / (avg_dt * hours)) | round(0) }}
          {% else %}{{ 449 }}{% endif %}

      - name: "Balance Point Temperature"
        unique_id: balance_point_temperature
        unit_of_measurement: "°F"
        device_class: temperature
        state: "{{ states('input_number.balance_point_baseline') | float(59) }}"

      - name: "Site EUI (Rolling 12M Bills)"
        unique_id: site_eui_estimate
        unit_of_measurement: "kBTU/ft²-yr"
        state_class: measurement
        state: >
          {% set months = ['jan','feb','mar','apr','may','jun',
                           'jul','aug','sep','oct','nov','dec'] %}
          {% set ns = namespace(kwh=0, ccf=0) %}
          {% for m in months %}
            {% set ns.kwh = ns.kwh + states('input_number.electric_archive_' ~ m ~ '_kwh') | float(0) %}
            {% set ns.ccf = ns.ccf + states('input_number.gas_archive_' ~ m ~ '_ccf') | float(0) %}
          {% endfor %}
          {% if ns.kwh > 0 or ns.ccf > 0 %}
            {{ ((ns.kwh * 3.412 + ns.ccf * 103.7) / 2440) | round(1) }}
          {% else %}{{ 41.7 }}{% endif %}

      - name: "HVAC Performance vs Baseline"
        unique_id: hvac_performance_vs_baseline
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set current = states('sensor.hvac_heating_efficiency_mtd') | float(0) %}
          {% set baseline = 82.6 %}
          {{ ((current / baseline - 1) * 100) | round(1) if current > 0 else 0 }}

      - name: "UA Performance vs Baseline"
        unique_id: ua_performance_vs_baseline
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set current = states('sensor.hvac_building_load_ua_estimate') | float(449) %}
          {{ ((current / 449 - 1) * 100) | round(1) }}

      - name: "EUI vs Baseline"
        unique_id: eui_vs_baseline
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set current = states('sensor.site_eui_estimate') | float(0) %}
          {{ ((current / 41.7 - 1) * 100) | round(1) if current > 0 else 0 }}

      - name: "Weather Severity vs Normal MTD"
        unique_id: weather_severity_vs_normal_mtd
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:thermometer-alert
        state: >
          {# Monthly normal HDD for CT (6,270 annual baseline) #}
          {% set monthly_normals = {
            1: 1085, 2: 925, 3: 750, 4: 420, 5: 155, 6: 20,
            7: 0, 8: 5, 9: 55, 10: 280, 11: 540, 12: 1035
          } %}
          {% set hdd = states('sensor.hvac_hdd65_cumulative_month') | float(0) %}
          {% set month_normal = monthly_normals[now().month] | float(1) %}
          {# Calculate days in current month correctly (handles December) #}
          {% set next_month = now().replace(day=28) + timedelta(days=4) %}
          {% set last_day = next_month - timedelta(days=next_month.day) %}
          {% set days_in_month = last_day.day %}
          {% set daily_rate = month_normal / days_in_month %}
          {% set expected = daily_rate * now().day %}
          {{ ((hdd / expected - 1) * 100) | round(1) if expected > 0 else 0 }}

      - name: "Weather Severity Progress MTD"
        unique_id: weather_severity_progress_mtd
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:progress-clock
        state: >
          {# Monthly normal HDD for CT (6,270 annual baseline) #}
          {% set monthly_normals = {
            1: 1085, 2: 925, 3: 750, 4: 420, 5: 155, 6: 20,
            7: 0, 8: 5, 9: 55, 10: 280, 11: 540, 12: 1035
          } %}
          {% set hdd = states('sensor.hvac_hdd65_cumulative_month') | float(0) %}
          {% set month_normal = monthly_normals[now().month] | float(1) %}
          {{ ((hdd / month_normal) * 100) | round(1) if month_normal > 0 else 0 }}

      - name: "Projected Annual Gas CCF"
        unique_id: projected_annual_gas_ccf
        unit_of_measurement: "CCF"
        state: >
          {% set ccf = states('input_number.gas_bill_ccf') | float(110) %}
          {% set days = states('input_number.gas_bill_days') | float(28) %}
          {{ ((ccf / days) * 365) | round(0) if days > 0 else 787 }}

      - name: "Projected Annual Electricity kWh"
        unique_id: projected_annual_electricity_kwh
        unit_of_measurement: "kWh"
        state: >
          {% set kwh = states('input_number.electricity_bill_kwh') | float(454) %}
          {% set days = states('input_number.electricity_bill_days') | float(33) %}
          {{ ((kwh / days) * 365) | round(0) if days > 0 else 6730 }}

      - name: "Electricity Effective Rate"
        unique_id: electricity_effective_rate
        unit_of_measurement: "$/kWh"
        state: >
          {% set amt = states('input_number.electricity_bill_amount') | float(0) %}
          {% set kwh = states('input_number.electricity_bill_kwh') | float(1) %}
          {{ (amt / kwh) | round(4) if amt > 0 and kwh > 0 else 0.2733 }}

      - name: "Gas Effective Rate"
        unique_id: gas_effective_rate
        unit_of_measurement: "$/CCF"
        state: >
          {% set amt = states('input_number.gas_bill_amount') | float(0) %}
          {% set ccf = states('input_number.gas_bill_ccf') | float(1) %}
          {{ (amt / ccf) | round(4) if amt > 0 and ccf > 0 else 1.6818 }}

      - name: "Electricity Effective Rate Previous"
        unique_id: electricity_effective_rate_previous
        unit_of_measurement: "$/kWh"
        state: >
          {% set amt = states('input_number.electricity_bill_amount_previous') | float(0) %}
          {% set kwh = states('input_number.electricity_bill_kwh_previous') | float(1) %}
          {{ (amt / kwh) | round(4) if amt > 0 and kwh > 0 else 0.2722 }}

      - name: "Gas Effective Rate Previous"
        unique_id: gas_effective_rate_previous
        unit_of_measurement: "$/CCF"
        state: >
          {% set amt = states('input_number.gas_bill_amount_previous') | float(0) %}
          {% set ccf = states('input_number.gas_bill_ccf_previous') | float(1) %}
          {{ (amt / ccf) | round(4) if amt > 0 and ccf > 0 else 1.9660 }}

      - name: "Electricity Effective Rate Last Year"
        unique_id: electricity_effective_rate_last_year
        unit_of_measurement: "$/kWh"
        state: >
          {% set amt = states('input_number.electricity_bill_amount_last_year') | float(0) %}
          {% set kwh = states('input_number.electricity_bill_kwh_last_year') | float(1) %}
          {{ (amt / kwh) | round(4) if amt > 0 and kwh > 0 else 0.3152 }}

      - name: "Gas Effective Rate Last Year"
        unique_id: gas_effective_rate_last_year
        unit_of_measurement: "$/CCF"
        state: >
          {% set amt = states('input_number.gas_bill_amount_last_year') | float(0) %}
          {% set ccf = states('input_number.gas_bill_ccf_last_year') | float(1) %}
          {{ (amt / ccf) | round(4) if amt > 0 and ccf > 0 else 1.6613 }}

      - name: "Electricity Rate Change MoM"
        unique_id: electricity_rate_change_mom
        unit_of_measurement: "%"
        state: >
          {% set cur = states('sensor.electricity_effective_rate') | float(0) %}
          {% set prev = states('sensor.electricity_effective_rate_previous') | float(0) %}
          {{ ((cur / prev - 1) * 100) | round(1) if prev > 0 and cur > 0 else 0 }}

      - name: "Gas Rate Change MoM"
        unique_id: gas_rate_change_mom
        unit_of_measurement: "%"
        state: >
          {% set cur = states('sensor.gas_effective_rate') | float(0) %}
          {% set prev = states('sensor.gas_effective_rate_previous') | float(0) %}
          {{ ((cur / prev - 1) * 100) | round(1) if prev > 0 and cur > 0 else 0 }}

      - name: "Electricity Usage Change MoM"
        unique_id: electricity_usage_change_mom
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.electricity_bill_kwh') | float(0) %}
          {% set prev = states('input_number.electricity_bill_kwh_previous') | float(0) %}
          {{ ((cur / prev - 1) * 100) | round(1) if prev > 0 and cur > 0 else 0 }}

      - name: "Gas Usage Change MoM"
        unique_id: gas_usage_change_mom
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.gas_bill_ccf') | float(0) %}
          {% set prev = states('input_number.gas_bill_ccf_previous') | float(0) %}
          {{ ((cur / prev - 1) * 100) | round(1) if prev > 0 and cur > 0 else 0 }}

      - name: "Electricity Bill Change MoM"
        unique_id: electricity_bill_change_mom
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.electricity_bill_amount') | float(0) %}
          {% set prev = states('input_number.electricity_bill_amount_previous') | float(0) %}
          {{ ((cur / prev - 1) * 100) | round(1) if prev > 0 and cur > 0 else 0 }}

      - name: "Gas Bill Change MoM"
        unique_id: gas_bill_change_mom
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.gas_bill_amount') | float(0) %}
          {% set prev = states('input_number.gas_bill_amount_previous') | float(0) %}
          {{ ((cur / prev - 1) * 100) | round(1) if prev > 0 and cur > 0 else 0 }}

      - name: "Electricity Rate Change YoY"
        unique_id: electricity_rate_change_yoy
        unit_of_measurement: "%"
        state: >
          {% set cur = states('sensor.electricity_effective_rate') | float(0) %}
          {% set ly = states('sensor.electricity_effective_rate_last_year') | float(0) %}
          {{ ((cur / ly - 1) * 100) | round(1) if ly > 0 and cur > 0 else 0 }}

      - name: "Gas Rate Change YoY"
        unique_id: gas_rate_change_yoy
        unit_of_measurement: "%"
        state: >
          {% set cur = states('sensor.gas_effective_rate') | float(0) %}
          {% set ly = states('sensor.gas_effective_rate_last_year') | float(0) %}
          {{ ((cur / ly - 1) * 100) | round(1) if ly > 0 and cur > 0 else 0 }}

      - name: "Electricity Usage Change YoY"
        unique_id: electricity_usage_change_yoy
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.electricity_bill_kwh') | float(0) %}
          {% set ly = states('input_number.electricity_bill_kwh_last_year') | float(0) %}
          {{ ((cur / ly - 1) * 100) | round(1) if ly > 0 and cur > 0 else 0 }}

      - name: "Gas Usage Change YoY"
        unique_id: gas_usage_change_yoy
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.gas_bill_ccf') | float(0) %}
          {% set ly = states('input_number.gas_bill_ccf_last_year') | float(0) %}
          {{ ((cur / ly - 1) * 100) | round(1) if ly > 0 and cur > 0 else 0 }}

      - name: "Electricity Bill Change YoY"
        unique_id: electricity_bill_change_yoy
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.electricity_bill_amount') | float(0) %}
          {% set ly = states('input_number.electricity_bill_amount_last_year') | float(0) %}
          {{ ((cur / ly - 1) * 100) | round(1) if ly > 0 and cur > 0 else 0 }}

      - name: "Gas Bill Change YoY"
        unique_id: gas_bill_change_yoy
        unit_of_measurement: "%"
        state: >
          {% set cur = states('input_number.gas_bill_amount') | float(0) %}
          {% set ly = states('input_number.gas_bill_amount_last_year') | float(0) %}
          {{ ((cur / ly - 1) * 100) | round(1) if ly > 0 and cur > 0 else 0 }}

      - name: "Gas Usage This Month"
        unique_id: gas_usage_this_month
        unit_of_measurement: "CCF"
        state: "{{ states('input_number.gas_bill_ccf') | float(0) }}"

      - name: "Gas Heating Usage Month"
        unique_id: gas_heating_usage_month
        unit_of_measurement: "CCF"
        state: "{{ (states('input_number.gas_bill_ccf') | float(0) * 0.719) | round(1) }}"

      - name: "Gas DHW Usage Month"
        unique_id: gas_dhw_usage_month
        unit_of_measurement: "CCF"
        state: "{{ (states('input_number.gas_bill_ccf') | float(0) * 0.281) | round(1) }}"

      - name: "Gas Cost This Month"
        unique_id: gas_cost_this_month
        unit_of_measurement: "$"
        state: "{{ states('input_number.gas_bill_amount') | float(0) }}"

      - name: "Gas Heating Cost Month"
        unique_id: gas_heating_cost_month
        unit_of_measurement: "$"
        state: "{{ (states('input_number.gas_bill_amount') | float(0) * 0.719) | round(2) }}"

      - name: "Total Cost Month"
        unique_id: total_cost_month
        unit_of_measurement: "$"
        state: >
          {% set amt = states('input_number.electricity_bill_amount') | float(124) %}
          {% set days = states('input_number.electricity_bill_days') | float(30) %}
          {{ ((amt / days) * now().day) | round(2) if days > 0 else 0 }}

      - name: "Total Utility Cost Month"
        unique_id: total_utility_cost_month
        unit_of_measurement: "$"
        state: >
          {{ (states('sensor.total_cost_month') | float(0) + states('sensor.gas_cost_this_month') | float(0)) | round(2) }}

      - name: "HVAC Cathedral Ceiling Impact MTD"
        unique_id: hvac_cathedral_ceiling_impact_mtd
        unit_of_measurement: "$"
        state: >
          {% set r2 = states('sensor.hvac_2f_heat_runtime_month_2') | float(0) %}
          {% set rate = states('input_number.furnace_heating_rate_btu_hr') | float(60556) %}
          {% set gas_rate = states('sensor.gas_effective_rate') | float(1.68) %}
          {{ ((r2 * rate * 0.15 / 103700) * gas_rate) | round(2) }}

      - name: "Basement Dew Point"
        unique_id: basement_dew_point
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        availability: >
          {% set t = states('sensor.shelly_temperature_humidity_temperature') %}
          {% set rh = states('sensor.shelly_temperature_humidity_humidity') %}
          {{ is_number(t) and is_number(rh) and (t | float) > 0 and (rh | float) > 0 and (rh | float) <= 100 }}
        state: >
          {% set t = states('sensor.shelly_temperature_humidity_temperature') | float %}
          {% set rh = states('sensor.shelly_temperature_humidity_humidity') | float %}
          {% set t_c = (t - 32) * 5 / 9 %}
          {% set a = 17.27 %}
          {% set b = 237.7 %}
          {% set gamma = log(rh / 100) + (a * t_c) / (b + t_c) %}
          {% set dp_c = (b * gamma) / (a - gamma) %}
          {{ (dp_c * 9 / 5 + 32) | round(1) }}

      # ===============================================================
      # DEHUMIDIFIER PERFORMANCE TRACKING
      # ===============================================================
      - name: "Dehumidifier Dew Point Margin"
        unique_id: dehumidifier_dew_point_margin
        unit_of_measurement: "°F"
        state_class: measurement
        icon: mdi:water-minus
        availability: >
          {{ states('sensor.basement_dew_point') not in ['unknown', 'unavailable'] and
             states('input_number.dehumidifier_dewpoint_threshold') not in ['unknown', 'unavailable'] }}
        state: >
          {% set dp = states('sensor.basement_dew_point') | float(0) %}
          {% set threshold = states('input_number.dehumidifier_dewpoint_threshold') | float(52) %}
          {{ (threshold - dp) | round(1) }}

      - name: "Dehumidifier Duty Cycle 24h"
        unique_id: dehumidifier_duty_cycle_24h
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:percent
        availability: >
          {{ states('sensor.dehumidifier_runtime_week') not in ['unknown', 'unavailable'] }}
        state: >
          {% set weekly = states('sensor.dehumidifier_runtime_week') | float(0) %}
          {% set daily_avg = weekly / 7 %}
          {{ ((daily_avg / 24) * 100) | round(1) }}

      - name: "Dehumidifier Avg Cycle Minutes"
        unique_id: dehumidifier_avg_cycle_minutes
        unit_of_measurement: "min"
        state_class: measurement
        icon: mdi:timer-outline
        availability: >
          {% set runtime = states('sensor.dehumidifier_runtime_today') %}
          {% set cycles = states('counter.dehumidifier_cycles_today') %}
          {{ runtime not in ['unknown', 'unavailable'] and
             cycles not in ['unknown', 'unavailable'] and
             cycles | int(0) > 0 }}
        state: >
          {% set runtime_h = states('sensor.dehumidifier_runtime_today') | float(0) %}
          {% set cycles = states('counter.dehumidifier_cycles_today') | int(1) %}
          {{ ((runtime_h * 60) / cycles) | round(1) }}

      - name: "Dehumidifier Pull-Down Rate"
        unique_id: dehumidifier_pull_down_rate
        unit_of_measurement: "°F/h"
        state_class: measurement
        icon: mdi:arrow-down-bold
        availability: >
          {% set rate = states('input_number.dehumidifier_last_pull_down_rate') %}
          {% set end_time = states('input_datetime.dehumidifier_last_cycle_end_time') %}
          {{ rate not in ['unknown', 'unavailable'] and
             end_time not in ['unknown', 'unavailable'] and
             end_time[:4] != '1970' }}
        state: >
          {{ states('input_number.dehumidifier_last_pull_down_rate') | float(0) | round(1) }}

      - name: "Dehumidifier Hold Time"
        unique_id: dehumidifier_hold_time
        unit_of_measurement: "h"
        state_class: measurement
        icon: mdi:timer-sand
        availability: >
          {% set hold = states('input_number.dehumidifier_last_hold_hours') %}
          {% set reason = states('input_select.dehumidifier_last_stop_reason') %}
          {{ hold not in ['unknown', 'unavailable'] and reason == 'conditions_cleared' }}
        state: >
          {{ states('input_number.dehumidifier_last_hold_hours') | float(0) | round(1) }}

      # ===============================================================
      # PIRATE WEATHER SENSORS
      # ===============================================================
      - name: "Pirate Weather Temperature"
        unique_id: pirate_weather_temperature
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        state: "{{ state_attr('weather.pirateweather', 'temperature') | float(0) }}"

      - name: "Pirate Weather Feels Like"
        unique_id: pirate_weather_feels_like
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        state: >
          {% set temp = state_attr('weather.pirateweather', 'temperature') | float(0) %}
          {% set humidity = state_attr('weather.pirateweather', 'humidity') | float(50) %}
          {% set wind = state_attr('weather.pirateweather', 'wind_speed') | float(0) %}
          {% if temp >= 80 and humidity >= 40 %}
            {# Heat index calculation #}
            {% set hi = -42.379 + 2.04901523*temp + 10.14333127*humidity - 0.22475541*temp*humidity - 0.00683783*temp**2 - 0.05481717*humidity**2 + 0.00122874*temp**2*humidity + 0.00085282*temp*humidity**2 - 0.00000199*temp**2*humidity**2 %}
            {{ hi | round(1) }}
          {% elif temp <= 50 and wind >= 3 %}
            {# Wind chill calculation #}
            {% set wc = 35.74 + 0.6215*temp - 35.75*(wind**0.16) + 0.4275*temp*(wind**0.16) %}
            {{ wc | round(1) }}
          {% else %}
            {{ temp | round(1) }}
          {% endif %}

      - name: "Pirate Weather Humidity"
        unique_id: pirate_weather_humidity
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        state: "{{ state_attr('weather.pirateweather', 'humidity') | float(0) }}"

      - name: "Pirate Weather Pressure"
        unique_id: pirate_weather_pressure
        unit_of_measurement: "inHg"
        device_class: atmospheric_pressure
        state_class: measurement
        state: >
          {% set pressure_hpa = state_attr('weather.pirateweather', 'pressure') | float(1013.25) %}
          {{ (pressure_hpa * 0.02953) | round(2) }}

      - name: "Pirate Weather Wind Speed"
        unique_id: pirate_weather_wind_speed
        unit_of_measurement: "mph"
        device_class: wind_speed
        state_class: measurement
        state: "{{ state_attr('weather.pirateweather', 'wind_speed') | float(0) }}"

      - name: "Pirate Weather Wind Bearing"
        unique_id: pirate_weather_wind_bearing
        unit_of_measurement: "°"
        state_class: measurement
        icon: mdi:compass
        state: "{{ state_attr('weather.pirateweather', 'wind_bearing') | float(0) }}"

      - name: "Pirate Weather Wind Direction"
        unique_id: pirate_weather_wind_direction
        icon: mdi:compass-outline
        state: >
          {% set bearing = state_attr('weather.pirateweather', 'wind_bearing') | float(0) %}
          {% set directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'] %}
          {{ directions[((bearing + 11.25) / 22.5) | int % 16] }}

      - name: "Pirate Weather Visibility"
        unique_id: pirate_weather_visibility
        unit_of_measurement: "mi"
        state_class: measurement
        icon: mdi:eye
        state: "{{ state_attr('weather.pirateweather', 'visibility') | float(10) }}"

      - name: "Pirate Weather Cloud Cover"
        unique_id: pirate_weather_cloud_cover
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:cloud-percent
        state: "{{ state_attr('weather.pirateweather', 'cloud_coverage') | float(0) }}"

      - name: "Pirate Weather Dew Point"
        unique_id: pirate_weather_dew_point
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        state: "{{ state_attr('weather.pirateweather', 'dew_point') | float(0) }}"

      - name: "Pirate Weather UV Index"
        unique_id: pirate_weather_uv_index
        state_class: measurement
        icon: mdi:sun-wireless
        state: "{{ state_attr('weather.pirateweather', 'uv_index') | float(0) }}"

      - name: "Pirate Weather Ozone"
        unique_id: pirate_weather_ozone
        unit_of_measurement: "DU"
        state_class: measurement
        icon: mdi:molecule
        state: "{{ state_attr('weather.pirateweather', 'ozone') | float(0) }}"

      - name: "Pirate Weather Condition"
        unique_id: pirate_weather_condition
        icon: mdi:weather-partly-cloudy
        state: "{{ states('weather.pirateweather') }}"

      # Weather Source Indicator
      - name: "Pirate Weather Data Age"
        unique_id: pirate_weather_data_age
        unit_of_measurement: "min"
        icon: mdi:clock-outline
        state: >
          {% set last_updated = states.weather.pirateweather.last_updated %}
          {% if last_updated %}
            {{ ((now() - last_updated).total_seconds() / 60) | round(0) }}
          {% else %}unknown{% endif %}

      # === SETBACK RECOMMENDATION SENSOR ===
      # Recommends setback depth based on forecast overnight low
      # Thresholds adjustable as data is collected in hvac_setback_log.csv
      - name: "Recommended Setback Depth"
        unique_id: recommended_setback_depth
        unit_of_measurement: "°F"
        state_class: measurement
        icon: mdi:thermometer-chevron-down
        availability: "{{ is_number(states('sensor.pirate_weather_today_low')) }}"
        state: >
          {% set low = states('sensor.pirate_weather_today_low') | float %}
          {% if low > 30 %}5
          {% elif low > 15 %}3
          {% else %}1{% endif %}
        attributes:
          forecast_low: "{{ states('sensor.pirate_weather_today_low') }}"
          guidance: >
            {% set low = states('sensor.pirate_weather_today_low') | float %}
            {% if low > 30 %}Mild night - deeper setback saves gas
            {% elif low > 15 %}Moderate cold - balanced setback
            {% else %}Very cold - shallow setback avoids recovery penalty{% endif %}

      # === CLIMATE NORMS DERIVED SENSORS ===
      - name: "Expected HDD Today"
        unique_id: expected_hdd_today
        unit_of_measurement: "HDD"
        state_class: measurement
        icon: mdi:snowflake-thermometer
        availability: >
          {{ states('sensor.climate_norms_today') not in ['unknown', 'unavailable', 'error'] and
             state_attr('sensor.climate_norms_today', 'hdd_mean') is not none }}
        state: >
          {{ state_attr('sensor.climate_norms_today', 'hdd_mean') | float(0) | round(1) }}
        attributes:
          p10: "{{ state_attr('sensor.climate_norms_today', 'hdd_p10') }}"
          p90: "{{ state_attr('sensor.climate_norms_today', 'hdd_p90') }}"
          smoothed: "{{ state_attr('sensor.climate_norms_today', 'hdd_mean_smoothed') }}"

      - name: "Expected CDD Today"
        unique_id: expected_cdd_today
        unit_of_measurement: "CDD"
        state_class: measurement
        icon: mdi:sun-thermometer
        availability: >
          {{ states('sensor.climate_norms_today') not in ['unknown', 'unavailable', 'error'] and
             state_attr('sensor.climate_norms_today', 'cdd_mean') is not none }}
        state: >
          {{ state_attr('sensor.climate_norms_today', 'cdd_mean') | float | round(1) }}
        attributes:
          p10: "{{ state_attr('sensor.climate_norms_today', 'cdd_p10') }}"
          p90: "{{ state_attr('sensor.climate_norms_today', 'cdd_p90') }}"

      - name: "Expected Temperature Today"
        unique_id: expected_temperature_today
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        availability: >
          {{ states('sensor.climate_norms_today') not in ['unknown', 'unavailable', 'error'] and
             state_attr('sensor.climate_norms_today', 'tmean') is not none }}
        state: >
          {{ state_attr('sensor.climate_norms_today', 'tmean') | float | round(1) }}
        attributes:
          tmin: "{{ state_attr('sensor.climate_norms_today', 'tmin') }}"
          tmax: "{{ state_attr('sensor.climate_norms_today', 'tmax') }}"

      - name: "HDD Deviation Today"
        unique_id: hdd_deviation_today
        unit_of_measurement: "HDD"
        state_class: measurement
        icon: mdi:delta
        state: >
          {% set actual = states('sensor.hvac_hdd65_today') | float(0) %}
          {% set expected = states('sensor.expected_hdd_today') | float(0) %}
          {{ (actual - expected) | round(1) }}
        attributes:
          interpretation: >
            {% set dev = this.state | float(0) %}
            {% if dev > 5 %}Colder than normal
            {% elif dev < -5 %}Milder than normal
            {% else %}Normal{% endif %}

      - name: "Expected Runtime Today"
        unique_id: expected_runtime_today
        unit_of_measurement: "h"
        state_class: measurement
        icon: mdi:timer-outline
        availability: >
          {% set expected = states('sensor.expected_hdd_today') %}
          {% set runtime_primary = states('sensor.hvac_runtime_per_hdd_7_day') %}
          {% set runtime_legacy = states('sensor.hvac_runtime_per_hdd_7_day_2') %}
          {{ is_number(expected) and (is_number(runtime_primary) or is_number(runtime_legacy)) }}
        state: >
          {% set expected_hdd = states('sensor.expected_hdd_today') | float %}
          {% set runtime_state = states('sensor.hvac_runtime_per_hdd_7_day') %}
          {% if not is_number(runtime_state) %}
            {% set runtime_state = states('sensor.hvac_runtime_per_hdd_7_day_2') %}
          {% endif %}
          {% set runtime_per_hdd = runtime_state | float %}
          {% if expected_hdd > 0 %}
            {{ (expected_hdd * runtime_per_hdd / 60) | round(2) }}
          {% else %}
            0
          {% endif %}
        attributes:
          runtime_per_hdd_source: >
            {% if is_number(states('sensor.hvac_runtime_per_hdd_7_day')) %}
              sensor.hvac_runtime_per_hdd_7_day
            {% elif is_number(states('sensor.hvac_runtime_per_hdd_7_day_2')) %}
              sensor.hvac_runtime_per_hdd_7_day_2
            {% else %}
              unavailable
            {% endif %}

      # Uses furnace runtime (not sum of zone calls) for consistency with expected
      - name: "Efficiency Deviation Index"
        unique_id: efficiency_deviation_index
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:gauge
        availability: >
          {{ is_number(states('sensor.hvac_furnace_runtime_today')) and
             is_number(states('sensor.expected_runtime_today')) }}
        state: >
          {% set actual = states('sensor.hvac_furnace_runtime_today') | float %}
          {% set expected = states('sensor.expected_runtime_today') | float %}
          {% if expected > 0.1 %}
            {{ (((actual / expected) - 1) * 100) | round(1) }}
          {% else %}
            0
          {% endif %}
        attributes:
          interpretation: >
            {% set dev = this.state | float(0) %}
            {% if dev > 15 %}Working harder than expected
            {% elif dev < -15 %}Outperforming baseline
            {% else %}Normal performance{% endif %}

      - name: "Climate Norms Status"
        unique_id: climate_norms_status
        icon: mdi:cloud-check
        state: >
          {% if states('sensor.climate_norms_today') == 'ok' %}
            OK - Day {{ state_attr('sensor.climate_norms_today', 'day_of_year') }}
          {% else %}
            Error
          {% endif %}

      # === MONTHLY REPORT SENSORS ===
      - name: "Outdoor Temp Mean Month"
        unique_id: outdoor_temp_mean_month
        unit_of_measurement: "°F"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set temp_sum = states('input_number.outdoor_temp_sum_month') | float(0) %}
          {% set days = states('input_number.outdoor_temp_days_month') | int(0) %}
          {% if days > 0 %}
            {{ (temp_sum / days) | round(1) }}
          {% else %}
            0
          {% endif %}

      - name: "Expected Runtime Month"
        unique_id: expected_runtime_month
        unit_of_measurement: "h"
        state_class: measurement
        icon: mdi:timer-outline
        state: >
          {{ states('input_number.expected_runtime_sum_month') | float(0) | round(2) }}

      # Uses furnace runtime (not sum of zone calls) for consistency with expected
      - name: "Efficiency Deviation Month"
        unique_id: efficiency_deviation_month
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:gauge
        availability: >
          {{ states('sensor.hvac_furnace_runtime_month_2') not in ['unknown', 'unavailable'] }}
        state: >
          {% set actual = states('sensor.hvac_furnace_runtime_month_2') | float(0) %}
          {% set expected = states('input_number.expected_runtime_sum_month') | float(0) %}
          {% if expected > 0.1 %}
            {{ (((actual / expected) - 1) * 100) | round(1) }}
          {% else %}
            0
          {% endif %}

      # Uses furnace runtime (not sum of zone calls) for accurate efficiency metric
      # Now uses same HDD source as sensor.hvac_runtime_per_hdd_month for consistency
      - name: "Runtime per HDD Month"
        unique_id: runtime_per_hdd_month_calc
        unit_of_measurement: "min/HDD"
        state_class: measurement
        icon: mdi:chart-timeline-variant
        availability: >
          {{ states('sensor.hvac_furnace_runtime_month_2') not in ['unknown', 'unavailable'] and
             states('sensor.hvac_hdd65_cumulative_month') not in ['unknown', 'unavailable'] }}
        state: >
          {% set runtime = states('sensor.hvac_furnace_runtime_month_2') | float(0) %}
          {% set hdd = states('sensor.hvac_hdd65_cumulative_month') | float(0) %}
          {% if hdd > 0 %}
            {{ ((runtime * 60) / hdd) | round(1) }}
          {% else %}
            0
          {% endif %}

  - binary_sensor:
      # === CLIMATE NORMS ALERTS ===
      - name: "Climate Cold Snap Today"
        unique_id: climate_cold_snap_today
        device_class: cold
        icon: mdi:snowflake-alert
        state: >
          {% set actual_hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {% set p90 = state_attr('sensor.climate_norms_today', 'hdd_p90') | float(0) %}
          {{ actual_hdd > p90 and p90 > 0 }}

      - name: "Climate Adjusted Efficiency Alert"
        unique_id: climate_adjusted_efficiency_alert
        device_class: problem
        icon: mdi:alert-circle
        state: >
          {% set deviation = states('sensor.efficiency_deviation_index') | float(0) %}
          {% set expected_hdd = states('sensor.expected_hdd_today') | float(0) %}
          {% set actual_hdd = states('sensor.hvac_hdd65_today') | float(0) %}
          {# Only alert if: deviation > 15%, expected HDD > 20, and actual > expected #}
          {{ deviation > 15 and expected_hdd > 20 and actual_hdd > expected_hdd }}

      # Climate norms staleness - day_of_year should match today
      - name: "Climate Norms Stale"
        unique_id: climate_norms_stale
        device_class: problem
        icon: mdi:calendar-alert
        state: >
          {% set sensor_doy = state_attr('sensor.climate_norms_today', 'day_of_year') | int(0) %}
          {% set actual_doy = now().timetuple().tm_yday %}
          {% set status = states('sensor.climate_norms_today') %}
          {# Stale if: sensor unavailable/error, OR day_of_year doesn't match today #}
          {{ status in ['unknown', 'unavailable', 'error'] or sensor_doy != actual_doy }}

      # ===============================================================
      # TIER 1 DATA INTEGRITY - PIPELINE HEALTH
      # ===============================================================

      # --- HDD Pipeline Health ---
      - name: "HDD Pipeline Healthy"
        unique_id: hdd_pipeline_healthy
        icon: mdi:thermometer-check
        state: >
          {% set proxy_available = states('sensor.hvac_outdoor_temp_hartford_proxy') not in ['unknown', 'unavailable'] %}
          {% set not_stale = is_state('binary_sensor.hdd_capture_stale', 'off') %}
          {% set valid_days = states('sensor.hdd_valid_days_7d') | int(0) %}
          {{ proxy_available and not_stale and valid_days >= 5 }}

      # --- Runtime/HDD Pipeline Health ---
      - name: "Runtime per HDD Pipeline Healthy"
        unique_id: runtime_per_hdd_pipeline_healthy
        icon: mdi:chart-timeline-variant-shimmer
        state: >
          {% set hdd_healthy = is_state('binary_sensor.hdd_pipeline_healthy', 'on') %}
          {% set not_stale = is_state('binary_sensor.runtime_per_hdd_capture_stale', 'off') %}
          {% set data_count = states('sensor.hvac_runtime_per_hdd_data_count') | int(0) %}
          {{ hdd_healthy and not_stale and data_count >= 4 }}

      # --- Automation Failure Tracking ---
      - name: "Automation Failures Active"
        unique_id: automation_failures_active
        device_class: problem
        icon: mdi:alert-circle
        state: "{{ states('counter.automation_failures_24h') | int(0) > 0 }}"

  - trigger:
      - trigger: homeassistant
        event: start
      - trigger: event
        event_type: event_template_reloaded
      - trigger: time_pattern
        minutes: "/15"
    action:
      - action: weather.get_forecasts
        target:
          entity_id: weather.pirateweather
        data:
          type: daily
        response_variable: pirate_weather_daily
    sensor:
      - name: "Pirate Weather Daily Forecast Count"
        unique_id: pirate_weather_daily_forecast_count
        icon: mdi:counter
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast | count }}
        attributes:
          response_keys: >
            {% set data = pirate_weather_daily | default({}, true) %}
            {{ data.keys() | list if data is mapping else [] }}
          last_refresh: "{{ now().isoformat() }}"

      # Daily Forecast - Today
      - name: "Pirate Weather Today High"
        unique_id: pirate_weather_today_high
        unit_of_measurement: "°F"
        device_class: temperature
        icon: mdi:thermometer-chevron-up
        availability: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast | length > 0 and is_number(forecast[0].temperature) }}
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast[0].temperature | float }}

      - name: "Pirate Weather Today Low"
        unique_id: pirate_weather_today_low
        unit_of_measurement: "°F"
        device_class: temperature
        icon: mdi:thermometer-chevron-down
        availability: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast | length > 0 and is_number(forecast[0].templow) }}
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast[0].templow | float }}

      - name: "Pirate Weather Today Precip Probability"
        unique_id: pirate_weather_today_precip_prob
        unit_of_measurement: "%"
        icon: mdi:weather-rainy
        availability: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast | length > 0 and is_number(forecast[0].precipitation_probability) }}
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast[0].precipitation_probability | float }}

      - name: "Pirate Weather Today Condition"
        unique_id: pirate_weather_today_condition
        icon: mdi:calendar-today
        availability: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast | length > 0 and forecast[0].condition is not none }}
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast[0].condition }}

      # Tomorrow Forecast
      - name: "Pirate Weather Tomorrow High"
        unique_id: pirate_weather_tomorrow_high
        unit_of_measurement: "°F"
        device_class: temperature
        icon: mdi:thermometer-chevron-up
        availability: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast | length > 1 and is_number(forecast[1].temperature) }}
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast[1].temperature | float }}

      - name: "Pirate Weather Tomorrow Low"
        unique_id: pirate_weather_tomorrow_low
        unit_of_measurement: "°F"
        device_class: temperature
        icon: mdi:thermometer-chevron-down
        availability: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast | length > 1 and is_number(forecast[1].templow) }}
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast[1].templow | float }}

      - name: "Pirate Weather Tomorrow Precip Probability"
        unique_id: pirate_weather_tomorrow_precip_prob
        unit_of_measurement: "%"
        icon: mdi:weather-rainy
        availability: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast | length > 1 and is_number(forecast[1].precipitation_probability) }}
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast[1].precipitation_probability | float }}

      - name: "Pirate Weather Tomorrow Condition"
        unique_id: pirate_weather_tomorrow_condition
        icon: mdi:calendar-arrow-right
        availability: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast | length > 1 and forecast[1].condition is not none }}
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast[1].condition }}

      # HDD/CDD Forecast Estimates (using daily high/low average)
      - name: "Pirate Weather HDD Forecast Today"
        unique_id: pirate_weather_hdd_forecast_today
        unit_of_measurement: "HDD"
        icon: mdi:snowflake
        availability: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast | length > 0 and is_number(forecast[0].temperature) and is_number(forecast[0].templow) }}
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {% set high = forecast[0].temperature | float %}
          {% set low = forecast[0].templow | float %}
          {% set avg = (high + low) / 2 %}
          {{ [65 - avg, 0] | max | round(1) }}

      - name: "Pirate Weather CDD Forecast Today"
        unique_id: pirate_weather_cdd_forecast_today
        unit_of_measurement: "CDD"
        icon: mdi:sun-thermometer
        availability: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast | length > 0 and is_number(forecast[0].temperature) and is_number(forecast[0].templow) }}
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {% set high = forecast[0].temperature | float %}
          {% set low = forecast[0].templow | float %}
          {% set avg = (high + low) / 2 %}
          {{ [avg - 65, 0] | max | round(1) }}

      - name: "Pirate Weather HDD Forecast Tomorrow"
        unique_id: pirate_weather_hdd_forecast_tomorrow
        unit_of_measurement: "HDD"
        icon: mdi:snowflake
        availability: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {{ forecast | length > 1 and is_number(forecast[1].temperature) and is_number(forecast[1].templow) }}
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {% set high = forecast[1].temperature | float %}
          {% set low = forecast[1].templow | float %}
          {% set avg = (high + low) / 2 %}
          {{ [65 - avg, 0] | max | round(1) }}

      # 7-Day HDD Forecast Total
      - name: "Pirate Weather HDD Forecast 7 Day"
        unique_id: pirate_weather_hdd_forecast_7day
        unit_of_measurement: "HDD"
        icon: mdi:snowflake-thermometer
        availability: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {% if forecast | length < 7 %}
            false
          {% else %}
            {% set ns = namespace(ok=true) %}
            {% for day in forecast[:7] %}
              {% if not (is_number(day.temperature) and is_number(day.templow)) %}
                {% set ns.ok = false %}
              {% endif %}
            {% endfor %}
            {{ ns.ok }}
          {% endif %}
        state: >
          {% set data = pirate_weather_daily | default({}, true) %}
          {% set entity = data.get('weather.pirateweather', none) if data is mapping else none %}
          {% if entity is none and data is mapping and (data | count > 0) %}
            {% set entity = data.values() | list | first %}
          {% endif %}
          {% set forecast = entity.get('forecast', []) if entity is mapping else (entity.forecast | default([], true) if entity is not none else []) %}
          {% set ns = namespace(total=0) %}
          {% for day in forecast[:7] %}
            {% set high = day.temperature | float %}
            {% set low = day.templow | float %}
            {% set avg = (high + low) / 2 %}
            {% set ns.total = ns.total + [65 - avg, 0] | max %}
          {% endfor %}
          {{ ns.total | round(1) }}

# ===============================================================
# PLATFORM SENSORS
# ===============================================================
sensor:
  - platform: time_date
    display_options:
      - "time"
      - "date"

  - platform: statistics
    name: "HVAC Outdoor Temp Mean 24h"
    unique_id: hvac_outdoor_temp_mean_24h
    entity_id: sensor.hvac_outdoor_temp_hartford_proxy
    state_characteristic: mean
    max_age:
      hours: 24

  - platform: history_stats
    name: "HVAC 2F Heat Cycles Today"
    unique_id: hvac_2f_heat_cycles_today
    entity_id: binary_sensor.hvac_2f_call_for_heat
    state: "on"
    type: count
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 2F Heat Runtime Today"
    unique_id: hvac_2f_heat_runtime_today
    entity_id: binary_sensor.hvac_2f_call_for_heat
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 1F Heat Cycles Today"
    unique_id: hvac_1f_heat_cycles_today
    entity_id: binary_sensor.hvac_1f_call_for_heat
    state: "on"
    type: count
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 1F Heat Runtime Today"
    unique_id: hvac_1f_heat_runtime_today
    entity_id: binary_sensor.hvac_1f_call_for_heat
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 2F Heat Runtime Week"
    unique_id: hvac_2f_heat_runtime_week
    entity_id: binary_sensor.hvac_2f_call_for_heat
    state: "on"
    type: time
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 1F Heat Runtime Week"
    unique_id: hvac_1f_heat_runtime_week
    entity_id: binary_sensor.hvac_1f_call_for_heat
    state: "on"
    type: time
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 1F Heat Cycles Week"
    unique_id: hvac_1f_heat_cycles_week
    entity_id: binary_sensor.hvac_1f_call_for_heat
    state: "on"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC 2F Heat Cycles Week"
    unique_id: hvac_2f_heat_cycles_week
    entity_id: binary_sensor.hvac_2f_call_for_heat
    state: "on"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"

  # NOTE: Month zone runtime/cycles sensors removed - now use accumulated template sensors
  # (immune to recorder purge_keep_days=14, see template sensor section)

  # === ACTUAL FURNACE CYCLES (captures overlapping thermostat calls) ===
  - platform: history_stats
    name: "HVAC Furnace Cycles Today"
    unique_id: hvac_furnace_cycles_today
    entity_id: binary_sensor.hvac_furnace_running
    state: "on"
    type: count
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC Furnace Runtime Today"
    unique_id: hvac_furnace_runtime_today
    entity_id: binary_sensor.hvac_furnace_running
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC Furnace Runtime Week"
    unique_id: hvac_furnace_runtime_week
    entity_id: binary_sensor.hvac_furnace_running
    state: "on"
    type: time
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "HVAC Furnace Cycles Week"
    unique_id: hvac_furnace_cycles_week
    entity_id: binary_sensor.hvac_furnace_running
    state: "on"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"

  # NOTE: Month furnace runtime/cycles sensors removed - now use accumulated template sensors
  # (immune to recorder purge_keep_days=14, see template sensor section)

  # === DEHUMIDIFIER RUNTIME ===
  - platform: history_stats
    name: "Dehumidifier Runtime Today"
    unique_id: dehumidifier_runtime_today
    entity_id: switch.dehumidifier
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Dehumidifier Runtime Week"
    unique_id: dehumidifier_runtime_week
    entity_id: switch.dehumidifier
    state: "on"
    type: time
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"

# ===============================================================
# CLIMATE NORMS - Daily lookup from historical climate data
# ===============================================================
# Reads climate_daily_norms.csv (18 years of data) to provide
# expected HDD/CDD values for today based on historical averages.
# Updates once daily at startup and midnight.
# ===============================================================

command_line:
  - sensor:
      name: "Climate Norms Today"
      unique_id: climate_norms_today
      command: "python3 /config/scripts/climate_norms_today.py"
      command_timeout: 30
      scan_interval: 3600  # Hourly update to ensure day rollover is captured
      value_template: "{{ value_json.status }}"
      json_attributes:
        - day_of_year
        - month
        - day
        - hdd_mean
        - hdd_min
        - hdd_max
        - hdd_p10
        - hdd_p90
        - hdd_mean_smoothed
        - cdd_mean
        - cdd_p10
        - cdd_p90
        - tmean
        - tmin
        - tmax
        - samples
